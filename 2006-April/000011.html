<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [solid-pbx-svn] r13 - in trunk: . apps build_tools channels channels/misdn include/asterisk mxml pbx pbx/ael res res/snmp utils
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/solid-pbx-svn/2006-April/index.html" >
   <LINK REL="made" HREF="mailto:solid-pbx-svn%40lists.berlios.de?Subject=Re%3A%20%5Bsolid-pbx-svn%5D%20r13%20-%20in%20trunk%3A%20.%20apps%20build_tools%20channels%20channels/misdn%20include/asterisk%20mxml%20pbx%20pbx/ael%20res%20res/snmp%20utils&In-Reply-To=%3C200604301453.k3UErScD027688%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000009.html">
   <LINK REL="Next"  HREF="000010.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[solid-pbx-svn] r13 - in trunk: . apps build_tools channels channels/misdn include/asterisk mxml pbx pbx/ael res res/snmp utils</H1>
    <B>solid-pbx-svn-admin at lists.berlios.de</B> 
    <A HREF="mailto:solid-pbx-svn%40lists.berlios.de?Subject=Re%3A%20%5Bsolid-pbx-svn%5D%20r13%20-%20in%20trunk%3A%20.%20apps%20build_tools%20channels%20channels/misdn%20include/asterisk%20mxml%20pbx%20pbx/ael%20res%20res/snmp%20utils&In-Reply-To=%3C200604301453.k3UErScD027688%40sheep.berlios.de%3E"
       TITLE="[solid-pbx-svn] r13 - in trunk: . apps build_tools channels channels/misdn include/asterisk mxml pbx pbx/ael res res/snmp utils">solid-pbx-svn-admin at lists.berlios.de
       </A><BR>
    <I>Sun Apr 30 16:53:28 CEST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="000009.html">[solid-pbx-svn] r12 - in trunk: . res
</A></li>
        <LI>Next message: <A HREF="000010.html">[solid-pbx-svn] r14 - trunk/mxml
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11">[ date ]</a>
              <a href="thread.html#11">[ thread ]</a>
              <a href="subject.html#11">[ subject ]</a>
              <a href="author.html#11">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: casper2
Date: 2006-04-30 16:53:08 +0200 (Sun, 30 Apr 2006)
New Revision: 13

Modified:
   trunk/Makefile
   trunk/acinclude.m4
   trunk/app.c
   trunk/apps/Makefile
   trunk/asterisk.c
   trunk/build_tools/cflags.xml
   trunk/channel.c
   trunk/channels/chan_misdn.c
   trunk/channels/misdn/isdn_lib.c
   trunk/channels/misdn/isdn_lib_intern.h
   trunk/cli.c
   trunk/devicestate.c
   trunk/include/asterisk/frame.h
   trunk/manager.c
   trunk/mxml/.cvsignore
   trunk/mxml/Makefile.in
   trunk/pbx.c
   trunk/pbx/ael/ael.flex
   trunk/pbx/ael/ael.tab.c
   trunk/pbx/ael/ael.y
   trunk/pbx/ael/ael_lex.c
   trunk/pbx/pbx_dundi.c
   trunk/res/res_agi.c
   trunk/res/res_features.c
   trunk/res/res_monitor.c
   trunk/res/snmp/agent.c
   trunk/udptl.c
   trunk/utils/Makefile
Log:
Update to Asterisk SVN trunk r23556
------------------------------------------------------------------------
r23354 | kpfleming | 2006-04-29 16:48:32 +0200 (Sat, 29 Apr 2006) | 2 lines

fix up dependencies for aelparse so that bison/flex will not be run to rebuild source files (that should _only_ be done manually)

------------------------------------------------------------------------
r23355 | russell | 2006-04-29 16:50:18 +0200 (Sat, 29 Apr 2006) | 2 lines

a bunch of conversion to ast_channel_*lock (issue #7058)

------------------------------------------------------------------------
r23376 | russell | 2006-04-29 17:07:16 +0200 (Sat, 29 Apr 2006) | 2 lines

add aelparse to svn:ignore

------------------------------------------------------------------------
r23378 | kpfleming | 2006-04-29 17:15:21 +0200 (Sat, 29 Apr 2006) | 2 lines

add the other two files that should have been on this target... oops

------------------------------------------------------------------------
r23380 | kpfleming | 2006-04-29 17:31:45 +0200 (Sat, 29 Apr 2006) | 3 lines

and now with the correct filenames
add basic support for checking for C compiler attribute support

------------------------------------------------------------------------
r23381 | russell | 2006-04-29 17:34:33 +0200 (Sat, 29 Apr 2006) | 3 lines

- the configure script should never be regenerated for mxml
- also remove an unneeded .cvsignore

------------------------------------------------------------------------
r23382 | russell | 2006-04-29 17:44:02 +0200 (Sat, 29 Apr 2006) | 2 lines

oops, i modified the Makefile isntead of Makefile.in

------------------------------------------------------------------------
r23402 | rizzo | 2006-04-29 20:22:08 +0200 (Sat, 29 Apr 2006) | 2 lines

remove now useless rule for app_rpt (bug 7059)

------------------------------------------------------------------------
r23422 | russell | 2006-04-29 21:26:53 +0200 (Sat, 29 Apr 2006) | 6 lines

revert the last change to this Makefile which removed the rules to build
app_apt.  These rules *are* needed beacause this module uses libtonezone,
so it needs this information from autoconf in case it is located in a
non-standard location.  Also, without it, app_rpt.so would not be linked
with libtonezone at all.

------------------------------------------------------------------------
r23443 | crichter | 2006-04-30 00:56:00 +0200 (Sun, 30 Apr 2006) | 1 line

added an up-queue message mechanism to avoid buffer fillups in the kernel, also changed some strdups to ast_strdupa
------------------------------------------------------------------------
r23463 | russell | 2006-04-30 06:20:20 +0200 (Sun, 30 Apr 2006) | 4 lines

- convert some comments to doxygen format
- convert the list of dundi peers to use the list macros
- convert a use of malloc+memset to use ast_calloc

------------------------------------------------------------------------
r23464 | russell | 2006-04-30 06:23:09 +0200 (Sun, 30 Apr 2006) | 3 lines

immediately handle a memory allocation failure so the rest of the function
doesn't have to be indented (indentation still to be fixed)

------------------------------------------------------------------------
r23465 | russell | 2006-04-30 06:26:11 +0200 (Sun, 30 Apr 2006) | 2 lines

fix the indentation of a large block of code

------------------------------------------------------------------------
r23466 | russell | 2006-04-30 06:28:47 +0200 (Sun, 30 Apr 2006) | 2 lines

change a list traversal to use a for loop

------------------------------------------------------------------------
r23467 | russell | 2006-04-30 06:34:04 +0200 (Sun, 30 Apr 2006) | 2 lines

use the INSTALL variable instead of &quot;install&quot; directly

------------------------------------------------------------------------
r23468 | russell | 2006-04-30 06:59:36 +0200 (Sun, 30 Apr 2006) | 3 lines

- convert the list of dundi mappings to use the list macros
- change an instance of malloc+memset to use ast_calloc, instead

------------------------------------------------------------------------
r23480 | russell | 2006-04-30 07:02:07 +0200 (Sun, 30 Apr 2006) | 3 lines

handle a memory allocation failure immediately so the following large block
does not have to be indented

------------------------------------------------------------------------
r23489 | russell | 2006-04-30 07:06:14 +0200 (Sun, 30 Apr 2006) | 2 lines

fix the indentation of a large block

------------------------------------------------------------------------
r23490 | russell | 2006-04-30 07:07:52 +0200 (Sun, 30 Apr 2006) | 3 lines

immediately handle ast_strdupa result so that one more level of indentation
can be removed from this function

------------------------------------------------------------------------
r23491 | russell | 2006-04-30 07:09:34 +0200 (Sun, 30 Apr 2006) | 2 lines

fix indentation for this function

------------------------------------------------------------------------
r23492 | russell | 2006-04-30 07:15:53 +0200 (Sun, 30 Apr 2006) | 2 lines

convert existing comments to doxygen format

------------------------------------------------------------------------
r23493 | russell | 2006-04-30 07:24:10 +0200 (Sun, 30 Apr 2006) | 2 lines

convert the dundi_request list to use the list macros

------------------------------------------------------------------------
r23494 | russell | 2006-04-30 07:27:57 +0200 (Sun, 30 Apr 2006) | 2 lines

remove unneeded define - it is already in asterisk.h

------------------------------------------------------------------------
r23514 | kpfleming | 2006-04-30 08:50:53 +0200 (Sun, 30 Apr 2006) | 2 lines

remove attribute checking... it was an attempt to support older GCC compilers but is not worth the effort :-)

------------------------------------------------------------------------
r23534 | rizzo | 2006-04-30 10:21:46 +0200 (Sun, 30 Apr 2006) | 5 lines

more simplifications in the bison sources,
more annotation with XXX of dubious code.
(The code still passes tests)


------------------------------------------------------------------------
r23535 | rizzo | 2006-04-30 10:35:49 +0200 (Sun, 30 Apr 2006) | 10 lines

when compiling ast_expr2 from utils/ the current directory
is utils/ so the compiler fails to find the header which is in ../
(at least on FreeBSD; this works on linux but it may be due to
differences in gmake).
For the time being, fix it by adding -I.. to the includes.
However i think a proper fix is to make sure that ast_expr2
is built using the rules in the top-level makefile instead
of those in the subdirectory.


------------------------------------------------------------------------
r23536 | kpfleming | 2006-04-30 10:47:47 +0200 (Sun, 30 Apr 2006) | 2 lines

remove T38_SUPPORT define that is no longer needed

------------------------------------------------------------------------
r23550 | rizzo | 2006-04-30 11:06:28 +0200 (Sun, 30 Apr 2006) | 3 lines

comment some code


------------------------------------------------------------------------


Modified: trunk/Makefile
===================================================================
--- trunk/Makefile	2006-04-29 14:18:03 UTC (rev 12)
+++ trunk/Makefile	2006-04-30 14:53:08 UTC (rev 13)
@@ -252,7 +252,7 @@
   ID=/usr/xpg4/bin/id
 endif
 
-INCLUDE+=-Iinclude -I../include
+INCLUDE+=-Iinclude -I../include -I..
 ASTCFLAGS+=-pipe  -Wall -Wstrict-prototypes -Wmissing-prototypes -Wmissing-declarations $(DEBUG) $(INCLUDE) #-DMAKE_VALGRIND_HAPPY
 ASTCFLAGS+=$(OPTIMIZE)
 
@@ -580,7 +580,7 @@
 # improved a lot.  I'll put it here for now.
 	mkdir -p $(DESTDIR)$(ASTDATADIR)/static-http
 	for x in static-http/*; do \
-		install -m 644 $$x $(DESTDIR)$(ASTDATADIR)/static-http ; \
+		$(INSTALL) -m 644 $$x $(DESTDIR)$(ASTDATADIR)/static-http ; \
 	done
 	mkdir -p $(DESTDIR)$(ASTDATADIR)/sounds/digits
 	mkdir -p $(DESTDIR)$(ASTDATADIR)/sounds/priv-callerintros

Modified: trunk/acinclude.m4
===================================================================
--- trunk/acinclude.m4	2006-04-29 14:18:03 UTC (rev 12)
+++ trunk/acinclude.m4	2006-04-30 14:53:08 UTC (rev 13)
@@ -68,7 +68,7 @@
 
 
 AC_DEFUN(
-[AST_CHECK_GNU_MAKE], [ AC_CACHE_CHECK( for GNU make, GNU_MAKE,
+[AST_CHECK_GNU_MAKE], [AC_CACHE_CHECK(for GNU make, GNU_MAKE,
    GNU_MAKE='Not Found' ;
    for a in make gmake gnumake ; do
       if test -z &quot;$a&quot; ; then continue ; fi ;
@@ -83,4 +83,4 @@
    exit 1
 fi
 AC_SUBST([GNU_MAKE])
-] )
+])

Modified: trunk/app.c
===================================================================
--- trunk/app.c	2006-04-29 14:18:03 UTC (rev 12)
+++ trunk/app.c	2006-04-30 14:53:08 UTC (rev 13)
@@ -1042,7 +1042,7 @@
  		test = pbx_builtin_getvar_helper(chan, cat);
 		if (test &amp;&amp; !strcasecmp(test, group))
  			count++;
-		ast_mutex_unlock(&amp;chan-&gt;lock);
+		ast_channel_unlock(chan);
 	}
 
 	return count;
@@ -1072,7 +1072,7 @@
 		test = pbx_builtin_getvar_helper(chan, cat);
 		if (test &amp;&amp; !regexec(&amp;regexbuf, test, 0, NULL, 0))
 			count++;
-		ast_mutex_unlock(&amp;chan-&gt;lock);
+		ast_channel_unlock(chan);
 	}
 
 	regfree(&amp;regexbuf);

Modified: trunk/apps/Makefile
===================================================================
--- trunk/apps/Makefile	2006-04-29 14:18:03 UTC (rev 12)
+++ trunk/apps/Makefile	2006-04-30 14:53:08 UTC (rev 13)
@@ -41,7 +41,7 @@
 	$(CC) $(SOLINK) -o $@ $&lt; $(ZAPTEL_LIB)
 
 app_rpt.o: app_rpt.c
-	$(CC) $(SOLINK) -o $@ $&lt; $(ZAPTEL_INCLUDE) 
+	$(CC) $(SOLINK) -o $@ $&lt; $(ZAPTEL_INCLUDE)
 
 install: all
 	for x in $(MODS); do $(INSTALL) -m 755 $$x $(DESTDIR)$(MODULES_DIR) ; done

Modified: trunk/asterisk.c
===================================================================
--- trunk/asterisk.c	2006-04-29 14:18:03 UTC (rev 12)
+++ trunk/asterisk.c	2006-04-30 14:53:08 UTC (rev 13)
@@ -111,9 +111,7 @@
 #include &quot;asterisk/enum.h&quot;
 #include &quot;asterisk/rtp.h&quot;
 #include &quot;asterisk/http.h&quot;
-#if defined(T38_SUPPORT)
 #include &quot;asterisk/udptl.h&quot;
-#endif
 #include &quot;asterisk/app.h&quot;
 #include &quot;asterisk/lock.h&quot;
 #include &quot;asterisk/utils.h&quot;
@@ -2582,9 +2580,7 @@
 		exit(1);
 	}
 	ast_rtp_init();
-#if defined(T38_SUPPORT)
 	ast_udptl_init();
-#endif
 	if (ast_image_init()) {
 		printf(term_quit());
 		exit(1);

Modified: trunk/build_tools/cflags.xml
===================================================================
--- trunk/build_tools/cflags.xml	2006-04-29 14:18:03 UTC (rev 12)
+++ trunk/build_tools/cflags.xml	2006-04-30 14:53:08 UTC (rev 13)
@@ -17,7 +17,4 @@
 		&lt;/member&gt;
 		&lt;member name=&quot;-DMTX_PROFILE&quot;&gt;
 		&lt;/member&gt;
-		&lt;member name=&quot;-DT38_SUPPORT&quot;&gt;
-			&lt;defaultenabled&gt;yes&lt;/defaultenabled&gt;
-		&lt;/member&gt;
 	&lt;/category&gt;

Modified: trunk/channel.c
===================================================================
--- trunk/channel.c	2006-04-29 14:18:03 UTC (rev 12)
+++ trunk/channel.c	2006-04-30 14:53:08 UTC (rev 13)
@@ -3330,9 +3330,7 @@
 		    (f-&gt;frametype == AST_FRAME_VIDEO) ||
 		    (f-&gt;frametype == AST_FRAME_IMAGE) ||
 		    (f-&gt;frametype == AST_FRAME_HTML) ||
-#if defined(T38_SUPPORT)
 		    (f-&gt;frametype == AST_FRAME_MODEM) ||
-#endif
 		    (f-&gt;frametype == AST_FRAME_TEXT)) {
 			/* monitored dtmf causes exit from bridge */
 			int monitored_source = (who == c0) ? watch_c0_dtmf : watch_c1_dtmf;

Modified: trunk/channels/chan_misdn.c
===================================================================
--- trunk/channels/chan_misdn.c	2006-04-29 14:18:03 UTC (rev 12)
+++ trunk/channels/chan_misdn.c	2006-04-30 14:53:08 UTC (rev 13)
@@ -183,6 +183,9 @@
 
 	char context[BUFFERSIZE];
 
+	int zero_read_cnt;
+	int dropped_frame_cnt;
+
 	const struct tone_zone_sound *ts;
 	
 	struct chan_list *peer;
@@ -749,7 +752,7 @@
 static int misdn_show_stacks (int fd, int argc, char *argv[])
 {
 	int port;
-	
+
 	ast_cli(fd, &quot;BEGIN STACK_LIST:\n&quot;);
 
 	for (port=misdn_cfg_get_next_port(0); port &gt; 0;
@@ -927,7 +930,7 @@
 		c = ast_channel_walk_locked(c);
 	}
 	if (c) {
-		ret = strdup(c-&gt;name);
+		ret = ast_strdupa(c-&gt;name);
 		ast_mutex_unlock(&amp;c-&gt;lock);
 	} else
 		ret = NULL;
@@ -946,12 +949,12 @@
 
 	switch (pos) {
 	case 4: if (*word == 'p')
-				return strdup(&quot;port&quot;);
+				return ast_strdupa(&quot;port&quot;);
 			else if (*word == 'o')
-				return strdup(&quot;only&quot;);
+				return ast_strdupa(&quot;only&quot;);
 			break;
 	case 6: if (*word == 'o')
-				return strdup(&quot;only&quot;);
+				return ast_strdupa(&quot;only&quot;);
 			break;
 	}
 	return NULL;
@@ -1504,17 +1507,13 @@
 		if ( strcmp(bc-&gt;dad,ast-&gt;exten)) {
 			ast_copy_string(ast-&gt;exten, bc-&gt;dad, sizeof(ast-&gt;exten));
 		}
-		if ( ast-&gt;cid.cid_num &amp;&amp; strcmp(ast-&gt;cid.cid_num, bc-&gt;oad)) {
-			free(ast-&gt;cid.cid_num);
-			ast-&gt;cid.cid_num=NULL;
-			
-		}
+		
 		if ( !ast-&gt;cid.cid_num) {
-			ast-&gt;cid.cid_num=strdup(bc-&gt;oad);
+			ast_set_callerid(ast, bc-&gt;oad, NULL, bc-&gt;oad);
 		}
 		
 		if ( !ast_strlen_zero(bc-&gt;rad) ) 
-			ast-&gt;cid.cid_rdnis=strdup(bc-&gt;rad);
+			ast-&gt;cid.cid_rdnis=ast_strdupa(bc-&gt;rad);
 	}
 	return 0;
 }
@@ -2062,10 +2061,20 @@
 	len = misdn_ibuf_usedcount(tmp-&gt;bc-&gt;astbuf);
 
 	if (!len) {
-		chan_misdn_log(4,tmp-&gt;bc-&gt;port,&quot;misdn_read: ZERO READ\n&quot;);
+		struct ast_frame *frame;
+		if(!tmp-&gt;zero_read_cnt)
+			chan_misdn_log(4,tmp-&gt;bc-&gt;port,&quot;misdn_read: ZERO READ\n&quot;);
+		tmp-&gt;zero_read_cnt++;
+
+		if (tmp-&gt;zero_read_cnt &gt; 5000) {
+			chan_misdn_log(4,tmp-&gt;bc-&gt;port,&quot;misdn_read: ZERO READ counted &gt; 5000 times\n&quot;);
+			tmp-&gt;zero_read_cnt=0;
+
+		}
 		tmp-&gt;frame.frametype = AST_FRAME_NULL;
 		tmp-&gt;frame.subclass = 0;
-		return &amp;tmp-&gt;frame;
+		frame=ast_frisolate(&amp;tmp-&gt;frame);
+		return frame;
 	}
 
 	/*shrinken len if necessary, we transmit at maximum 4k*/
@@ -2154,7 +2163,16 @@
 		case BCHAN_BRIDGED:
 			break;
 		default:
-		chan_misdn_log(5, ch-&gt;bc-&gt;port, &quot;BC not active (nor bridged) droping: %d frames addr:%x exten:%s cid:%s ch-&gt;state:%s\n&quot;,frame-&gt;samples,ch-&gt;bc-&gt;addr, ast-&gt;exten, ast-&gt;cid.cid_num,misdn_get_ch_state( ch));
+		if (!ch-&gt;dropped_frame_cnt)
+			chan_misdn_log(5, ch-&gt;bc-&gt;port, &quot;BC not active (nor bridged) droping: %d frames addr:%x exten:%s cid:%s ch-&gt;state:%s bc_state:%d\n&quot;,frame-&gt;samples,ch-&gt;bc-&gt;addr, ast-&gt;exten, ast-&gt;cid.cid_num,misdn_get_ch_state( ch), ch-&gt;bc-&gt;bc_state);
+		
+		ch-&gt;dropped_frame_cnt++;
+		if (ch-&gt;dropped_frame_cnt &gt; 100) {
+			ch-&gt;dropped_frame_cnt=0;
+			chan_misdn_log(5, ch-&gt;bc-&gt;port, &quot;BC not active (nor bridged) droping: %d frames addr:%x  dropped &gt; 100 frames!\n&quot;,frame-&gt;samples,ch-&gt;bc-&gt;addr);
+
+		}
+
 		return 0;
 	}
 	
@@ -2264,10 +2282,6 @@
     
 	}
   
-	if (bridging) {
-		misdn_lib_split_bridge(ch1-&gt;bc,ch2-&gt;bc);
-	}
-  
 	return 0;
 }
 
@@ -2612,10 +2626,9 @@
 			char *cid_name, *cid_num;
       
 			ast_callerid_parse(callerid, &amp;cid_name, &amp;cid_num);
-			if (cid_name)
-				tmp-&gt;cid.cid_name=strdup(cid_name);
-			if (cid_num)
-				tmp-&gt;cid.cid_num=strdup(cid_num);
+			ast_set_callerid(tmp, cid_num,cid_name,cid_num);
+		} else {
+			ast_set_callerid(tmp, NULL,NULL,NULL);
 		}
 
 		{

Modified: trunk/channels/misdn/isdn_lib.c
===================================================================
--- trunk/channels/misdn/isdn_lib.c	2006-04-29 14:18:03 UTC (rev 12)
+++ trunk/channels/misdn/isdn_lib.c	2006-04-30 14:53:08 UTC (rev 13)
@@ -802,6 +802,8 @@
 		free_chan = find_free_chan_in_stack(stack, bc-&gt;channel_preselected?bc-&gt;channel:0);
 		if (!free_chan) return -1;
 		bc-&gt;channel=free_chan;
+		
+		cb_log(0,stack-&gt;port, &quot; --&gt;  found channel: %d\n&quot;,free_chan);
     
 		for (i=0; i &lt;= MAXPROCS; i++)
 			if (stack-&gt;procids[i]==0) break;
@@ -833,6 +835,7 @@
 			free_chan = find_free_chan_in_stack(stack, bc-&gt;channel_preselected?bc-&gt;channel:0);
 			if (!free_chan) return -1;
 			bc-&gt;channel=free_chan;
+			cb_log(0,stack-&gt;port, &quot; --&gt;  found channel: %d\n&quot;,free_chan);
 		} else {
 			/* other phones could have made a call also on this port (ptmp) */
 			bc-&gt;channel=0xff;
@@ -1107,6 +1110,7 @@
 	stack-&gt;pri=0;
   
 	msg_queue_init(&amp;stack-&gt;downqueue);
+	msg_queue_init(&amp;stack-&gt;upqueue);
   
 	/* query port's requirements */
 	ret = mISDN_get_stack_info(midev, port, buff, sizeof(buff));
@@ -2072,11 +2076,18 @@
 		
 	case MGR_SETSTACK| INDICATION:
 		cb_log(2, stack-&gt;port, &quot;BCHAN: MGR_SETSTACK|IND \n&quot;);
-		
+
+	AGAIN:
 		bc-&gt;addr = mISDN_get_layerid(stack-&gt;midev, bc-&gt;b_stid, bc-&gt;layer);
 		if (!bc-&gt;addr) {
+
+			if (errno == EAGAIN) {
+				usleep(1000);
+				goto AGAIN;
+			}
+			
 			cb_log(0,stack-&gt;port,&quot;$$$ Get Layer (%d) Id Error: %s\n&quot;,bc-&gt;layer,strerror(errno));
-
+			
 			/* we kill the channel later, when we received some
 			   data. */
 			bc-&gt;addr= frm-&gt;addr;
@@ -2587,10 +2598,12 @@
 	FD_SET(midev,&amp;rdfs);
   
 	mISDN_select(FD_SETSIZE, &amp;rdfs, NULL, NULL, NULL);
+	//select(FD_SETSIZE, &amp;rdfs, NULL, NULL, NULL);
   
 	if (FD_ISSET(midev, &amp;rdfs)) {
-    
-		r=mISDN_read(midev,msg-&gt;data,MAX_MSG_SIZE,0);
+
+	AGAIN:
+		r=mISDN_read(midev,msg-&gt;data,MAX_MSG_SIZE, 5000);
 		msg-&gt;len=r;
     
 		if (r==0) {
@@ -2599,6 +2612,17 @@
 			return NULL;
 		}
 
+		if (r&lt;0) {
+			if (errno == EAGAIN) {
+				/*we wait for mISDN here*/
+				cb_log(-1,0,&quot;mISDN_read wants us to wait\n&quot;);
+				usleep(5000);
+				goto AGAIN;
+			}
+			
+			cb_log(-1,0,&quot;mISDN_read returned :%d error:%s (%d)\n&quot;,r,strerror(errno),errno); 
+		}
+
 		return msg;
 	} else {
 		printf (&quot;Select timeout\n&quot;);
@@ -2976,6 +3000,22 @@
 int handle_err(msg_t *msg)
 {
 	iframe_t *frm = (iframe_t*) msg-&gt;data;
+
+
+	if (!frm-&gt;addr) {
+		static int cnt=0;
+		if (!cnt)
+			cb_log(0,0,&quot;mISDN Msg without Address pr:%x dinfo:%x\n&quot;,frm-&gt;prim,frm-&gt;dinfo);
+		cnt++;
+		if (cnt&gt;100) {
+			cb_log(0,0,&quot;mISDN Msg without Address pr:%x dinfo:%x (already more than 100 of them)\n&quot;,frm-&gt;prim,frm-&gt;dinfo);
+			cnt=0;
+		}
+		
+		free_msg(msg);
+		return 1;
+		
+	}
 	
 	switch (frm-&gt;prim) {
 		case DL_DATA|INDICATION:
@@ -2983,8 +3023,14 @@
 			int port=(frm-&gt;addr&amp;MASTER_ID_MASK) &gt;&gt; 8;
 			int channel=(frm-&gt;addr&amp;CHILD_ID_MASK) &gt;&gt; 16;
 
-			cb_log(3,0,&quot;BCHAN DATA without BC: addr:%x port:%d channel:%d\n&quot;,frm-&gt;addr, port,channel);
+			/*we flush the read buffer here*/
 			
+			cb_log(9,0,&quot;BCHAN DATA without BC: addr:%x port:%d channel:%d\n&quot;,frm-&gt;addr, port,channel);
+			
+			free_msg(msg) ; 
+			return 1;
+			
+			
 			struct misdn_bchannel *bc=find_bc_by_channel( port , channel);
 
 			if (!bc) {
@@ -3015,11 +3061,28 @@
 }
 
 
+int queue_l2l3(msg_t *msg) {
+	iframe_t *frm= (iframe_t*)msg-&gt;data;
+	struct misdn_stack *stack;
+	int err=0;
+
+	stack=find_stack_by_addr( frm-&gt;addr );
+
+	
+	if (!stack) {
+		return 0;
+	}
+
+	msg_queue_tail(&amp;stack-&gt;upqueue, msg);
+	sem_post(&amp;glob_mgr-&gt;new_msg);
+	return 1;
+}
+
 int manager_isdn_handler(iframe_t *frm ,msg_t *msg)
 {  
 
 	if (frm-&gt;dinfo==(signed long)0xffffffff &amp;&amp; frm-&gt;prim==(PH_DATA|CONFIRM)) {
-		printf(&quot;SERIOUS BUG, dinfo == 0xffffffff, prim == PH_DATA | CONFIRM !!!!\n&quot;);
+		cb_log(0,0,&quot;SERIOUS BUG, dinfo == 0xffffffff, prim == PH_DATA | CONFIRM !!!!\n&quot;);
 	}
 
 	if ( ((frm-&gt;addr | ISDN_PID_BCHANNEL_BIT )&gt;&gt; 28 ) == 0x5) {
@@ -3039,21 +3102,17 @@
 	/* Its important to handle l1 AFTER l2  */
 	if (handle_l1(msg)) 
 		return 0 ;
-	
-	
-	/** Handle L2/3 Signalling after bchans **/ 
-	if (handle_frm_nt(msg)) 
-		return 0 ;
-	
-	if (handle_frm(msg)) 
-		return 0 ;
 
+	/* The L2/L3 will be queued */
+	if (queue_l2l3(msg))
+		return 0;
+
 	if (handle_err(msg)) 
 		return 0 ;
-	
+
 	cb_log(-1, 0, &quot;Unhandled Message: prim %x len %d from addr %x, dinfo %x on this port.\n&quot;,frm-&gt;prim, frm-&gt;len, frm-&gt;addr, frm-&gt;dinfo);		
-   
 	free_msg(msg);
+	
 
 	return 0;
 }
@@ -3200,6 +3259,24 @@
 		for (stack=glob_mgr-&gt;stack_list;
 		     stack;
 		     stack=stack-&gt;next ) { 
+
+			while ( (msg=msg_dequeue(&amp;stack-&gt;upqueue)) ) {
+				int res=0;
+				/** Handle L2/3 Signalling after bchans **/ 
+				if (!handle_frm_nt(msg)) {
+					/* Maybe it's TE */
+					if (!handle_frm(msg)) {
+						/* wow none! */
+						cb_log(-1,stack-&gt;port,&quot;Wow we've got a strange issue while dequeueing a Frame\n&quot;);
+					}
+				}
+			}
+
+			/* Here we should check if we really want to 
+				send all the messages we've queued, lets 
+				assume we've queued a Disconnect, but 
+				received it already from the other side!*/
+		     
 			while ( (msg=msg_dequeue(&amp;stack-&gt;downqueue)) ) {
 				if (stack-&gt;nt ) {
 					if (stack-&gt;nst.manager_l3(&amp;stack-&gt;nst, msg))
@@ -3208,6 +3285,7 @@
 				} else {
 					iframe_t *frm = (iframe_t *)msg-&gt;data;
 					struct misdn_bchannel *bc = find_bc_by_l3id(stack, frm-&gt;dinfo);
+					cb_log(0,stack-&gt;port,&quot;Sending msg, prim:%x addr:%x dinfo:%x\n&quot;,frm-&gt;prim,frm-&gt;addr,frm-&gt;dinfo);
 					if (bc) send_msg(glob_mgr-&gt;midev, bc, msg);
 				}
 			}

Modified: trunk/channels/misdn/isdn_lib_intern.h
===================================================================
--- trunk/channels/misdn/isdn_lib_intern.h	2006-04-29 14:18:03 UTC (rev 12)
+++ trunk/channels/misdn/isdn_lib_intern.h	2006-04-30 14:53:08 UTC (rev 13)
@@ -74,6 +74,7 @@
 	int procids[0x100+1];
 
 	msg_queue_t downqueue;
+	msg_queue_t upqueue;
 	int busy;
   
 	int port;

Modified: trunk/cli.c
===================================================================
--- trunk/cli.c	2006-04-29 14:18:03 UTC (rev 12)
+++ trunk/cli.c	2006-04-30 14:53:08 UTC (rev 13)
@@ -444,7 +444,7 @@
 			ast_cli(fd, FORMAT_STRING, c-&gt;name, locbuf, ast_state2str(c-&gt;_state), appdata);
 		}
 		numchans++;
-		ast_mutex_unlock(&amp;c-&gt;lock);
+		ast_channel_unlock(c);
 	}
 	if (!concise) {
 		ast_cli(fd, &quot;%d active channel%s\n&quot;, numchans, ESS(numchans));
@@ -505,7 +505,7 @@
 	if (c) {
 		ast_cli(fd, &quot;Requested Hangup on channel '%s'\n&quot;, c-&gt;name);
 		ast_softhangup(c, AST_SOFTHANGUP_EXPLICIT);
-		ast_mutex_unlock(&amp;c-&gt;lock);
+		ast_channel_unlock(c);
 	} else
 		ast_cli(fd, &quot;%s is not a known channel\n&quot;, argv[2]);
 	return RESULT_SUCCESS;
@@ -630,7 +630,7 @@
 			c-&gt;fout |= DEBUGCHAN_FLAG;
 			ast_cli(fd, &quot;Debugging enabled on channel %s\n&quot;, c-&gt;name);
 		}
-		ast_mutex_unlock(&amp;c-&gt;lock);
+		ast_channel_unlock(c);
 		if (!is_all)
 			break;
 		c = ast_channel_walk_locked(c);
@@ -662,7 +662,7 @@
 			c-&gt;fout &amp;= ~DEBUGCHAN_FLAG;
 			ast_cli(fd, &quot;Debugging disabled on channel %s\n&quot;, c-&gt;name);
 		}
-		ast_mutex_unlock(&amp;c-&gt;lock);
+		ast_channel_unlock(c);
 		if (!is_all)
 			break;
 		c = ast_channel_walk_locked(c);
@@ -747,7 +747,7 @@
 	if(c-&gt;cdr &amp;&amp; ast_cdr_serialize_variables(c-&gt;cdr,buf, sizeof(buf), '=', '\n', 1))
 		ast_cli(fd,&quot;  CDR Variables:\n%s\n&quot;,buf);
 	
-	ast_mutex_unlock(&amp;c-&gt;lock);
+	ast_channel_unlock(c);
 	return RESULT_SUCCESS;
 }
 
@@ -790,7 +790,7 @@
 	while (ret == &amp;notfound &amp;&amp; (c = ast_channel_walk_locked(c))) {
 		if (!strncasecmp(word, c-&gt;name, wordlen) &amp;&amp; ++which &gt; state)
 			ret = ast_strdup(c-&gt;name);
-		ast_mutex_unlock(&amp;c-&gt;lock);
+		ast_channel_unlock(c);
 	}
 	return ret == &amp;notfound ? NULL : ret;
 }
@@ -874,7 +874,7 @@
 			}
 		}
 		numchans++;
-		ast_mutex_unlock(&amp;c-&gt;lock);
+		ast_channel_unlock(c);
 	}
 
 	if (havepattern)

Modified: trunk/devicestate.c
===================================================================
--- trunk/devicestate.c	2006-04-29 14:18:03 UTC (rev 12)
+++ trunk/devicestate.c	2006-04-30 14:53:08 UTC (rev 13)
@@ -101,7 +101,7 @@
 	else
 		res = AST_DEVICE_INUSE;
 	
-	ast_mutex_unlock(&amp;chan-&gt;lock);
+	ast_channel_unlock(chan);
 
 	return res;
 }

Modified: trunk/include/asterisk/frame.h
===================================================================
--- trunk/include/asterisk/frame.h	2006-04-29 14:18:03 UTC (rev 12)
+++ trunk/include/asterisk/frame.h	2006-04-30 14:53:08 UTC (rev 13)
@@ -164,22 +164,18 @@
 /*! Comfort Noise frame (subclass is level of CNG in -dBov), 
     body may include zero or more 8-bit quantization coefficients */
 #define AST_FRAME_CNG		10
-#if defined(T38_SUPPORT)
 /*! Modem-over-IP data streams */
 #define AST_FRAME_MODEM		11
-#endif /* T38_SUPPORT */
 /*! DTMF begin event, subclass is the digit */
 #define AST_FRAME_DTMF_BEGIN	12
 /*! DTMF end event, subclass is the digit */
 #define AST_FRAME_DTMF_END	13
 
-#if defined(T38_SUPPORT)
 /* MODEM subclasses */
 /*! T.38 Fax-over-IP */
 #define AST_MODEM_T38		1
 /*! V.150 Modem-over-IP */
 #define AST_MODEM_V150		2
-#endif /* T38_SUPPORT */
 
 /* HTML subclasses */
 /*! Sending a URL */

Modified: trunk/manager.c
===================================================================
--- trunk/manager.c	2006-04-29 14:18:03 UTC (rev 12)
+++ trunk/manager.c	2006-04-30 14:53:08 UTC (rev 13)
@@ -1053,7 +1053,7 @@
 		return 0;
 	}
 	ast_softhangup(c, AST_SOFTHANGUP_EXPLICIT);
-	ast_mutex_unlock(&amp;c-&gt;lock);
+	ast_channel_unlock(c);
 	astman_send_ack(s, m, &quot;Channel Hungup&quot;);
 	return 0;
 }
@@ -1093,7 +1093,7 @@
 	pbx_builtin_setvar_helper(c, varname, varval);
 	  
 	if (c)
-		ast_mutex_unlock(&amp;c-&gt;lock);
+		ast_channel_unlock(c);
 
 	astman_send_ack(s, m, &quot;Variable Set&quot;);	
 
@@ -1136,7 +1136,7 @@
 	}
 
 	if (c)
-		ast_mutex_unlock(&amp;c-&gt;lock);
+		ast_channel_unlock(c);
 	astman_append(s, &quot;Response: Success\r\n&quot;
 		&quot;Variable: %s\r\nValue: %s\r\n&quot;, varname, varval);
 	if (!ast_strlen_zero(id))
@@ -1227,7 +1227,7 @@
 			c-&gt;accountcode,
 			ast_state2str(c-&gt;_state), bridge, c-&gt;uniqueid, idText);
 		}
-		ast_mutex_unlock(&amp;c-&gt;lock);
+		ast_channel_unlock(c);
 		if (!all)
 			break;
 		c = ast_channel_walk_locked(c);
@@ -1297,9 +1297,9 @@
 	} else
 		astman_send_error(s, m, &quot;Redirect failed&quot;);
 	if (chan)
-		ast_mutex_unlock(&amp;chan-&gt;lock);
+		ast_channel_unlock(chan);
 	if (chan2)
-		ast_mutex_unlock(&amp;chan2-&gt;lock);
+		ast_channel_unlock(chan2);
 	return 0;
 }
 
@@ -1363,7 +1363,7 @@
 
 	/* Locked by ast_pbx_outgoing_exten or ast_pbx_outgoing_app */
 	if (chan)
-		ast_mutex_unlock(&amp;chan-&gt;lock);
+		ast_channel_unlock(chan);
 	free(in);
 	return NULL;
 }
@@ -1626,7 +1626,7 @@
 		return 0;
 	}
 	ast_channel_setwhentohangup(c, timeout);
-	ast_mutex_unlock(&amp;c-&gt;lock);
+	ast_channel_unlock(c);
 	astman_send_ack(s, m, &quot;Timeout Set&quot;);
 	return 0;
 }

Modified: trunk/mxml/.cvsignore
===================================================================
--- trunk/mxml/.cvsignore	2006-04-29 14:18:03 UTC (rev 12)
+++ trunk/mxml/.cvsignore	2006-04-30 14:53:08 UTC (rev 13)
@@ -1,12 +0,0 @@
-*.bck
-*.bak
-Makefile
-autom4te*.cache
-config.cache
-config.h
-config.log
-config.status
-libmxml.a
-mxml.list
-mxmldoc
-testmxml

Modified: trunk/mxml/Makefile.in
===================================================================
--- trunk/mxml/Makefile.in	2006-04-29 14:18:03 UTC (rev 12)
+++ trunk/mxml/Makefile.in	2006-04-30 14:53:08 UTC (rev 13)
@@ -213,7 +213,7 @@
 # autoconf stuff...
 #
 
-Makefile:	configure Makefile.in
+Makefile:	Makefile.in
 	if test -f config.status; then \
 		./config.status --recheck; \
 		./config.status; \
@@ -223,17 +223,6 @@
 	touch config.h
 
 
-configure:	configure.in
-	autoconf
-	if test -f config.status; then \
-		./config.status --recheck; \
-		./config.status; \
-	else \
-		./configure; \
-	fi
-	touch config.h
-
-
 config.h:	configure config.h.in
 	autoconf
 	if test -f config.status; then \

Modified: trunk/pbx/ael/ael.flex
===================================================================
--- trunk/pbx/ael/ael.flex	2006-04-29 14:18:03 UTC (rev 12)
+++ trunk/pbx/ael/ael.flex	2006-04-30 14:53:08 UTC (rev 13)
@@ -493,7 +493,19 @@
 }
 
 
-/* used by the bison code */
+/*
+ * The following three functions, reset_*, are used in the bison
+ * code to switch context. As a consequence, we need to
+ * declare them global and add a prototype so that the
+ * compiler does not complain.
+ *
+ * NOTE: yyg is declared because it is used in the BEGIN macros,
+ * though that should be hidden as the macro changes
+ * depending on the flex options that we use - in particular,
+ * %reentrant changes the way the macro is declared;
+ * without %reentrant, BEGIN uses yystart instead of yyg
+ */
+
 void reset_parencount(yyscan_t yyscanner );
 void reset_parencount(yyscan_t yyscanner )
 {
@@ -505,7 +517,6 @@
 	BEGIN(paren);
 }
 
-/* used by the bison code */
 void reset_semicount(yyscan_t yyscanner );
 void reset_semicount(yyscan_t yyscanner )
 {
@@ -514,7 +525,6 @@
 	BEGIN(semic);
 }
 
-/* used by the bison code */
 void reset_argcount(yyscan_t yyscanner );
 void reset_argcount(yyscan_t yyscanner )
 {

Modified: trunk/pbx/ael/ael.tab.c
===================================================================
--- trunk/pbx/ael/ael.tab.c	2006-04-29 14:18:03 UTC (rev 12)
+++ trunk/pbx/ael/ael.tab.c	2006-04-30 14:53:08 UTC (rev 13)
@@ -412,18 +412,18 @@
 #endif
 
 /* YYFINAL -- State number of the termination state. */
-#define YYFINAL  17
+#define YYFINAL  18
 /* YYLAST -- Last index in YYTABLE.  */
-#define YYLAST   584
+#define YYLAST   505
 
 /* YYNTOKENS -- Number of terminals. */
 #define YYNTOKENS  42
 /* YYNNTS -- Number of nonterminals. */
-#define YYNNTS  52
+#define YYNNTS  55
 /* YYNRULES -- Number of rules. */
-#define YYNRULES  151
+#define YYNRULES  149
 /* YYNRULES -- Number of states. */
-#define YYNSTATES  354
+#define YYNSTATES  346
 
 /* YYTRANSLATE(YYLEX) -- Bison symbol number corresponding to YYLEX.  */
 #define YYUNDEFTOK  2
@@ -473,110 +473,105 @@
 static const unsigned short int yyprhs[] =
 {
        0,     0,     3,     5,     7,    10,    13,    15,    17,    19,
-      21,    27,    32,    38,    43,    50,    56,    63,    69,    78,
-      86,    94,   101,   106,   110,   112,   115,   118,   119,   125,
-     127,   131,   134,   136,   138,   141,   144,   146,   148,   150,
-     152,   154,   155,   161,   164,   166,   171,   175,   180,   188,
-     197,   199,   202,   205,   206,   212,   213,   219,   234,   245,
-     247,   250,   252,   255,   259,   261,   264,   268,   269,   276,
-     280,   281,   287,   291,   295,   298,   299,   300,   301,   314,
-     315,   322,   325,   329,   333,   336,   339,   340,   346,   349,
-     352,   355,   358,   363,   366,   371,   374,   379,   381,   383,
-     387,   391,   397,   403,   409,   415,   417,   421,   427,   431,
-     437,   441,   442,   448,   452,   453,   457,   461,   464,   466,
-     467,   471,   474,   476,   479,   484,   488,   493,   497,   500,
-     504,   506,   509,   511,   517,   522,   526,   531,   535,   538,
-     542,   545,   548,   563,   574,   578,   594,   606,   609,   611,
-     613,   618
+      21,    23,    25,    31,    36,    43,    49,    58,    66,    74,
+      81,    86,    90,    92,    95,    98,    99,   105,   107,   111,
+     114,   116,   118,   121,   124,   126,   128,   130,   132,   134,
+     135,   141,   144,   146,   151,   155,   160,   168,   177,   179,
+     182,   185,   186,   192,   193,   199,   214,   225,   227,   230,
+     232,   235,   239,   241,   244,   248,   249,   256,   260,   261,
+     267,   271,   275,   278,   279,   280,   281,   294,   295,   302,
+     305,   309,   313,   316,   319,   320,   326,   329,   332,   335,
+     339,   343,   347,   349,   352,   353,   355,   359,   363,   369,
+     375,   381,   387,   389,   393,   399,   403,   409,   413,   414,
+     420,   424,   425,   429,   433,   436,   438,   439,   441,   442,
+     446,   448,   451,   456,   460,   465,   469,   472,   476,   478,
+     481,   483,   489,   494,   498,   503,   507,   510,   514,   517,
+     520,   535,   546,   550,   566,   578,   581,   583,   585,   590
 };
 
 /* YYRHS -- A `-1'-separated list of the rules' RHS. */
 static const yysigned_char yyrhs[] =
 {
       43,     0,    -1,    44,    -1,    45,    -1,    44,    45,    -1,
-      44,     1,    -1,    46,    -1,    47,    -1,    48,    -1,     8,
-      -1,     3,    41,     4,    53,     5,    -1,     3,    41,     4,
-       5,    -1,     3,    36,     4,    53,     5,    -1,     3,    36,
-       4,     5,    -1,    23,     3,    41,     4,    53,     5,    -1,
-      23,     3,    41,     4,     5,    -1,    23,     3,    36,     4,
-      53,     5,    -1,    23,     3,    36,     4,     5,    -1,    15,
-      41,     6,    52,     7,     4,    86,     5,    -1,    15,    41,
-       6,    52,     7,     4,     5,    -1,    15,    41,     6,     7,
-       4,    86,     5,    -1,    15,    41,     6,     7,     4,     5,
-      -1,    16,     4,    49,     5,    -1,    16,     4,     5,    -1,
-      50,    -1,    49,    50,    -1,    49,     1,    -1,    -1,    41,
-       9,    51,    41,     8,    -1,    41,    -1,    52,    10,    41,
-      -1,    52,     1,    -1,    54,    -1,     1,    -1,    53,    54,
-      -1,    53,     1,    -1,    57,    -1,    93,    -1,    88,    -1,
-      89,    -1,    56,    -1,    -1,    41,     9,    55,    41,     8,
+      44,     1,    -1,    47,    -1,    48,    -1,    49,    -1,     8,
+      -1,    41,    -1,    36,    -1,     3,    46,     4,    54,     5,
+      -1,     3,    46,     4,     5,    -1,    23,     3,    46,     4,
+      54,     5,    -1,    23,     3,    46,     4,     5,    -1,    15,
+      41,     6,    53,     7,     4,    89,     5,    -1,    15,    41,
+       6,    53,     7,     4,     5,    -1,    15,    41,     6,     7,
+       4,    89,     5,    -1,    15,    41,     6,     7,     4,     5,
+      -1,    16,     4,    50,     5,    -1,    16,     4,     5,    -1,
+      51,    -1,    50,    51,    -1,    50,     1,    -1,    -1,    41,
+       9,    52,    41,     8,    -1,    41,    -1,    53,    10,    41,
+      -1,    53,     1,    -1,    55,    -1,     1,    -1,    54,    55,
+      -1,    54,     1,    -1,    58,    -1,    96,    -1,    91,    -1,
+      92,    -1,    57,    -1,    -1,    41,     9,    56,    41,     8,
       -1,    41,     1,    -1,     8,    -1,    17,    24,    41,     8,
-      -1,    41,    24,    69,    -1,    30,    41,    24,    69,    -1,
-      31,     6,    65,     7,    41,    24,    69,    -1,    30,    31,
-       6,    65,     7,    41,    24,    69,    -1,    69,    -1,    58,
-      69,    -1,    58,     1,    -1,    -1,    19,     6,    60,    64,
-       7,    -1,    -1,    22,     6,    62,    64,     7,    -1,    20,
-       6,    65,    11,    65,    11,    65,    13,    65,    13,    65,
-      13,    65,     7,    -1,    20,     6,    41,    13,    65,    13,
-      65,    13,    65,     7,    -1,    41,    -1,    41,    41,    -1,
+      -1,    41,    24,    70,    -1,    30,    41,    24,    70,    -1,
+      31,     6,    66,     7,    41,    24,    70,    -1,    30,    31,
+       6,    66,     7,    41,    24,    70,    -1,    70,    -1,    59,
+      70,    -1,    59,     1,    -1,    -1,    19,     6,    61,    65,
+       7,    -1,    -1,    22,     6,    63,    65,     7,    -1,    20,
+       6,    66,    11,    66,    11,    66,    13,    66,    13,    66,
+      13,    66,     7,    -1,    20,     6,    41,    13,    66,    13,
+      66,    13,    66,     7,    -1,    41,    -1,    41,    41,    -1,
       41,    -1,    41,    41,    -1,    41,    41,    41,    -1,    41,
       -1,    41,    41,    -1,    41,    11,    41,    -1,    -1,    18,
-       6,    68,    41,     7,     4,    -1,     4,    58,     5,    -1,
-      -1,    41,     9,    70,    41,     8,    -1,    25,    76,     8,
-      -1,    26,    77,     8,    -1,    41,    11,    -1,    -1,    -1,
-      -1,    32,     6,    71,    41,     8,    72,    41,     8,    73,
-      41,     7,    69,    -1,    -1,    33,     6,    74,    41,     7,
-      69,    -1,    67,     5,    -1,    67,    84,     5,    -1,    12,
-      78,     8,    -1,    82,     8,    -1,    41,     8,    -1,    -1,
-      82,     9,    75,    41,     8,    -1,    28,     8,    -1,    27,
-       8,    -1,    29,     8,    -1,    61,    69,    -1,    61,    69,
-      21,    69,    -1,    59,    69,    -1,    59,    69,    21,    69,
-      -1,    63,    69,    -1,    63,    69,    21,    69,    -1,     8,
-      -1,    66,    -1,    66,    13,    66,    -1,    66,    10,    66,
-      -1,    66,    13,    66,    13,    66,    -1,    66,    10,    66,
-      10,    66,    -1,    36,    13,    66,    13,    66,    -1,    36,
-      10,    66,    10,    66,    -1,    66,    -1,    66,    10,    66,
-      -1,    66,    10,    41,    14,    41,    -1,    66,    14,    66,
-      -1,    66,    10,    41,    14,    36,    -1,    66,    14,    36,
-      -1,    -1,    41,     6,    79,    83,     7,    -1,    41,     6,
-       7,    -1,    -1,    41,    81,     6,    -1,    80,    83,     7,
-      -1,    80,     7,    -1,    64,    -1,    -1,    83,    10,    41,
-      -1,    83,    10,    -1,    85,    -1,    84,    85,    -1,    34,
-      41,    11,    58,    -1,    36,    11,    58,    -1,    35,    41,
-      11,    58,    -1,    34,    41,    11,    -1,    36,    11,    -1,
-      35,    41,    11,    -1,    87,    -1,    86,    87,    -1,    69,
-      -1,    37,    41,     4,    58,     5,    -1,    38,     4,    90,
-       5,    -1,    38,     4,     5,    -1,    39,     4,    90,     5,
-      -1,    39,     4,     5,    -1,    41,     8,    -1,    90,    41,
-       8,    -1,    90,     1,    -1,    92,     8,    -1,    92,    13,
-      65,    11,    65,    11,    65,    13,    65,    13,    65,    13,
-      65,     8,    -1,    92,    13,    41,    13,    65,    13,    65,
-      13,    65,     8,    -1,    91,    92,     8,    -1,    91,    92,
-      13,    65,    11,    65,    11,    65,    13,    65,    13,    65,
-      13,    65,     8,    -1,    91,    92,    13,    41,    13,    65,
-      13,    65,    13,    65,     8,    -1,    91,     1,    -1,    41,
-      -1,    36,    -1,    40,     4,    91,     5,    -1,    40,     4,
-       5,    -1
+       6,    69,    41,     7,     4,    -1,     4,    59,     5,    -1,
+      -1,    41,     9,    71,    41,     8,    -1,    25,    78,     8,
+      -1,    26,    79,     8,    -1,    41,    11,    -1,    -1,    -1,
+      -1,    32,     6,    72,    41,     8,    73,    41,     8,    74,
+      41,     7,    70,    -1,    -1,    33,     6,    75,    41,     7,
+      70,    -1,    68,     5,    -1,    68,    87,     5,    -1,    12,
+      80,     8,    -1,    84,     8,    -1,    41,     8,    -1,    -1,
+      84,     9,    76,    41,     8,    -1,    28,     8,    -1,    27,
+       8,    -1,    29,     8,    -1,    62,    70,    77,    -1,    60,
+      70,    77,    -1,    64,    70,    77,    -1,     8,    -1,    21,
+      70,    -1,    -1,    67,    -1,    67,    13,    67,    -1,    67,
+      10,    67,    -1,    67,    13,    67,    13,    67,    -1,    67,
+      10,    67,    10,    67,    -1,    36,    13,    67,    13,    67,
+      -1,    36,    10,    67,    10,    67,    -1,    67,    -1,    67,
+      10,    67,    -1,    67,    10,    41,    14,    41,    -1,    67,
+      14,    67,    -1,    67,    10,    41,    14,    36,    -1,    67,
+      14,    36,    -1,    -1,    41,     6,    81,    86,     7,    -1,
+      41,     6,     7,    -1,    -1,    41,    83,     6,    -1,    82,
+      86,     7,    -1,    82,     7,    -1,    41,    -1,    -1,    65,
+      -1,    -1,    86,    10,    85,    -1,    88,    -1,    87,    88,
+      -1,    34,    41,    11,    59,    -1,    36,    11,    59,    -1,
+      35,    41,    11,    59,    -1,    34,    41,    11,    -1,    36,
+      11,    -1,    35,    41,    11,    -1,    90,    -1,    89,    90,
+      -1,    70,    -1,    37,    41,     4,    59,     5,    -1,    38,
+       4,    93,     5,    -1,    38,     4,     5,    -1,    39,     4,
+      93,     5,    -1,    39,     4,     5,    -1,    41,     8,    -1,
+      93,    41,     8,    -1,    93,     1,    -1,    95,     8,    -1,
+      95,    13,    66,    11,    66,    11,    66,    13,    66,    13,
+      66,    13,    66,     8,    -1,    95,    13,    41,    13,    66,
+      13,    66,    13,    66,     8,    -1,    94,    95,     8,    -1,
+      94,    95,    13,    66,    11,    66,    11,    66,    13,    66,
+      13,    66,    13,    66,     8,    -1,    94,    95,    13,    41,
+      13,    66,    13,    66,    13,    66,     8,    -1,    94,     1,
+      -1,    41,    -1,    36,    -1,    40,     4,    94,     5,    -1,
+      40,     4,     5,    -1
 };
 
 /* YYRLINE[YYN] -- source line where rule number YYN was defined.  */
 static const unsigned short int yyrline[] =
 {
-       0,   157,   157,   160,   161,   172,   175,   176,   177,   178,
-     181,   185,   188,   192,   195,   200,   204,   209,   215,   218,
-     221,   225,   230,   233,   237,   238,   239,   242,   242,   248,
-     251,   256,   259,   260,   261,   264,   267,   268,   269,   270,
-     271,   272,   272,   276,   277,   280,   285,   289,   294,   299,
-     308,   309,   312,   315,   315,   320,   320,   325,   341,   361,
-     362,   369,   370,   375,   383,   384,   388,   394,   394,   402,
-     405,   405,   409,   412,   415,   418,   419,   420,   418,   426,
-     426,   430,   434,   439,   443,   447,   450,   450,   483,   484,
-     485,   486,   491,   497,   502,   508,   513,   519,   522,   524,
-     529,   534,   541,   548,   555,   564,   569,   574,   581,   588,
-     595,   604,   604,   609,   614,   614,   624,   630,   633,   636,
-     639,   644,   651,   652,   657,   661,   665,   669,   672,   675,
-     680,   681,   686,   687,   693,   696,   700,   703,   707,   710,
-     715,   718,   721,   738,   751,   756,   774,   788,   791,   792,
-     795,   798
+       0,   165,   165,   168,   169,   180,   183,   184,   185,   186,
+     189,   190,   193,   197,   200,   205,   229,   232,   235,   239,
+     244,   247,   251,   252,   253,   256,   256,   262,   265,   269,
+     272,   273,   274,   277,   280,   281,   282,   283,   284,   285,
+     285,   289,   290,   293,   298,   302,   307,   312,   321,   322,
+     325,   328,   328,   333,   333,   338,   354,   374,   375,   382,
+     383,   388,   396,   397,   401,   407,   407,   415,   418,   418,
+     422,   425,   428,   431,   432,   433,   431,   439,   439,   443,
+     447,   452,   456,   460,   463,   463,   496,   497,   498,   499,
+     513,   527,   541,   544,   545,   550,   552,   557,   562,   569,
+     576,   583,   592,   597,   602,   609,   616,   623,   632,   632,
+     637,   642,   642,   652,   658,   661,   662,   665,   668,   671,
+     685,   686,   691,   695,   699,   703,   706,   709,   714,   715,
+     720,   721,   727,   730,   734,   737,   741,   744,   749,   752,
+     755,   772,   785,   790,   808,   823,   826,   827,   830,   833
 };
 #endif
 
@@ -592,15 +587,16 @@
   &quot;KW_RETURN&quot;, &quot;KW_BREAK&quot;, &quot;KW_CONTINUE&quot;, &quot;KW_REGEXTEN&quot;, &quot;KW_HINT&quot;,
   &quot;KW_FOR&quot;, &quot;KW_WHILE&quot;, &quot;KW_CASE&quot;, &quot;KW_PATTERN&quot;, &quot;KW_DEFAULT&quot;, &quot;KW_CATCH&quot;,
   &quot;KW_SWITCHES&quot;, &quot;KW_ESWITCHES&quot;, &quot;KW_INCLUDES&quot;, &quot;word&quot;, &quot;$accept&quot;, &quot;file&quot;,
-  &quot;objects&quot;, &quot;object&quot;, &quot;context&quot;, &quot;macro&quot;, &quot;globals&quot;, &quot;global_statements&quot;,
-  &quot;global_statement&quot;, &quot;@1&quot;, &quot;arglist&quot;, &quot;elements&quot;, &quot;element&quot;, &quot;@2&quot;,
-  &quot;ignorepat&quot;, &quot;extension&quot;, &quot;statements&quot;, &quot;if_head&quot;, &quot;@3&quot;, &quot;random_head&quot;,
-  &quot;@4&quot;, &quot;iftime_head&quot;, &quot;word_list&quot;, &quot;word3_list&quot;, &quot;goto_word&quot;,
-  &quot;switch_head&quot;, &quot;@5&quot;, &quot;statement&quot;, &quot;@6&quot;, &quot;@7&quot;, &quot;@8&quot;, &quot;@9&quot;, &quot;@10&quot;, &quot;@11&quot;,
-  &quot;target&quot;, &quot;jumptarget&quot;, &quot;macro_call&quot;, &quot;@12&quot;, &quot;application_call_head&quot;,
-  &quot;@13&quot;, &quot;application_call&quot;, &quot;eval_arglist&quot;, &quot;case_statements&quot;,
-  &quot;case_statement&quot;, &quot;macro_statements&quot;, &quot;macro_statement&quot;, &quot;switches&quot;,
-  &quot;eswitches&quot;, &quot;switchlist&quot;, &quot;includeslist&quot;, &quot;includedname&quot;, &quot;includes&quot;, 0
+  &quot;objects&quot;, &quot;object&quot;, &quot;word_or_default&quot;, &quot;context&quot;, &quot;macro&quot;, &quot;globals&quot;,
+  &quot;global_statements&quot;, &quot;global_statement&quot;, &quot;@1&quot;, &quot;arglist&quot;, &quot;elements&quot;,
+  &quot;element&quot;, &quot;@2&quot;, &quot;ignorepat&quot;, &quot;extension&quot;, &quot;statements&quot;, &quot;if_head&quot;, &quot;@3&quot;,
+  &quot;random_head&quot;, &quot;@4&quot;, &quot;iftime_head&quot;, &quot;word_list&quot;, &quot;word3_list&quot;,
+  &quot;goto_word&quot;, &quot;switch_head&quot;, &quot;@5&quot;, &quot;statement&quot;, &quot;@6&quot;, &quot;@7&quot;, &quot;@8&quot;, &quot;@9&quot;,
+  &quot;@10&quot;, &quot;@11&quot;, &quot;opt_else&quot;, &quot;target&quot;, &quot;jumptarget&quot;, &quot;macro_call&quot;, &quot;@12&quot;,
+  &quot;application_call_head&quot;, &quot;@13&quot;, &quot;application_call&quot;, &quot;opt_word&quot;,
+  &quot;eval_arglist&quot;, &quot;case_statements&quot;, &quot;case_statement&quot;, &quot;macro_statements&quot;,
+  &quot;macro_statement&quot;, &quot;switches&quot;, &quot;eswitches&quot;, &quot;switchlist&quot;, &quot;includeslist&quot;,
+  &quot;includedname&quot;, &quot;includes&quot;, 0
 };
 #endif
 
@@ -621,42 +617,40 @@
 static const unsigned char yyr1[] =
 {
        0,    42,    43,    44,    44,    44,    45,    45,    45,    45,
-      46,    46,    46,    46,    46,    46,    46,    46,    47,    47,
-      47,    47,    48,    48,    49,    49,    49,    51,    50,    52,
-      52,    52,    53,    53,    53,    53,    54,    54,    54,    54,
-      54,    55,    54,    54,    54,    56,    57,    57,    57,    57,
-      58,    58,    58,    60,    59,    62,    61,    63,    63,    64,
-      64,    65,    65,    65,    66,    66,    66,    68,    67,    69,
-      70,    69,    69,    69,    69,    71,    72,    73,    69,    74,
-      69,    69,    69,    69,    69,    69,    75,    69,    69,    69,
-      69,    69,    69,    69,    69,    69,    69,    69,    76,    76,
-      76,    76,    76,    76,    76,    77,    77,    77,    77,    77,
-      77,    79,    78,    78,    81,    80,    82,    82,    83,    83,
-      83,    83,    84,    84,    85,    85,    85,    85,    85,    85,
-      86,    86,    87,    87,    88,    88,    89,    89,    90,    90,
-      90,    91,    91,    91,    91,    91,    91,    91,    92,    92,
-      93,    93
+      46,    46,    47,    47,    47,    47,    48,    48,    48,    48,
+      49,    49,    50,    50,    50,    52,    51,    53,    53,    53,
+      54,    54,    54,    54,    55,    55,    55,    55,    55,    56,
+      55,    55,    55,    57,    58,    58,    58,    58,    59,    59,
+      59,    61,    60,    63,    62,    64,    64,    65,    65,    66,
+      66,    66,    67,    67,    67,    69,    68,    70,    71,    70,
+      70,    70,    70,    72,    73,    74,    70,    75,    70,    70,
+      70,    70,    70,    70,    76,    70,    70,    70,    70,    70,
+      70,    70,    70,    77,    77,    78,    78,    78,    78,    78,
+      78,    78,    79,    79,    79,    79,    79,    79,    81,    80,
+      80,    83,    82,    84,    84,    85,    85,    86,    86,    86,
+      87,    87,    88,    88,    88,    88,    88,    88,    89,    89,
+      90,    90,    91,    91,    92,    92,    93,    93,    93,    94,
+      94,    94,    94,    94,    94,    94,    95,    95,    96,    96
 };
 
 /* YYR2[YYN] -- Number of symbols composing right hand side of rule YYN.  */
 static const unsigned char yyr2[] =
 {
        0,     2,     1,     1,     2,     2,     1,     1,     1,     1,
-       5,     4,     5,     4,     6,     5,     6,     5,     8,     7,
-       7,     6,     4,     3,     1,     2,     2,     0,     5,     1,
-       3,     2,     1,     1,     2,     2,     1,     1,     1,     1,
-       1,     0,     5,     2,     1,     4,     3,     4,     7,     8,
-       1,     2,     2,     0,     5,     0,     5,    14,    10,     1,
-       2,     1,     2,     3,     1,     2,     3,     0,     6,     3,
-       0,     5,     3,     3,     2,     0,     0,     0,    12,     0,
-       6,     2,     3,     3,     2,     2,     0,     5,     2,     2,
-       2,     2,     4,     2,     4,     2,     4,     1,     1,     3,
-       3,     5,     5,     5,     5,     1,     3,     5,     3,     5,
-       3,     0,     5,     3,     0,     3,     3,     2,     1,     0,
-       3,     2,     1,     2,     4,     3,     4,     3,     2,     3,
-       1,     2,     1,     5,     4,     3,     4,     3,     2,     3,
-       2,     2,    14,    10,     3,    15,    11,     2,     1,     1,
-       4,     3
+       1,     1,     5,     4,     6,     5,     8,     7,     7,     6,
+       4,     3,     1,     2,     2,     0,     5,     1,     3,     2,
+       1,     1,     2,     2,     1,     1,     1,     1,     1,     0,
+       5,     2,     1,     4,     3,     4,     7,     8,     1,     2,
+       2,     0,     5,     0,     5,    14,    10,     1,     2,     1,
+       2,     3,     1,     2,     3,     0,     6,     3,     0,     5,
+       3,     3,     2,     0,     0,     0,    12,     0,     6,     2,
+       3,     3,     2,     2,     0,     5,     2,     2,     2,     3,
+       3,     3,     1,     2,     0,     1,     3,     3,     5,     5,
+       5,     5,     1,     3,     5,     3,     5,     3,     0,     5,
+       3,     0,     3,     3,     2,     1,     0,     1,     0,     3,
+       1,     2,     4,     3,     4,     3,     2,     3,     1,     2,
+       1,     5,     4,     3,     4,     3,     2,     3,     2,     2,
+      14,    10,     3,    15,    11,     2,     1,     1,     4,     3
 };
 
 /* YYDEFACT[STATE-NAME] -- Default rule to reduce with in state
@@ -665,279 +659,260 @@
 static const unsigned char yydefact[] =
 {
        0,     0,     9,     0,     0,     0,     0,     0,     3,     6,
-       7,     8,     0,     0,     0,     0,     0,     1,     5,     4,
-       0,     0,     0,    23,     0,     0,    24,     0,     0,    33,
-      13,    44,     0,     0,     0,     0,     0,     0,     0,     0,
-      32,    40,    36,    38,    39,    37,    11,     0,     0,    29,
-       0,    27,    26,    22,    25,     0,     0,     0,     0,     0,
-       0,     0,     0,     0,    43,    41,     0,    35,    12,    34,
-      10,     0,    31,     0,     0,     0,    17,     0,    15,     0,
-       0,     0,     0,    61,     0,   135,     0,     0,   137,     0,
-     151,   149,   148,     0,     0,     0,     0,    97,     0,     0,
-       0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
-     114,     0,     0,     0,     0,    46,   119,     0,    21,     0,
-     132,     0,   130,     0,    30,     0,    16,    14,    45,     0,
-      47,    62,     0,   138,   140,   134,     0,   136,   147,   150,
-       0,   141,     0,     0,     0,    50,     0,     0,    67,    53,
-       0,    55,     0,    64,    98,     0,   105,     0,    89,    88,
-      90,    75,    79,    85,    70,    74,     0,    93,    91,    95,
-      81,     0,     0,     0,     0,   122,   117,    59,   118,     0,
-      84,    86,     0,    20,   131,    19,     0,    28,     0,    63,
-       0,   139,   144,     0,    61,     0,    42,    52,    69,    51,
-     111,    83,     0,     0,    61,     0,     0,     0,     0,     0,
-      65,     0,     0,    72,     0,     0,    73,     0,     0,     0,
-     115,     0,     0,     0,     0,     0,   128,    82,   123,    60,
-     116,   121,     0,     0,    18,     0,     0,    61,     0,     0,
-       0,   113,   119,     0,     0,     0,     0,     0,     0,     0,
-      66,   100,    99,    64,   106,   110,   108,     0,     0,     0,
-      94,    92,    96,   127,   129,     0,   120,     0,     0,     0,
-      48,     0,     0,     0,     0,     0,     0,    54,     0,     0,
-      56,     0,     0,     0,     0,     0,    76,     0,    71,     0,
-       0,    87,   133,    49,     0,     0,     0,     0,   112,    68,
-       0,     0,   104,   103,   102,   101,   109,   107,     0,    80,
-       0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
-       0,     0,     0,    77,     0,     0,     0,     0,     0,     0,
-       0,     0,     0,   143,     0,    58,     0,     0,   146,     0,
-       0,     0,     0,     0,     0,     0,    78,     0,     0,     0,
-       0,   142,    57,   145
+       7,     8,    11,    10,     0,     0,     0,     0,     1,     5,
+       4,     0,     0,    21,     0,     0,    22,     0,    31,    13,
+      42,     0,     0,     0,     0,     0,     0,     0,     0,    30,
+      38,    34,    36,    37,    35,     0,    27,     0,    25,    24,
+      20,    23,     0,     0,     0,     0,     0,     0,     0,     0,
+      41,    39,     0,    33,    12,    32,     0,    29,     0,     0,
+       0,    15,     0,     0,     0,     0,    59,     0,   133,     0,
+       0,   135,     0,   149,   147,   146,     0,     0,     0,     0,
+      92,     0,     0,     0,     0,     0,     0,     0,     0,     0,
+       0,     0,     0,   111,     0,     0,     0,     0,    44,   118,
+       0,    19,     0,   130,     0,   128,     0,    28,     0,    14,
+      43,     0,    45,    60,     0,   136,   138,   132,     0,   134,
+     145,   148,     0,   139,     0,     0,     0,    48,     0,     0,
+      65,    51,     0,    53,     0,    62,    95,     0,   102,     0,
+      87,    86,    88,    73,    77,    83,    68,    72,     0,    94,
+      94,    94,    79,     0,     0,     0,     0,   120,   114,    57,
+     117,     0,    82,    84,     0,    18,   129,    17,     0,    26,
+       0,    61,     0,   137,   142,     0,    59,     0,    40,    50,
+      67,    49,   108,    81,     0,     0,    59,     0,     0,     0,
+       0,     0,    63,     0,     0,    70,     0,     0,    71,     0,
+       0,     0,   112,     0,    90,    89,    91,     0,     0,   126,
+      80,   121,    58,   113,   116,     0,     0,    16,     0,     0,
+      59,     0,     0,     0,   110,   118,     0,     0,     0,     0,
+       0,     0,     0,    64,    97,    96,    62,   103,   107,   105,
+       0,     0,     0,    93,   125,   127,     0,   115,   119,     0,
+       0,     0,    46,     0,     0,     0,     0,     0,     0,    52,
+       0,     0,    54,     0,     0,     0,     0,     0,    74,     0,
+      69,     0,     0,    85,   131,    47,     0,     0,     0,     0,
+     109,    66,     0,     0,   101,   100,    99,    98,   106,   104,
+       0,    78,     0,     0,     0,     0,     0,     0,     0,     0,
+       0,     0,     0,     0,     0,    75,     0,     0,     0,     0,
+       0,     0,     0,     0,     0,   141,     0,    56,     0,     0,
+     144,     0,     0,     0,     0,     0,     0,     0,    76,     0,
+       0,     0,     0,   140,    55,   143
 };
 
 /* YYDEFGOTO[NTERM-NUM]. */
 static const short int yydefgoto[] =
 {
-      -1,     6,     7,     8,     9,    10,    11,    25,    26,    75,
-      50,    39,    40,    95,    41,    42,   144,   111,   203,   112,
-     206,   113,   178,    84,   154,   114,   202,   145,   219,   217,
-     308,   330,   218,   232,   155,   157,   147,   242,   116,   166,
-     117,   179,   174,   175,   121,   122,    43,    44,    87,    93,
-      94,    45
+      -1,     6,     7,     8,    14,     9,    10,    11,    25,    26,
+      70,    47,    38,    39,    88,    40,    41,   136,   104,   195,
+     105,   198,   106,   170,    77,   146,   107,   194,   137,   211,
+     209,   300,   322,   210,   225,   214,   147,   149,   139,   235,
+     109,   158,   110,   258,   171,   166,   167,   114,   115,    42,
+      43,    80,    86,    87,    44
 };
 
 /* YYPACT[STATE-NUM] -- Index in YYTABLE of the portion describing
    STATE-NUM.  */
-#define YYPACT_NINF -215
+#define YYPACT_NINF -193
 static const short int yypact[] =
 {
-     212,   127,  -215,   -35,    55,    23,    85,   561,  -215,  -215,
-    -215,  -215,    64,   118,   112,    13,   128,  -215,  -215,  -215,
-     157,   208,     2,  -215,   123,    19,  -215,   130,   137,  -215,
-    -215,  -215,   143,    43,   169,   181,   182,   189,   126,   284,
-    -215,  -215,  -215,  -215,  -215,  -215,  -215,   337,   196,  -215,
-     141,  -215,  -215,  -215,  -215,   342,   357,   135,   188,   177,
-     170,    22,    36,    29,  -215,  -215,   527,  -215,  -215,  -215,
-    -215,   423,  -215,   206,   191,   195,  -215,   384,  -215,   399,
-     210,   170,   527,   200,   215,  -215,   242,    51,  -215,    57,
-    -215,  -215,  -215,    12,   158,   220,   527,  -215,   223,   245,
-     250,   259,   262,   148,   229,   263,   265,   266,   269,   275,
-     251,   527,   527,   527,   156,  -215,    26,   145,  -215,   243,
-    -215,   449,  -215,   475,  -215,   279,  -215,  -215,  -215,   281,
-    -215,   252,   253,  -215,  -215,  -215,   283,  -215,  -215,  -215,
-     204,  -215,   254,   291,   278,  -215,   296,   300,  -215,  -215,
-     276,  -215,    69,    40,    95,   310,   114,   313,  -215,  -215,
-    -215,  -215,  -215,  -215,  -215,  -215,   323,   311,   318,   325,
-    -215,   290,   303,   340,   172,  -215,  -215,   307,  -215,   230,
-    -215,  -215,   348,  -215,  -215,  -215,   501,  -215,   312,  -215,
-     331,  -215,  -215,   315,    58,   346,  -215,  -215,  -215,  -215,
-     353,  -215,   320,   322,    76,   355,   322,   229,   229,   328,
-    -215,   229,   229,  -215,   329,   178,  -215,   330,   338,   343,
-    -215,   527,   527,   527,   375,   379,   527,  -215,  -215,  -215,
-    -215,   350,   352,   527,  -215,   370,   527,   108,   388,   170,
-     170,  -215,   322,   395,   396,   170,   170,   398,   354,   393,
-    -215,   400,   404,    50,  -215,  -215,  -215,   401,   405,   403,
-    -215,  -215,  -215,   527,   527,     3,  -215,   410,   308,   527,
-    -215,   170,   170,   406,   397,   235,   409,  -215,   407,   415,
-    -215,   229,   229,   229,   229,   190,  -215,   527,  -215,    68,
-     111,  -215,  -215,  -215,   408,   421,   170,   170,  -215,  -215,
-     170,   170,  -215,  -215,  -215,  -215,  -215,  -215,   392,  -215,
-     170,   170,   431,   433,   434,   445,   426,   446,   450,   170,
-     170,   170,   170,  -215,   170,   170,   428,   452,   455,   453,
-     429,   464,   460,  -215,   170,  -215,   170,   477,  -215,   170,
-     472,   476,   527,   478,   170,   170,  -215,   170,   480,   485,
-     488,  -215,  -215,  -215
+     121,   117,  -193,   -38,    84,    17,    95,   343,  -193,  -193,
+    -193,  -193,  -193,  -193,    98,   122,     9,   117,  -193,  -193,
+    -193,   151,    53,  -193,   110,    14,  -193,   167,  -193,  -193,
+    -193,   102,    39,   182,   200,   214,   218,   184,   204,  -193,
+    -193,  -193,  -193,  -193,  -193,   219,  -193,   196,  -193,  -193,
+    -193,  -193,   280,   183,   221,   207,   187,    23,    44,    20,
+    -193,  -193,   461,  -193,  -193,  -193,   357,  -193,   228,   192,
+     195,  -193,   333,   229,   187,   461,   197,   234,  -193,   238,
+      16,  -193,    46,  -193,  -193,  -193,     5,   147,   206,   461,
+    -193,   211,   249,   250,   251,   252,   125,   220,   254,   256,
+     258,   253,   261,   104,   461,   461,   461,   129,  -193,    60,
+      50,  -193,   230,  -193,   383,  -193,   409,  -193,   262,  -193,
+    -193,   270,  -193,   239,   242,  -193,  -193,  -193,   276,  -193,
+    -193,  -193,   149,  -193,   246,   281,   274,  -193,   263,   282,
+    -193,  -193,   257,  -193,   173,     7,   201,   283,    63,   287,
+    -193,  -193,  -193,  -193,  -193,  -193,  -193,  -193,   298,   292,
+     292,   292,  -193,   273,   284,   306,   138,  -193,  -193,   286,
+    -193,   120,  -193,  -193,   324,  -193,  -193,  -193,   435,  -193,
+     294,  -193,   236,  -193,  -193,   299,    -6,   328,  -193,  -193,
+    -193,  -193,   335,  -193,   307,   308,    40,   336,   308,   220,
+     220,   311,  -193,   220,   220,  -193,   312,   166,  -193,   313,
+     314,   315,  -193,   461,  -193,  -193,  -193,   346,   349,   461,
+    -193,  -193,  -193,  -193,   326,   327,   461,  -193,   354,   461,
+      65,   359,   187,   187,  -193,   308,   373,   374,   187,   187,
+     385,   386,   380,  -193,   387,   391,   109,  -193,  -193,  -193,
+     392,   399,   410,  -193,   461,   461,     4,  -193,  -193,   411,
+     304,   461,  -193,   187,   187,   394,   388,   177,   418,  -193,
+     412,   415,  -193,   220,   220,   220,   220,   174,  -193,   461,
+    -193,    64,   113,  -193,  -193,  -193,   417,   421,   187,   187,
+    -193,  -193,   187,   187,  -193,  -193,  -193,  -193,  -193,  -193,
+     382,  -193,   187,   187,   420,   431,   432,   436,   440,   438,
+     439,   187,   187,   187,   187,  -193,   187,   187,   448,   445,
+     452,   453,   429,   463,   462,  -193,   187,  -193,   187,   467,
+    -193,   187,   464,   465,   461,   469,   187,   187,  -193,   187,
+     476,   478,   483,  -193,  -193,  -193
 };
 
 /* YYPGOTO[NTERM-NUM].  */
 static const short int yypgoto[] =
 {
-    -215,  -215,  -215,   491,  -215,  -215,  -215,  -215,   474,  -215,
-    -215,   104,   -37,  -215,  -215,  -215,  -214,  -215,  -215,  -215,
-    -215,  -215,    60,   -67,  -101,  -215,  -215,   -66,  -215,  -215,
-    -215,  -215,  -215,  -215,  -215,  -215,  -215,  -215,  -215,  -215,
-    -215,   268,  -215,   341,   391,  -120,  -215,  -215,   456,  -215,
-     418,  -215
+    -193,  -193,  -193,   485,   479,  -193,  -193,  -193,  -193,   470,
+    -193,  -193,   446,    37,  -193,  -193,  -193,  -192,  -193,  -193,
+    -193,  -193,  -193,    18,   -63,   -96,  -193,  -193,   -62,  -193,
+    -193,  -193,  -193,  -193,  -193,    35,  -193,  -193,  -193,  -193,
+    -193,  -193,  -193,  -193,   264,  -193,   331,   384,  -112,  -193,
+    -193,   443,  -193,   419,  -193
 };
 
 /* YYTABLE[YYPACT[STATE-NUM]].  What to do in state STATE-NUM.  If
    positive, shift that token.  If negative, reduce the rule which
    number is the opposite.  If zero, do what YYDEFACT says.
    If YYTABLE_NINF, syntax error.  */
-#define YYTABLE_NINF -127
+#define YYTABLE_NINF -125
 static const short int yytable[] =
 {
-     115,   184,    69,   156,   197,   120,    14,    96,  -125,    48,
-      69,    97,   265,   138,   129,    98,   130,   139,    23,   268,
-      52,    99,   100,   101,    53,   102,    16,    85,   103,   104,
-     105,   106,   107,   176,    90,   108,   109,  -125,  -125,  -125,
-      69,    88,    69,    49,   110,   167,   168,   169,    91,   289,
-     290,   209,   134,    92,    24,   120,   135,   120,   134,    15,
-      24,   209,   137,    86,   285,    91,   184,   177,    20,   197,
-      92,   239,    96,  -124,    58,   195,    97,    86,   199,   207,
-      98,   210,   208,   205,    59,    17,    99,   100,   101,   245,
-     102,   210,   136,   103,   104,   105,   106,   107,   136,   131,
-     108,   109,  -124,  -124,  -124,   211,   248,   249,   212,   110,
-     251,   252,   197,   254,   256,    96,  -126,   131,    22,    97,
-     120,   271,    21,    98,   214,    47,   238,    64,   215,    99,
-     100,   101,    51,   102,    55,    65,   103,   104,   105,   106,
-     107,    56,    72,   108,   109,  -126,  -126,  -126,    73,   131,
-      66,    74,   110,   180,   181,   260,   261,   262,    29,    77,
-      79,   170,    30,    12,    27,    31,   141,    57,    13,    28,
-     270,   142,   273,   274,    32,    60,    80,   227,   278,   279,
-     302,   303,   304,   305,   152,    61,    62,    33,    34,   153,
-     171,   172,   173,    63,    81,    35,    36,    37,    38,   199,
-      71,    82,   199,   293,   294,   295,   171,   172,   173,    29,
-     123,    83,   192,    46,   255,     1,    31,   193,   128,   153,
-       2,   309,   132,   199,   199,    32,   306,     3,     4,   312,
-     313,   307,   124,   314,   315,     5,   125,   230,    33,    34,
-     231,   131,   298,   317,   318,   231,    35,    36,    37,    38,
-     133,   148,   326,   327,   328,   329,   149,   331,   332,   163,
-     164,   143,   165,   244,   146,   150,   247,   340,   151,   341,
-     153,   158,   343,   159,   160,   161,   346,   348,   349,   197,
-     350,   162,    96,   198,   182,    67,    97,   187,   188,    68,
-      98,   191,    31,   189,   190,   194,    99,   100,   101,   196,
-     102,    32,   200,   103,   104,   105,   106,   107,   201,   197,
-     108,   109,    96,   292,    33,    34,    97,   204,   213,   110,
-      98,   216,    35,    36,    37,    38,    99,   100,   101,   220,
-     102,   224,   221,   103,   104,   105,   106,   107,    67,   222,
-     108,   109,    70,    29,   225,    31,   223,    76,   229,   110,
-      31,   226,   233,   235,    32,   236,   237,   240,    29,    32,
-     241,   243,    78,   177,   281,    31,   246,    33,    34,   250,
-     253,   257,    33,    34,    32,    35,    36,    37,    38,   258,
-      35,    36,    37,    38,   259,    67,   263,    33,    34,   126,
-     264,   266,    31,   267,   269,    35,    36,    37,    38,   272,
-      67,    32,   276,   277,   127,   280,   282,    31,   297,   286,
-     283,   288,   287,   299,    33,    34,    32,   284,   291,   296,
-     300,   310,    35,    36,    37,    38,   301,    96,   118,    33,
-      34,    97,   311,   316,   323,    98,   333,    35,    36,    37,
-      38,    99,   100,   101,   319,   102,   320,   321,   103,   104,
-     105,   106,   107,    96,   183,   108,   109,    97,   322,   324,
-     119,    98,   335,   325,   110,   334,   336,    99,   100,   101,
-     337,   102,   338,   339,   103,   104,   105,   106,   107,    96,
-     185,   108,   109,    97,   342,   344,   119,    98,   351,   345,
-     110,   347,   352,    99,   100,   101,   353,   102,    19,    54,
-     103,   104,   105,   106,   107,    96,   234,   108,   109,    97,
-     275,   140,   119,    98,   186,   228,   110,     0,    89,    99,
-     100,   101,     0,   102,     0,     0,   103,   104,   105,   106,
-     107,    96,     0,   108,   109,    97,     0,     0,   119,    98,
-       0,     0,   110,     0,     0,    99,   100,   101,     0,   102,
-       0,     0,   103,   104,   105,   106,   107,     0,     0,   108,
-     109,    -2,    18,     0,     1,     0,     0,     0,   110,     2,
-       0,     0,     0,     0,     0,     0,     3,     4,     0,     0,
-       0,     0,     0,     0,     5
+     108,   148,   176,    15,   113,   189,   130,   232,    89,  -123,
+     131,   121,    90,   122,    23,    49,    91,   126,   201,    50,
+      17,   127,    92,    93,    94,    83,    95,   256,    78,    96,
+      97,    98,    99,   100,   260,   123,   101,   102,  -123,  -123,
+    -123,    84,   159,   160,   161,   103,    85,   126,   202,    81,
+      24,   129,   113,   238,   113,    24,    84,   128,   172,   173,
+      45,    85,   281,   282,    79,   189,   176,   168,    89,  -122,
+      54,   187,    90,   206,   191,    65,    91,   207,   263,   197,
+      55,   123,    92,    93,    94,    79,    95,   128,    16,    96,
+      97,    98,    99,   100,    46,    18,   101,   102,  -122,  -122,
+    -122,   169,    21,   241,   242,   103,   123,   244,   245,    65,
+     247,   249,   155,   156,   189,   157,   113,    89,  -124,    48,
+     201,    90,   231,   277,     1,    91,    53,   223,    22,     2,
+     224,    92,    93,    94,   162,    95,     3,     4,    96,    97,
+      98,    99,   100,   220,     5,   101,   102,  -124,  -124,  -124,
+     202,   253,    28,    12,   103,   133,    29,   184,    13,    30,
+     134,   144,   185,   163,   164,   165,   145,   262,    31,   265,
+     266,    52,   163,   164,   165,   270,   271,   294,   295,   296,
+     297,    32,    33,   199,   290,    60,   200,   224,    56,    34,
+      35,    36,    37,    61,   191,   215,   216,    67,   191,   285,
+     286,   287,   248,    68,    57,    63,    69,   145,    62,    64,
+     298,   203,    30,   237,   204,   299,   240,   301,    58,   191,
+     191,    31,    59,    66,    73,   304,   305,    74,    76,   306,
+     307,    75,   116,   117,    32,    33,   118,   120,   123,   309,
+     310,   124,    34,    35,    36,    37,   125,   135,   318,   319,
+     320,   321,   138,   323,   324,   140,   141,   142,   143,   153,
+     229,   145,   150,   332,   151,   333,   152,   154,   335,   192,
+     179,   174,   338,   340,   341,   189,   342,   180,    89,   190,
+     181,    28,    90,   182,   183,    71,    91,   186,    30,   188,
+     193,   205,    92,    93,    94,   208,    95,    31,   196,    96,
+      97,    98,    99,   100,   212,   189,   101,   102,    89,   284,
+      32,    33,    90,   213,   217,   103,    91,   219,    34,    35,
+      36,    37,    92,    93,    94,   218,    95,   222,   226,    96,
+      97,    98,    99,   100,    63,   228,   101,   102,   119,   233,
+     230,    30,   234,    -2,    19,   103,     1,   239,   236,   169,
+      31,     2,   243,   246,   250,   251,   252,   254,     3,     4,
+     255,    89,   111,    32,    33,    90,     5,   257,   259,    91,
+     264,    34,    35,    36,    37,    92,    93,    94,   261,    95,
+     268,   269,    96,    97,    98,    99,   100,    89,   175,   101,
+     102,    90,   272,   274,   112,    91,   273,   275,   103,   289,
+     278,    92,    93,    94,   276,    95,   279,   288,    96,    97,
+      98,    99,   100,    89,   177,   101,   102,    90,   280,   283,
+     112,    91,   291,   308,   103,   292,   293,    92,    93,    94,
+     302,    95,   303,   311,    96,    97,    98,    99,   100,    89,
+     227,   101,   102,    90,   312,   313,   112,    91,   315,   314,
+     103,   316,   317,    92,    93,    94,   325,    95,   326,   327,
+      96,    97,    98,    99,   100,    89,   328,   101,   102,    90,
+     329,   330,   112,    91,   334,   331,   103,   336,   337,    92,
+      93,    94,   339,    95,   343,   344,    96,    97,    98,    99,
+     100,   345,    20,   101,   102,    51,    27,   221,    72,   267,
+     178,    82,   103,     0,     0,   132
 };
 
 static const short int yycheck[] =
 {
-      66,   121,    39,   104,     1,    71,    41,     4,     5,     7,
-      47,     8,   226,     1,    81,    12,    82,     5,     5,   233,
-       1,    18,    19,    20,     5,    22,     3,     5,    25,    26,
-      27,    28,    29,     7,     5,    32,    33,    34,    35,    36,
-      77,     5,    79,    41,    41,   111,   112,   113,    36,   263,
-     264,    11,     1,    41,    41,   121,     5,   123,     1,     4,
-      41,    11,     5,    41,    14,    36,   186,    41,     4,     1,
-      41,    13,     4,     5,    31,   142,     8,    41,   144,    10,
-      12,    41,    13,   150,    41,     0,    18,    19,    20,    13,
-      22,    41,    41,    25,    26,    27,    28,    29,    41,    41,
-      32,    33,    34,    35,    36,    10,   207,   208,    13,    41,
-     211,   212,     1,   214,   215,     4,     5,    41,     6,     8,
-     186,    13,     4,    12,    10,    21,   193,     1,    14,    18,
-      19,    20,     9,    22,     4,     9,    25,    26,    27,    28,
-      29,     4,     1,    32,    33,    34,    35,    36,     7,    41,
-      24,    10,    41,     8,     9,   221,   222,   223,     1,    55,
-      56,     5,     5,    36,    36,     8,     8,    24,    41,    41,
-     236,    13,   239,   240,    17,     6,    41,     5,   245,   246,
-     281,   282,   283,   284,    36,     4,     4,    30,    31,    41,
-      34,    35,    36,     4,     6,    38,    39,    40,    41,   265,
-       4,    24,   268,   269,   271,   272,    34,    35,    36,     1,
-       4,    41,     8,     5,    36,     3,     8,    13,     8,    41,
-       8,   287,     7,   289,   290,    17,    36,    15,    16,   296,
-     297,    41,    41,   300,   301,    23,    41,     7,    30,    31,
-      10,    41,     7,   310,   311,    10,    38,    39,    40,    41,
-       8,     6,   319,   320,   321,   322,     6,   324,   325,     8,
-       9,    41,    11,   203,    41,     6,   206,   334,     6,   336,
-      41,     8,   339,     8,     8,     6,   342,   344,   345,     1,
-     347,     6,     4,     5,    41,     1,     8,     8,     7,     5,
-      12,     8,     8,    41,    41,    41,    18,    19,    20,     8,
-      22,    17,     6,    25,    26,    27,    28,    29,     8,     1,
-      32,    33,     4,     5,    30,    31,     8,    41,     8,    41,
-      12,     8,    38,    39,    40,    41,    18,    19,    20,     6,
-      22,    41,    21,    25,    26,    27,    28,    29,     1,    21,
-      32,    33,     5,     1,    41,     8,    21,     5,    41,    41,
-       8,    11,     4,    41,    17,    24,    41,    11,     1,    17,
-       7,    41,     5,    41,    10,     8,    11,    30,    31,    41,
-      41,    41,    30,    31,    17,    38,    39,    40,    41,    41,
-      38,    39,    40,    41,    41,     1,    11,    30,    31,     5,
-      11,    41,     8,    41,    24,    38,    39,    40,    41,    11,
-       1,    17,     7,     7,     5,     7,    13,     8,    11,     8,
-      10,     8,     7,     4,    30,    31,    17,    13,     8,    13,
-      13,    13,    38,    39,    40,    41,    11,     4,     5,    30,
-      31,     8,    11,    41,     8,    12,     8,    38,    39,    40,
-      41,    18,    19,    20,    13,    22,    13,    13,    25,    26,
-      27,    28,    29,     4,     5,    32,    33,     8,    13,    13,
-      37,    12,     7,    13,    41,    13,    13,    18,    19,    20,
-      41,    22,     8,    13,    25,    26,    27,    28,    29,     4,
-       5,    32,    33,     8,     7,    13,    37,    12,     8,    13,
-      41,    13,     7,    18,    19,    20,     8,    22,     7,    25,
-      25,    26,    27,    28,    29,     4,     5,    32,    33,     8,
-     242,    93,    37,    12,   123,   174,    41,    -1,    62,    18,
-      19,    20,    -1,    22,    -1,    -1,    25,    26,    27,    28,
-      29,     4,    -1,    32,    33,     8,    -1,    -1,    37,    12,
-      -1,    -1,    41,    -1,    -1,    18,    19,    20,    -1,    22,
-      -1,    -1,    25,    26,    27,    28,    29,    -1,    -1,    32,
-      33,     0,     1,    -1,     3,    -1,    -1,    -1,    41,     8,
-      -1,    -1,    -1,    -1,    -1,    -1,    15,    16,    -1,    -1,
-      -1,    -1,    -1,    -1,    23
+      62,    97,   114,    41,    66,     1,     1,    13,     4,     5,
+       5,    74,     8,    75,     5,     1,    12,     1,    11,     5,
+       3,     5,    18,    19,    20,     5,    22,   219,     5,    25,
+      26,    27,    28,    29,   226,    41,    32,    33,    34,    35,
+      36,    36,   104,   105,   106,    41,    41,     1,    41,     5,
+      41,     5,   114,    13,   116,    41,    36,    41,     8,     9,
+       7,    41,   254,   255,    41,     1,   178,     7,     4,     5,
+      31,   134,     8,    10,   136,    38,    12,    14,    13,   142,
+      41,    41,    18,    19,    20,    41,    22,    41,     4,    25,
+      26,    27,    28,    29,    41,     0,    32,    33,    34,    35,
+      36,    41,     4,   199,   200,    41,    41,   203,   204,    72,
+     206,   207,     8,     9,     1,    11,   178,     4,     5,     9,
+      11,     8,   185,    14,     3,    12,    24,     7,     6,     8,
+      10,    18,    19,    20,     5,    22,    15,    16,    25,    26,
+      27,    28,    29,     5,    23,    32,    33,    34,    35,    36,
+      41,   213,     1,    36,    41,     8,     5,     8,    41,     8,
+      13,    36,    13,    34,    35,    36,    41,   229,    17,   232,
+     233,     4,    34,    35,    36,   238,   239,   273,   274,   275,
+     276,    30,    31,    10,     7,     1,    13,    10,     6,    38,
+      39,    40,    41,     9,   256,   160,   161,     1,   260,   261,
+     263,   264,    36,     7,     4,     1,    10,    41,    24,     5,
+      36,    10,     8,   195,    13,    41,   198,   279,     4,   281,
+     282,    17,     4,     4,    41,   288,   289,     6,    41,   292,
+     293,    24,     4,    41,    30,    31,    41,     8,    41,   302,
+     303,     7,    38,    39,    40,    41,     8,    41,   311,   312,
+     313,   314,    41,   316,   317,     6,     6,     6,     6,     6,
+      24,    41,     8,   326,     8,   328,     8,     6,   331,     6,
+       8,    41,   334,   336,   337,     1,   339,     7,     4,     5,
+      41,     1,     8,    41,     8,     5,    12,    41,     8,     8,
+       8,     8,    18,    19,    20,     8,    22,    17,    41,    25,
+      26,    27,    28,    29,     6,     1,    32,    33,     4,     5,
+      30,    31,     8,    21,    41,    41,    12,    11,    38,    39,
+      40,    41,    18,    19,    20,    41,    22,    41,     4,    25,
+      26,    27,    28,    29,     1,    41,    32,    33,     5,    11,
+      41,     8,     7,     0,     1,    41,     3,    11,    41,    41,
+      17,     8,    41,    41,    41,    41,    41,    11,    15,    16,
+      11,     4,     5,    30,    31,     8,    23,    41,    41,    12,
+      11,    38,    39,    40,    41,    18,    19,    20,    24,    22,
+       7,     7,    25,    26,    27,    28,    29,     4,     5,    32,
+      33,     8,     7,    13,    37,    12,    10,    10,    41,    11,
+       8,    18,    19,    20,    13,    22,     7,    13,    25,    26,
+      27,    28,    29,     4,     5,    32,    33,     8,     8,     8,
+      37,    12,     4,    41,    41,    13,    11,    18,    19,    20,
+      13,    22,    11,    13,    25,    26,    27,    28,    29,     4,
+       5,    32,    33,     8,    13,    13,    37,    12,     8,    13,
+      41,    13,    13,    18,    19,    20,     8,    22,    13,     7,
+      25,    26,    27,    28,    29,     4,    13,    32,    33,     8,
+      41,     8,    37,    12,     7,    13,    41,    13,    13,    18,
+      19,    20,    13,    22,     8,     7,    25,    26,    27,    28,
+      29,     8,     7,    32,    33,    25,    17,   166,    52,   235,
+     116,    58,    41,    -1,    -1,    86
 };
 
 /* YYSTOS[STATE-NUM] -- The (internal number of the) accessing
    symbol of state STATE-NUM.  */
 static const unsigned char yystos[] =
 {
-       0,     3,     8,    15,    16,    23,    43,    44,    45,    46,
-      47,    48,    36,    41,    41,     4,     3,     0,     1,    45,
-       4,     4,     6,     5,    41,    49,    50,    36,    41,     1,
-       5,     8,    17,    30,    31,    38,    39,    40,    41,    53,
-      54,    56,    57,    88,    89,    93,     5,    53,     7,    41,
-      52,     9,     1,     5,    50,     4,     4,    24,    31,    41,
-       6,     4,     4,     4,     1,     9,    24,     1,     5,    54,
-       5,     4,     1,     7,    10,    51,     5,    53,     5,    53,
-      41,     6,    24,    41,    65,     5,    41,    90,     5,    90,
-       5,    36,    41,    91,    92,    55,     4,     8,    12,    18,
-      19,    20,    22,    25,    26,    27,    28,    29,    32,    33,
-      41,    59,    61,    63,    67,    69,    80,    82,     5,    37,
-      69,    86,    87,     4,    41,    41,     5,     5,     8,    65,
-      69,    41,     7,     8,     1,     5,    41,     5,     1,     5,
-      92,     8,    13,    41,    58,    69,    41,    78,     6,     6,
-       6,     6,    36,    41,    66,    76,    66,    77,     8,     8,
-       8,     6,     6,     8,     9,    11,    81,    69,    69,    69,
-       5,    34,    35,    36,    84,    85,     7,    41,    64,    83,
-       8,     9,    41,     5,    87,     5,    86,     8,     7,    41,
-      41,     8,     8,    13,    41,    65,     8,     1,     5,    69,
-       6,     8,    68,    60,    41,    65,    62,    10,    13,    11,
-      41,    10,    13,     8,    10,    14,     8,    71,    74,    70,
-       6,    21,    21,    21,    41,    41,    11,     5,    85,    41,
-       7,    10,    75,     4,     5,    41,    24,    41,    65,    13,
-      11,     7,    79,    41,    64,    13,    11,    64,    66,    66,
-      41,    66,    66,    41,    66,    36,    66,    41,    41,    41,
-      69,    69,    69,    11,    11,    58,    41,    41,    58,    24,
-      69,    13,    11,    65,    65,    83,     7,     7,    65,    65,
-       7,    10,    13,    10,    13,    14,     8,     7,     8,    58,
-      58,     8,     5,    69,    65,    65,    13,    11,     7,     4,
-      13,    11,    66,    66,    66,    66,    36,    41,    72,    69,
-      13,    11,    65,    65,    65,    65,    41,    65,    65,    13,
-      13,    13,    13,     8,    13,    13,    65,    65,    65,    65,
-      73,    65,    65,     8,    13,     7,    13,    41,     8,    13,
-      65,    65,     7,    65,    13,    13,    69,    13,    65,    65,
-      65,     8,     7,     8
+       0,     3,     8,    15,    16,    23,    43,    44,    45,    47,
+      48,    49,    36,    41,    46,    41,     4,     3,     0,     1,
+      45,     4,     6,     5,    41,    50,    51,    46,     1,     5,
+       8,    17,    30,    31,    38,    39,    40,    41,    54,    55,
+      57,    58,    91,    92,    96,     7,    41,    53,     9,     1,
+       5,    51,     4,    24,    31,    41,     6,     4,     4,     4,
+       1,     9,    24,     1,     5,    55,     4,     1,     7,    10,
+      52,     5,    54,    41,     6,    24,    41,    66,     5,    41,
+      93,     5,    93,     5,    36,    41,    94,    95,    56,     4,
+       8,    12,    18,    19,    20,    22,    25,    26,    27,    28,
+      29,    32,    33,    41,    60,    62,    64,    68,    70,    82,
+      84,     5,    37,    70,    89,    90,     4,    41,    41,     5,
+       8,    66,    70,    41,     7,     8,     1,     5,    41,     5,
+       1,     5,    95,     8,    13,    41,    59,    70,    41,    80,
+       6,     6,     6,     6,    36,    41,    67,    78,    67,    79,
+       8,     8,     8,     6,     6,     8,     9,    11,    83,    70,
+      70,    70,     5,    34,    35,    36,    87,    88,     7,    41,
+      65,    86,     8,     9,    41,     5,    90,     5,    89,     8,
+       7,    41,    41,     8,     8,    13,    41,    66,     8,     1,
+       5,    70,     6,     8,    69,    61,    41,    66,    63,    10,
+      13,    11,    41,    10,    13,     8,    10,    14,     8,    72,
+      75,    71,     6,    21,    77,    77,    77,    41,    41,    11,
+       5,    88,    41,     7,    10,    76,     4,     5,    41,    24,
+      41,    66,    13,    11,     7,    81,    41,    65,    13,    11,
+      65,    67,    67,    41,    67,    67,    41,    67,    36,    67,
+      41,    41,    41,    70,    11,    11,    59,    41,    85,    41,
+      59,    24,    70,    13,    11,    66,    66,    86,     7,     7,
+      66,    66,     7,    10,    13,    10,    13,    14,     8,     7,
+       8,    59,    59,     8,     5,    70,    66,    66,    13,    11,
+       7,     4,    13,    11,    67,    67,    67,    67,    36,    41,
+      73,    70,    13,    11,    66,    66,    66,    66,    41,    66,
+      66,    13,    13,    13,    13,     8,    13,    13,    66,    66,
+      66,    66,    74,    66,    66,     8,    13,     7,    13,    41,
+       8,    13,    66,    66,     7,    66,    13,    13,    70,    13,
+      66,    66,    66,     8,     7,     8
 };
 
 #define yyerrok		(yyerrstatus = 0)
@@ -1313,293 +1288,311 @@
   switch (yytype)
     {
       case 41: /* &quot;word&quot; */
-#line 152 &quot;ael.y&quot;
+#line 160 &quot;ael.y&quot;
         { free((yyvaluep-&gt;str));};
-#line 1319 &quot;ael.tab.c&quot;
+#line 1294 &quot;ael.tab.c&quot;
         break;
       case 44: /* &quot;objects&quot; */
-#line 141 &quot;ael.y&quot;
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1327 &quot;ael.tab.c&quot;
+#line 1302 &quot;ael.tab.c&quot;
         break;
       case 45: /* &quot;object&quot; */
-#line 141 &quot;ael.y&quot;
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1335 &quot;ael.tab.c&quot;
+#line 1310 &quot;ael.tab.c&quot;
         break;
-      case 46: /* &quot;context&quot; */
-#line 141 &quot;ael.y&quot;
+      case 46: /* &quot;word_or_default&quot; */
+#line 160 &quot;ael.y&quot;
+        { free((yyvaluep-&gt;str));};
+#line 1315 &quot;ael.tab.c&quot;
+        break;
+      case 47: /* &quot;context&quot; */
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1343 &quot;ael.tab.c&quot;
+#line 1323 &quot;ael.tab.c&quot;
         break;
-      case 47: /* &quot;macro&quot; */
-#line 141 &quot;ael.y&quot;
+      case 48: /* &quot;macro&quot; */
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1351 &quot;ael.tab.c&quot;
+#line 1331 &quot;ael.tab.c&quot;
         break;
-      case 48: /* &quot;globals&quot; */
-#line 141 &quot;ael.y&quot;
+      case 49: /* &quot;globals&quot; */
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1359 &quot;ael.tab.c&quot;
+#line 1339 &quot;ael.tab.c&quot;
         break;
-      case 49: /* &quot;global_statements&quot; */
-#line 141 &quot;ael.y&quot;
+      case 50: /* &quot;global_statements&quot; */
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1367 &quot;ael.tab.c&quot;
+#line 1347 &quot;ael.tab.c&quot;
         break;
-      case 50: /* &quot;global_statement&quot; */
-#line 141 &quot;ael.y&quot;
+      case 51: /* &quot;global_statement&quot; */
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1375 &quot;ael.tab.c&quot;
+#line 1355 &quot;ael.tab.c&quot;
         break;
-      case 52: /* &quot;arglist&quot; */
-#line 141 &quot;ael.y&quot;
+      case 53: /* &quot;arglist&quot; */
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1383 &quot;ael.tab.c&quot;
+#line 1363 &quot;ael.tab.c&quot;
         break;
-      case 53: /* &quot;elements&quot; */
-#line 141 &quot;ael.y&quot;
+      case 54: /* &quot;elements&quot; */
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1391 &quot;ael.tab.c&quot;
+#line 1371 &quot;ael.tab.c&quot;
         break;
-      case 54: /* &quot;element&quot; */
-#line 141 &quot;ael.y&quot;
+      case 55: /* &quot;element&quot; */
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1399 &quot;ael.tab.c&quot;
+#line 1379 &quot;ael.tab.c&quot;
         break;
-      case 56: /* &quot;ignorepat&quot; */
-#line 141 &quot;ael.y&quot;
+      case 57: /* &quot;ignorepat&quot; */
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1407 &quot;ael.tab.c&quot;
+#line 1387 &quot;ael.tab.c&quot;
         break;
-      case 57: /* &quot;extension&quot; */
-#line 141 &quot;ael.y&quot;
+      case 58: /* &quot;extension&quot; */
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1415 &quot;ael.tab.c&quot;
+#line 1395 &quot;ael.tab.c&quot;
         break;
-      case 58: /* &quot;statements&quot; */
-#line 141 &quot;ael.y&quot;
+      case 59: /* &quot;statements&quot; */
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1423 &quot;ael.tab.c&quot;
+#line 1403 &quot;ael.tab.c&quot;
         break;
-      case 59: /* &quot;if_head&quot; */
-#line 141 &quot;ael.y&quot;
+      case 60: /* &quot;if_head&quot; */
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1431 &quot;ael.tab.c&quot;
+#line 1411 &quot;ael.tab.c&quot;
         break;
-      case 61: /* &quot;random_head&quot; */
-#line 141 &quot;ael.y&quot;
+      case 62: /* &quot;random_head&quot; */
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1439 &quot;ael.tab.c&quot;
+#line 1419 &quot;ael.tab.c&quot;
         break;
-      case 63: /* &quot;iftime_head&quot; */
-#line 141 &quot;ael.y&quot;
+      case 64: /* &quot;iftime_head&quot; */
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1447 &quot;ael.tab.c&quot;
+#line 1427 &quot;ael.tab.c&quot;
         break;
-      case 64: /* &quot;word_list&quot; */
-#line 152 &quot;ael.y&quot;
+      case 65: /* &quot;word_list&quot; */
+#line 160 &quot;ael.y&quot;
         { free((yyvaluep-&gt;str));};
-#line 1452 &quot;ael.tab.c&quot;
+#line 1432 &quot;ael.tab.c&quot;
         break;
-      case 65: /* &quot;word3_list&quot; */
-#line 152 &quot;ael.y&quot;
+      case 66: /* &quot;word3_list&quot; */
+#line 160 &quot;ael.y&quot;
         { free((yyvaluep-&gt;str));};
-#line 1457 &quot;ael.tab.c&quot;
+#line 1437 &quot;ael.tab.c&quot;
         break;
-      case 66: /* &quot;goto_word&quot; */
-#line 152 &quot;ael.y&quot;
+      case 67: /* &quot;goto_word&quot; */
+#line 160 &quot;ael.y&quot;
         { free((yyvaluep-&gt;str));};
-#line 1462 &quot;ael.tab.c&quot;
+#line 1442 &quot;ael.tab.c&quot;
         break;
-      case 67: /* &quot;switch_head&quot; */
-#line 141 &quot;ael.y&quot;
+      case 68: /* &quot;switch_head&quot; */
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1470 &quot;ael.tab.c&quot;
+#line 1450 &quot;ael.tab.c&quot;
         break;
-      case 69: /* &quot;statement&quot; */
-#line 141 &quot;ael.y&quot;
+      case 70: /* &quot;statement&quot; */
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1478 &quot;ael.tab.c&quot;
+#line 1458 &quot;ael.tab.c&quot;
         break;
-      case 76: /* &quot;target&quot; */
-#line 141 &quot;ael.y&quot;
+      case 77: /* &quot;opt_else&quot; */
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1486 &quot;ael.tab.c&quot;
+#line 1466 &quot;ael.tab.c&quot;
         break;
-      case 77: /* &quot;jumptarget&quot; */
-#line 141 &quot;ael.y&quot;
+      case 78: /* &quot;target&quot; */
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1494 &quot;ael.tab.c&quot;
+#line 1474 &quot;ael.tab.c&quot;
         break;
-      case 78: /* &quot;macro_call&quot; */
-#line 141 &quot;ael.y&quot;
+      case 79: /* &quot;jumptarget&quot; */
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1502 &quot;ael.tab.c&quot;
+#line 1482 &quot;ael.tab.c&quot;
         break;
-      case 80: /* &quot;application_call_head&quot; */
-#line 141 &quot;ael.y&quot;
+      case 80: /* &quot;macro_call&quot; */
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1510 &quot;ael.tab.c&quot;
+#line 1490 &quot;ael.tab.c&quot;
         break;
-      case 82: /* &quot;application_call&quot; */
-#line 141 &quot;ael.y&quot;
+      case 82: /* &quot;application_call_head&quot; */
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1518 &quot;ael.tab.c&quot;
+#line 1498 &quot;ael.tab.c&quot;
         break;
-      case 83: /* &quot;eval_arglist&quot; */
-#line 141 &quot;ael.y&quot;
+      case 84: /* &quot;application_call&quot; */
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1526 &quot;ael.tab.c&quot;
+#line 1506 &quot;ael.tab.c&quot;
         break;
-      case 84: /* &quot;case_statements&quot; */
-#line 141 &quot;ael.y&quot;
+      case 85: /* &quot;opt_word&quot; */
+#line 160 &quot;ael.y&quot;
+        { free((yyvaluep-&gt;str));};
+#line 1511 &quot;ael.tab.c&quot;
+        break;
+      case 86: /* &quot;eval_arglist&quot; */
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1534 &quot;ael.tab.c&quot;
+#line 1519 &quot;ael.tab.c&quot;
         break;
-      case 85: /* &quot;case_statement&quot; */
-#line 141 &quot;ael.y&quot;
+      case 87: /* &quot;case_statements&quot; */
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1542 &quot;ael.tab.c&quot;
+#line 1527 &quot;ael.tab.c&quot;
         break;
-      case 86: /* &quot;macro_statements&quot; */
-#line 141 &quot;ael.y&quot;
+      case 88: /* &quot;case_statement&quot; */
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1550 &quot;ael.tab.c&quot;
+#line 1535 &quot;ael.tab.c&quot;
         break;
-      case 87: /* &quot;macro_statement&quot; */
-#line 141 &quot;ael.y&quot;
+      case 89: /* &quot;macro_statements&quot; */
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1558 &quot;ael.tab.c&quot;
+#line 1543 &quot;ael.tab.c&quot;
         break;
-      case 88: /* &quot;switches&quot; */
-#line 141 &quot;ael.y&quot;
+      case 90: /* &quot;macro_statement&quot; */
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1566 &quot;ael.tab.c&quot;
+#line 1551 &quot;ael.tab.c&quot;
         break;
-      case 89: /* &quot;eswitches&quot; */
-#line 141 &quot;ael.y&quot;
+      case 91: /* &quot;switches&quot; */
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1574 &quot;ael.tab.c&quot;
+#line 1559 &quot;ael.tab.c&quot;
         break;
-      case 90: /* &quot;switchlist&quot; */
-#line 141 &quot;ael.y&quot;
+      case 92: /* &quot;eswitches&quot; */
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1582 &quot;ael.tab.c&quot;
+#line 1567 &quot;ael.tab.c&quot;
         break;
-      case 91: /* &quot;includeslist&quot; */
-#line 141 &quot;ael.y&quot;
+      case 93: /* &quot;switchlist&quot; */
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1590 &quot;ael.tab.c&quot;
+#line 1575 &quot;ael.tab.c&quot;
         break;
-      case 92: /* &quot;includedname&quot; */
-#line 152 &quot;ael.y&quot;
+      case 94: /* &quot;includeslist&quot; */
+#line 148 &quot;ael.y&quot;
+        {
+		destroy_pval((yyvaluep-&gt;pval));
+		prev_word=0;
+	};
+#line 1583 &quot;ael.tab.c&quot;
+        break;
+      case 95: /* &quot;includedname&quot; */
+#line 160 &quot;ael.y&quot;
         { free((yyvaluep-&gt;str));};
-#line 1595 &quot;ael.tab.c&quot;
+#line 1588 &quot;ael.tab.c&quot;
         break;
-      case 93: /* &quot;includes&quot; */
-#line 141 &quot;ael.y&quot;
+      case 96: /* &quot;includes&quot; */
+#line 148 &quot;ael.y&quot;
         {
 		destroy_pval((yyvaluep-&gt;pval));
 		prev_word=0;
 	};
-#line 1603 &quot;ael.tab.c&quot;
+#line 1596 &quot;ael.tab.c&quot;
         break;
 
       default:
@@ -1916,17 +1909,17 @@
   switch (yyn)
     {
         case 2:
-#line 157 &quot;ael.y&quot;
+#line 165 &quot;ael.y&quot;
     { (yyval.pval) = parseio-&gt;pval = (yyvsp[0].pval); ;}
     break;
 
   case 3:
-#line 160 &quot;ael.y&quot;
+#line 168 &quot;ael.y&quot;
     {(yyval.pval)=(yyvsp[0].pval);;}
     break;
 
   case 4:
-#line 162 &quot;ael.y&quot;
+#line 170 &quot;ael.y&quot;
     {
 			if ( (yyvsp[-1].pval) &amp;&amp; (yyvsp[0].pval) ) {
 				(yyval.pval)=(yyvsp[-1].pval);
@@ -1940,62 +1933,57 @@
     break;
 
   case 5:
-#line 172 &quot;ael.y&quot;
+#line 180 &quot;ael.y&quot;
     {(yyval.pval)=(yyvsp[-1].pval);;}
     break;
 
   case 6:
-#line 175 &quot;ael.y&quot;
+#line 183 &quot;ael.y&quot;
     {(yyval.pval)=(yyvsp[0].pval);;}
     break;
 
   case 7:
-#line 176 &quot;ael.y&quot;
+#line 184 &quot;ael.y&quot;
     {(yyval.pval)=(yyvsp[0].pval);;}
     break;
 
   case 8:
-#line 177 &quot;ael.y&quot;
+#line 185 &quot;ael.y&quot;
     {(yyval.pval)=(yyvsp[0].pval);;}
     break;
 
   case 9:
-#line 178 &quot;ael.y&quot;
+#line 186 &quot;ael.y&quot;
     {(yyval.pval)=0;/* allow older docs to be read */;}
     break;
 
   case 10:
-#line 181 &quot;ael.y&quot;
-    {
-		(yyval.pval) = npval2(PV_CONTEXT, &amp;(yylsp[-4]), &amp;(yylsp[0]));
-		(yyval.pval)-&gt;u1.str = (yyvsp[-3].str);
-		(yyval.pval)-&gt;u2.statements = (yyvsp[-1].pval); ;}
+#line 189 &quot;ael.y&quot;
+    { (yyval.str) = (yyvsp[0].str); ;}
     break;
 
   case 11:
-#line 185 &quot;ael.y&quot;
-    {
-		(yyval.pval) = npval2(PV_CONTEXT, &amp;(yylsp[-3]), &amp;(yylsp[0]));
-		(yyval.pval)-&gt;u1.str = (yyvsp[-2].str); ;}
+#line 190 &quot;ael.y&quot;
+    { (yyval.str) = strdup(&quot;default&quot;); ;}
     break;
 
   case 12:
-#line 188 &quot;ael.y&quot;
+#line 193 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_CONTEXT, &amp;(yylsp[-4]), &amp;(yylsp[0]));
-		(yyval.pval)-&gt;u1.str = strdup(&quot;default&quot;);
+		(yyval.pval)-&gt;u1.str = (yyvsp[-3].str);
 		(yyval.pval)-&gt;u2.statements = (yyvsp[-1].pval); ;}
     break;
 
   case 13:
-#line 192 &quot;ael.y&quot;
+#line 197 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_CONTEXT, &amp;(yylsp[-3]), &amp;(yylsp[0]));
-		(yyval.pval)-&gt;u1.str = strdup(&quot;default&quot;); ;}
+		(yyval.pval)-&gt;u1.str = (yyvsp[-2].str); ;}
     break;
 
   case 14:
-#line 195 &quot;ael.y&quot;
+#line 200 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_CONTEXT, &amp;(yylsp[-5]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[-3].str);
@@ -2004,7 +1992,7 @@
     break;
 
   case 15:
-#line 200 &quot;ael.y&quot;
+#line 205 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_CONTEXT, &amp;(yylsp[-4]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[-2].str);
@@ -2012,200 +2000,182 @@
     break;
 
   case 16:
-#line 204 &quot;ael.y&quot;
+#line 229 &quot;ael.y&quot;
     {
-		(yyval.pval) = npval2(PV_CONTEXT, &amp;(yylsp[-5]), &amp;(yylsp[0]));
-		(yyval.pval)-&gt;u1.str = strdup(&quot;default&quot;);
-		(yyval.pval)-&gt;u2.statements = (yyvsp[-1].pval);
-		(yyval.pval)-&gt;u3.abstract = 1; ;}
-    break;
-
-  case 17:
-#line 209 &quot;ael.y&quot;
-    {
-		(yyval.pval) = npval2(PV_CONTEXT, &amp;(yylsp[-4]), &amp;(yylsp[0]));
-		(yyval.pval)-&gt;u1.str = strdup(&quot;default&quot;);
-		(yyval.pval)-&gt;u3.abstract = 1; ;}
-    break;
-
-  case 18:
-#line 215 &quot;ael.y&quot;
-    {
 		(yyval.pval) = npval2(PV_MACRO, &amp;(yylsp[-7]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[-6].str); (yyval.pval)-&gt;u2.arglist = (yyvsp[-4].pval); (yyval.pval)-&gt;u3.macro_statements = (yyvsp[-1].pval); ;}
     break;
 
-  case 19:
-#line 218 &quot;ael.y&quot;
+  case 17:
+#line 232 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_MACRO, &amp;(yylsp[-6]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[-5].str); (yyval.pval)-&gt;u2.arglist = (yyvsp[-3].pval); ;}
     break;
 
-  case 20:
-#line 221 &quot;ael.y&quot;
+  case 18:
+#line 235 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_MACRO, &amp;(yylsp[-6]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[-5].str);
 		(yyval.pval)-&gt;u3.macro_statements = (yyvsp[-1].pval); ;}
     break;
 
-  case 21:
-#line 225 &quot;ael.y&quot;
+  case 19:
+#line 239 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_MACRO, &amp;(yylsp[-5]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[-4].str); ;}
     break;
 
-  case 22:
-#line 230 &quot;ael.y&quot;
+  case 20:
+#line 244 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_GLOBALS, &amp;(yylsp[-3]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.statements = (yyvsp[-1].pval);;}
     break;
 
-  case 23:
-#line 233 &quot;ael.y&quot;
+  case 21:
+#line 247 &quot;ael.y&quot;
     { /* empty globals is OK */
 		(yyval.pval) = npval2(PV_GLOBALS, &amp;(yylsp[-2]), &amp;(yylsp[0])); ;}
     break;
 
-  case 24:
-#line 237 &quot;ael.y&quot;
+  case 22:
+#line 251 &quot;ael.y&quot;
     {(yyval.pval)=(yyvsp[0].pval);;}
     break;
 
-  case 25:
-#line 238 &quot;ael.y&quot;
+  case 23:
+#line 252 &quot;ael.y&quot;
     {(yyval.pval)=(yyvsp[-1].pval); linku1((yyval.pval),(yyvsp[0].pval));;}
     break;
 
-  case 26:
-#line 239 &quot;ael.y&quot;
+  case 24:
+#line 253 &quot;ael.y&quot;
     {(yyval.pval)=(yyvsp[-1].pval);;}
     break;
 
-  case 27:
-#line 242 &quot;ael.y&quot;
+  case 25:
+#line 256 &quot;ael.y&quot;
     { reset_semicount(parseio-&gt;scanner); ;}
     break;
 
-  case 28:
-#line 242 &quot;ael.y&quot;
+  case 26:
+#line 256 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_VARDEC, &amp;(yylsp[-4]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[-4].str);
 		(yyval.pval)-&gt;u2.val = (yyvsp[-1].str); ;}
     break;
 
-  case 29:
-#line 248 &quot;ael.y&quot;
+  case 27:
+#line 262 &quot;ael.y&quot;
     {
 		(yyval.pval)= npval2(PV_WORD, &amp;(yylsp[0]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[0].str); ;}
     break;
 
-  case 30:
-#line 251 &quot;ael.y&quot;
+  case 28:
+#line 265 &quot;ael.y&quot;
     {
 		pval *z = npval2(PV_WORD, &amp;(yylsp[-2]), &amp;(yylsp[0]));
 		z-&gt;u1.str = (yyvsp[0].str);
-		(yyval.pval)=(yyvsp[-2].pval);
-		linku1((yyval.pval),z); ;}
+		(yyval.pval) = linku1((yyvsp[-2].pval),z); ;}
     break;
 
-  case 31:
-#line 256 &quot;ael.y&quot;
+  case 29:
+#line 269 &quot;ael.y&quot;
     {(yyval.pval)=(yyvsp[-1].pval);;}
     break;
 
-  case 32:
-#line 259 &quot;ael.y&quot;
+  case 30:
+#line 272 &quot;ael.y&quot;
     { (yyval.pval)=(yyvsp[0].pval);;}
     break;
 
-  case 33:
-#line 260 &quot;ael.y&quot;
+  case 31:
+#line 273 &quot;ael.y&quot;
     {(yyval.pval)=0;;}
     break;
 
-  case 34:
-#line 261 &quot;ael.y&quot;
+  case 32:
+#line 274 &quot;ael.y&quot;
     { if ( (yyvsp[-1].pval) &amp;&amp; (yyvsp[0].pval) ) {(yyval.pval)=(yyvsp[-1].pval); linku1((yyval.pval),(yyvsp[0].pval));}
 				else if ( (yyvsp[-1].pval) ) {(yyval.pval)=(yyvsp[-1].pval);}
 				else if ( (yyvsp[0].pval) ) {(yyval.pval)=(yyvsp[0].pval);} ;}
     break;
 
-  case 35:
-#line 264 &quot;ael.y&quot;
+  case 33:
+#line 277 &quot;ael.y&quot;
     { (yyval.pval)=(yyvsp[-1].pval);;}
     break;
 
-  case 36:
-#line 267 &quot;ael.y&quot;
+  case 34:
+#line 280 &quot;ael.y&quot;
     {(yyval.pval)=(yyvsp[0].pval);;}
     break;
 
-  case 37:
-#line 268 &quot;ael.y&quot;
+  case 35:
+#line 281 &quot;ael.y&quot;
     {(yyval.pval)=(yyvsp[0].pval);;}
     break;
 
-  case 38:
-#line 269 &quot;ael.y&quot;
+  case 36:
+#line 282 &quot;ael.y&quot;
     {(yyval.pval)=(yyvsp[0].pval);;}
     break;
 
-  case 39:
-#line 270 &quot;ael.y&quot;
+  case 37:
+#line 283 &quot;ael.y&quot;
     {(yyval.pval)=(yyvsp[0].pval);;}
     break;
 
-  case 40:
-#line 271 &quot;ael.y&quot;
+  case 38:
+#line 284 &quot;ael.y&quot;
     {(yyval.pval)=(yyvsp[0].pval);;}
     break;
 
-  case 41:
-#line 272 &quot;ael.y&quot;
+  case 39:
+#line 285 &quot;ael.y&quot;
     { reset_semicount(parseio-&gt;scanner); ;}
     break;
 
-  case 42:
-#line 272 &quot;ael.y&quot;
+  case 40:
+#line 285 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_VARDEC, &amp;(yylsp[-4]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[-4].str);
 		(yyval.pval)-&gt;u2.val = (yyvsp[-1].str); ;}
     break;
 
-  case 43:
-#line 276 &quot;ael.y&quot;
+  case 41:
+#line 289 &quot;ael.y&quot;
     {free((yyvsp[-1].str)); (yyval.pval)=0;;}
     break;
 
-  case 44:
-#line 277 &quot;ael.y&quot;
+  case 42:
+#line 290 &quot;ael.y&quot;
     {(yyval.pval)=0;/* allow older docs to be read */;}
     break;
 
-  case 45:
-#line 280 &quot;ael.y&quot;
+  case 43:
+#line 293 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_IGNOREPAT, &amp;(yylsp[-3]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[-1].str);;}
     break;
 
-  case 46:
-#line 285 &quot;ael.y&quot;
+  case 44:
+#line 298 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_EXTENSION, &amp;(yylsp[-2]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[-2].str);
 		(yyval.pval)-&gt;u2.statements = (yyvsp[0].pval); ;}
     break;
 
-  case 47:
-#line 289 &quot;ael.y&quot;
+  case 45:
+#line 302 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_EXTENSION, &amp;(yylsp[-3]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[-2].str);
@@ -2213,8 +2183,8 @@
 		(yyval.pval)-&gt;u4.regexten=1;;}
     break;
 
-  case 48:
-#line 294 &quot;ael.y&quot;
+  case 46:
+#line 307 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_EXTENSION, &amp;(yylsp[-6]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[-2].str);
@@ -2222,8 +2192,8 @@
 		(yyval.pval)-&gt;u3.hints = (yyvsp[-4].str);;}
     break;
 
-  case 49:
-#line 299 &quot;ael.y&quot;
+  case 47:
+#line 312 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_EXTENSION, &amp;(yylsp[-7]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[-2].str);
@@ -2232,49 +2202,49 @@
 		(yyval.pval)-&gt;u3.hints = (yyvsp[-4].str);;}
     break;
 
-  case 50:
-#line 308 &quot;ael.y&quot;
+  case 48:
+#line 321 &quot;ael.y&quot;
     {(yyval.pval)=(yyvsp[0].pval);;}
     break;
 
-  case 51:
-#line 309 &quot;ael.y&quot;
+  case 49:
+#line 322 &quot;ael.y&quot;
     {if ( (yyvsp[-1].pval) &amp;&amp; (yyvsp[0].pval) ) {(yyval.pval)=(yyvsp[-1].pval); linku1((yyval.pval),(yyvsp[0].pval));}
 						 else if ( (yyvsp[-1].pval) ) {(yyval.pval)=(yyvsp[-1].pval);}
 						 else if ( (yyvsp[0].pval) ) {(yyval.pval)=(yyvsp[0].pval);} ;}
     break;
 
-  case 52:
-#line 312 &quot;ael.y&quot;
+  case 50:
+#line 325 &quot;ael.y&quot;
     {(yyval.pval)=(yyvsp[-1].pval);;}
     break;
 
-  case 53:
-#line 315 &quot;ael.y&quot;
+  case 51:
+#line 328 &quot;ael.y&quot;
     { reset_parencount(parseio-&gt;scanner); ;}
     break;
 
-  case 54:
-#line 315 &quot;ael.y&quot;
+  case 52:
+#line 328 &quot;ael.y&quot;
     {
 		(yyval.pval)= npval2(PV_IF, &amp;(yylsp[-4]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[-1].str); ;}
     break;
 
-  case 55:
-#line 320 &quot;ael.y&quot;
+  case 53:
+#line 333 &quot;ael.y&quot;
     { reset_parencount(parseio-&gt;scanner); ;}
     break;
 
-  case 56:
-#line 320 &quot;ael.y&quot;
+  case 54:
+#line 333 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_RANDOM, &amp;(yylsp[-4]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.str=(yyvsp[-1].str);;}
     break;
 
-  case 57:
-#line 326 &quot;ael.y&quot;
+  case 55:
+#line 339 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_IFTIME, &amp;(yylsp[-13]), &amp;(yylsp[-9])); /* XXX really @5 or more ? */
 		(yyval.pval)-&gt;u1.list = npval2(PV_WORD, &amp;(yylsp[-11]), &amp;(yylsp[-11]));
@@ -2292,8 +2262,8 @@
 	;}
     break;
 
-  case 58:
-#line 341 &quot;ael.y&quot;
+  case 56:
+#line 354 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_IFTIME, &amp;(yylsp[-9]), &amp;(yylsp[-5])); /* XXX @5 or greater ? */
 		(yyval.pval)-&gt;u1.list = npval2(PV_WORD, &amp;(yylsp[-7]), &amp;(yylsp[-7]));
@@ -2308,13 +2278,13 @@
 	;}
     break;
 
-  case 59:
-#line 361 &quot;ael.y&quot;
+  case 57:
+#line 374 &quot;ael.y&quot;
     { (yyval.str) = (yyvsp[0].str);;}
     break;
 
-  case 60:
-#line 362 &quot;ael.y&quot;
+  case 58:
+#line 375 &quot;ael.y&quot;
     {
 		asprintf(&amp;((yyval.str)), &quot;%s%s&quot;, (yyvsp[-1].str), (yyvsp[0].str));
 		free((yyvsp[-1].str));
@@ -2322,13 +2292,13 @@
 		prev_word = (yyval.str);;}
     break;
 
-  case 61:
-#line 369 &quot;ael.y&quot;
+  case 59:
+#line 382 &quot;ael.y&quot;
     { (yyval.str) = (yyvsp[0].str);;}
     break;
 
-  case 62:
-#line 370 &quot;ael.y&quot;
+  case 60:
+#line 383 &quot;ael.y&quot;
     {
 		asprintf(&amp;((yyval.str)), &quot;%s%s&quot;, (yyvsp[-1].str), (yyvsp[0].str));
 		free((yyvsp[-1].str));
@@ -2336,8 +2306,8 @@
 		prev_word = (yyval.str);;}
     break;
 
-  case 63:
-#line 375 &quot;ael.y&quot;
+  case 61:
+#line 388 &quot;ael.y&quot;
     {
 		asprintf(&amp;((yyval.str)), &quot;%s%s%s&quot;, (yyvsp[-2].str), (yyvsp[-1].str), (yyvsp[0].str));
 		free((yyvsp[-2].str));
@@ -2346,97 +2316,97 @@
 		prev_word=(yyval.str);;}
     break;
 
-  case 64:
-#line 383 &quot;ael.y&quot;
+  case 62:
+#line 396 &quot;ael.y&quot;
     { (yyval.str) = (yyvsp[0].str);;}
     break;
 
-  case 65:
-#line 384 &quot;ael.y&quot;
+  case 63:
+#line 397 &quot;ael.y&quot;
     {
 		asprintf(&amp;((yyval.str)), &quot;%s%s&quot;, (yyvsp[-1].str), (yyvsp[0].str));
 		free((yyvsp[-1].str));
 		free((yyvsp[0].str));;}
     break;
 
-  case 66:
-#line 388 &quot;ael.y&quot;
+  case 64:
+#line 401 &quot;ael.y&quot;
     {
 		asprintf(&amp;((yyval.str)), &quot;%s:%s&quot;, (yyvsp[-2].str), (yyvsp[0].str));
 		free((yyvsp[-2].str));
 		free((yyvsp[0].str));;}
     break;
 
-  case 67:
-#line 394 &quot;ael.y&quot;
+  case 65:
+#line 407 &quot;ael.y&quot;
     { reset_parencount(parseio-&gt;scanner); ;}
     break;
 
-  case 68:
-#line 394 &quot;ael.y&quot;
+  case 66:
+#line 407 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_SWITCH, &amp;(yylsp[-5]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[-2].str); ;}
     break;
 
-  case 69:
-#line 402 &quot;ael.y&quot;
+  case 67:
+#line 415 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_STATEMENTBLOCK, &amp;(yylsp[-2]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.list = (yyvsp[-1].pval); ;}
     break;
 
-  case 70:
-#line 405 &quot;ael.y&quot;
+  case 68:
+#line 418 &quot;ael.y&quot;
     {reset_semicount(parseio-&gt;scanner);;}
     break;
 
-  case 71:
-#line 405 &quot;ael.y&quot;
+  case 69:
+#line 418 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_VARDEC, &amp;(yylsp[-4]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[-4].str);
 		(yyval.pval)-&gt;u2.val = (yyvsp[-1].str); ;}
     break;
 
-  case 72:
-#line 409 &quot;ael.y&quot;
+  case 70:
+#line 422 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_GOTO, &amp;(yylsp[-2]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.list = (yyvsp[-1].pval);;}
     break;
 
-  case 73:
-#line 412 &quot;ael.y&quot;
+  case 71:
+#line 425 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_GOTO, &amp;(yylsp[-2]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.list = (yyvsp[-1].pval);;}
     break;
 
-  case 74:
-#line 415 &quot;ael.y&quot;
+  case 72:
+#line 428 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_LABEL, &amp;(yylsp[-1]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[-1].str); ;}
     break;
 
-  case 75:
-#line 418 &quot;ael.y&quot;
+  case 73:
+#line 431 &quot;ael.y&quot;
     {reset_semicount(parseio-&gt;scanner);;}
     break;
 
-  case 76:
-#line 419 &quot;ael.y&quot;
+  case 74:
+#line 432 &quot;ael.y&quot;
     {reset_semicount(parseio-&gt;scanner);;}
     break;
 
-  case 77:
-#line 420 &quot;ael.y&quot;
+  case 75:
+#line 433 &quot;ael.y&quot;
     {reset_parencount(parseio-&gt;scanner);;}
     break;
 
-  case 78:
-#line 420 &quot;ael.y&quot;
+  case 76:
+#line 433 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_FOR, &amp;(yylsp[-11]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.for_init = (yyvsp[-8].str);
@@ -2445,29 +2415,29 @@
 		(yyval.pval)-&gt;u4.for_statements = (yyvsp[0].pval);;}
     break;
 
-  case 79:
-#line 426 &quot;ael.y&quot;
+  case 77:
+#line 439 &quot;ael.y&quot;
     {reset_parencount(parseio-&gt;scanner);;}
     break;
 
-  case 80:
-#line 426 &quot;ael.y&quot;
+  case 78:
+#line 439 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_WHILE, &amp;(yylsp[-5]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[-2].str);
 		(yyval.pval)-&gt;u2.statements = (yyvsp[0].pval); ;}
     break;
 
-  case 81:
-#line 430 &quot;ael.y&quot;
+  case 79:
+#line 443 &quot;ael.y&quot;
     {
 		(yyval.pval)=(yyvsp[-1].pval);
 		(yyval.pval)-&gt;endline = (yylsp[0]).last_line;
 		(yyval.pval)-&gt;endcol = (yylsp[0]).last_column;;}
     break;
 
-  case 82:
-#line 434 &quot;ael.y&quot;
+  case 80:
+#line 447 &quot;ael.y&quot;
     {
 		(yyval.pval)=(yyvsp[-2].pval);
 		(yyval.pval)-&gt;u2.statements = (yyvsp[-1].pval);
@@ -2475,36 +2445,36 @@
 		(yyval.pval)-&gt;endcol = (yylsp[0]).last_column;;}
     break;
 
-  case 83:
-#line 439 &quot;ael.y&quot;
+  case 81:
+#line 452 &quot;ael.y&quot;
     {
 		(yyval.pval) = (yyvsp[-1].pval);
 		(yyval.pval)-&gt;endline = (yylsp[-1]).last_line;
 		(yyval.pval)-&gt;endcol = (yylsp[-1]).last_column;;}
     break;
 
-  case 84:
-#line 443 &quot;ael.y&quot;
+  case 82:
+#line 456 &quot;ael.y&quot;
     {
 		(yyval.pval) = (yyvsp[-1].pval);
 		(yyval.pval)-&gt;endline = (yylsp[0]).last_line;
 		(yyval.pval)-&gt;endcol = (yylsp[0]).last_column;;}
     break;
 
-  case 85:
-#line 447 &quot;ael.y&quot;
+  case 83:
+#line 460 &quot;ael.y&quot;
     {
 		(yyval.pval)= npval2(PV_APPLICATION_CALL, &amp;(yylsp[-1]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[-1].str);;}
     break;
 
-  case 86:
-#line 450 &quot;ael.y&quot;
+  case 84:
+#line 463 &quot;ael.y&quot;
     {reset_semicount(parseio-&gt;scanner);;}
     break;
 
-  case 87:
-#line 450 &quot;ael.y&quot;
+  case 85:
+#line 463 &quot;ael.y&quot;
     {
 		char *bufx;
 		int tot=0;
@@ -2540,91 +2510,74 @@
 	;}
     break;
 
-  case 88:
-#line 483 &quot;ael.y&quot;
+  case 86:
+#line 496 &quot;ael.y&quot;
     { (yyval.pval) = npval2(PV_BREAK, &amp;(yylsp[-1]), &amp;(yylsp[0])); ;}
     break;
 
-  case 89:
-#line 484 &quot;ael.y&quot;
+  case 87:
+#line 497 &quot;ael.y&quot;
     { (yyval.pval) = npval2(PV_RETURN, &amp;(yylsp[-1]), &amp;(yylsp[0])); ;}
     break;
 
-  case 90:
-#line 485 &quot;ael.y&quot;
+  case 88:
+#line 498 &quot;ael.y&quot;
     { (yyval.pval) = npval2(PV_CONTINUE, &amp;(yylsp[-1]), &amp;(yylsp[0])); ;}
     break;
 
-  case 91:
-#line 486 &quot;ael.y&quot;
+  case 89:
+#line 499 &quot;ael.y&quot;
     {
-		(yyval.pval)=(yyvsp[-1].pval);
-		(yyval.pval)-&gt;u2.statements = (yyvsp[0].pval);
-		(yyval.pval)-&gt;endline = (yylsp[0]).last_line;
-		(yyval.pval)-&gt;endcol = (yylsp[0]).last_column;;}
+		(yyval.pval)=(yyvsp[-2].pval);
+		(yyval.pval)-&gt;u2.statements = (yyvsp[-1].pval);
+		(yyval.pval)-&gt;endline = (yylsp[-1]).last_line;
+		(yyval.pval)-&gt;u3.else_statements = (yyvsp[0].pval);
+		(yyval.pval)-&gt;endcol = (yylsp[-1]).last_column;;}
     break;
 
-  case 92:
-#line 491 &quot;ael.y&quot;
+  case 90:
+#line 513 &quot;ael.y&quot;
     {
-		(yyval.pval)=(yyvsp[-3].pval);
-		(yyval.pval)-&gt;u2.statements = (yyvsp[-2].pval);
-		(yyval.pval)-&gt;endline = (yylsp[-2]).last_line;
-		(yyval.pval)-&gt;endcol = (yylsp[-2]).last_column;
-		(yyval.pval)-&gt;u3.else_statements = (yyvsp[0].pval);;}
+		(yyval.pval)=(yyvsp[-2].pval);
+		(yyval.pval)-&gt;u2.statements = (yyvsp[-1].pval);
+		(yyval.pval)-&gt;endline = (yylsp[-1]).last_line;
+		(yyval.pval)-&gt;u3.else_statements = (yyvsp[0].pval);
+		(yyval.pval)-&gt;endcol = (yylsp[-1]).last_column;;}
     break;
 
-  case 93:
-#line 497 &quot;ael.y&quot;
+  case 91:
+#line 527 &quot;ael.y&quot;
     {
-		(yyval.pval)=(yyvsp[-1].pval);
-		(yyval.pval)-&gt;u2.statements = (yyvsp[0].pval);
-		(yyval.pval)-&gt;endline = (yylsp[0]).last_line;
-		(yyval.pval)-&gt;endcol = (yylsp[0]).last_column;;}
+		(yyval.pval)=(yyvsp[-2].pval);
+		(yyval.pval)-&gt;u2.statements = (yyvsp[-1].pval);
+		(yyval.pval)-&gt;endline = (yylsp[-1]).last_line;
+		(yyval.pval)-&gt;u3.else_statements = (yyvsp[0].pval);
+		(yyval.pval)-&gt;endcol = (yylsp[-1]).last_column;;}
     break;
 
-  case 94:
-#line 502 &quot;ael.y&quot;
-    {
-		(yyval.pval)=(yyvsp[-3].pval);
-		(yyval.pval)-&gt;u2.statements = (yyvsp[-2].pval);
-		(yyval.pval)-&gt;endline = (yylsp[-2]).last_line;
-		(yyval.pval)-&gt;endcol = (yylsp[-2]).last_column;
-		(yyval.pval)-&gt;u3.else_statements = (yyvsp[0].pval);;}
+  case 92:
+#line 541 &quot;ael.y&quot;
+    { (yyval.pval)=0; ;}
     break;
 
-  case 95:
-#line 508 &quot;ael.y&quot;
-    {
-		(yyval.pval)=(yyvsp[-1].pval);
-		(yyval.pval)-&gt;u2.statements = (yyvsp[0].pval);
-		(yyval.pval)-&gt;endline = (yylsp[0]).last_line;
-		(yyval.pval)-&gt;endcol = (yylsp[0]).last_column;;}
+  case 93:
+#line 544 &quot;ael.y&quot;
+    { (yyval.pval) = (yyvsp[0].pval); ;}
     break;
 
-  case 96:
-#line 513 &quot;ael.y&quot;
-    {
-		(yyval.pval)=(yyvsp[-3].pval);
-		(yyval.pval)-&gt;u2.statements = (yyvsp[-2].pval);
-		(yyval.pval)-&gt;endline = (yylsp[-2]).last_line;
-		(yyval.pval)-&gt;endcol = (yylsp[-2]).last_column;
-		(yyval.pval)-&gt;u3.else_statements = (yyvsp[0].pval);;}
+  case 94:
+#line 545 &quot;ael.y&quot;
+    { (yyval.pval) = NULL ; ;}
     break;
 
-  case 97:
-#line 519 &quot;ael.y&quot;
-    { (yyval.pval)=0; ;}
-    break;
-
-  case 98:
-#line 522 &quot;ael.y&quot;
+  case 95:
+#line 550 &quot;ael.y&quot;
     { (yyval.pval) = npval2(PV_WORD, &amp;(yylsp[0]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[0].str);;}
     break;
 
-  case 99:
-#line 524 &quot;ael.y&quot;
+  case 96:
+#line 552 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_WORD, &amp;(yylsp[-2]), &amp;(yylsp[-2]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[-2].str);
@@ -2632,8 +2585,8 @@
 		(yyval.pval)-&gt;next-&gt;u1.str = (yyvsp[0].str);;}
     break;
 
-  case 100:
-#line 529 &quot;ael.y&quot;
+  case 97:
+#line 557 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_WORD, &amp;(yylsp[-2]), &amp;(yylsp[-2]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[-2].str);
@@ -2641,8 +2594,8 @@
 		(yyval.pval)-&gt;next-&gt;u1.str = (yyvsp[0].str);;}
     break;
 
-  case 101:
-#line 534 &quot;ael.y&quot;
+  case 98:
+#line 562 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_WORD, &amp;(yylsp[-4]), &amp;(yylsp[-4]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[-4].str);
@@ -2652,8 +2605,8 @@
 		(yyval.pval)-&gt;next-&gt;next-&gt;u1.str = (yyvsp[0].str); ;}
     break;
 
-  case 102:
-#line 541 &quot;ael.y&quot;
+  case 99:
+#line 569 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_WORD, &amp;(yylsp[-4]), &amp;(yylsp[-4]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[-4].str);
@@ -2663,8 +2616,8 @@
 		(yyval.pval)-&gt;next-&gt;next-&gt;u1.str = (yyvsp[0].str); ;}
     break;
 
-  case 103:
-#line 548 &quot;ael.y&quot;
+  case 100:
+#line 576 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_WORD, &amp;(yylsp[-4]), &amp;(yylsp[-4]));
 		(yyval.pval)-&gt;u1.str = strdup(&quot;default&quot;);
@@ -2674,8 +2627,8 @@
 		(yyval.pval)-&gt;next-&gt;next-&gt;u1.str = (yyvsp[0].str); ;}
     break;
 
-  case 104:
-#line 555 &quot;ael.y&quot;
+  case 101:
+#line 583 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_WORD, &amp;(yylsp[-4]), &amp;(yylsp[-4]));
 		(yyval.pval)-&gt;u1.str = strdup(&quot;default&quot;);
@@ -2685,8 +2638,8 @@
 		(yyval.pval)-&gt;next-&gt;next-&gt;u1.str = (yyvsp[0].str); ;}
     break;
 
-  case 105:
-#line 564 &quot;ael.y&quot;
+  case 102:
+#line 592 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_WORD, &amp;(yylsp[0]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[0].str);
@@ -2694,8 +2647,8 @@
 		(yyval.pval)-&gt;next-&gt;u1.str = strdup(&quot;1&quot;);;}
     break;
 
-  case 106:
-#line 569 &quot;ael.y&quot;
+  case 103:
+#line 597 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_WORD, &amp;(yylsp[-2]), &amp;(yylsp[-2]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[-2].str);
@@ -2703,8 +2656,8 @@
 		(yyval.pval)-&gt;next-&gt;u1.str = (yyvsp[0].str);;}
     break;
 
-  case 107:
-#line 574 &quot;ael.y&quot;
+  case 104:
+#line 602 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_WORD, &amp;(yylsp[-4]), &amp;(yylsp[-4]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[0].str);
@@ -2714,8 +2667,8 @@
 		(yyval.pval)-&gt;next-&gt;next-&gt;u1.str = (yyvsp[-2].str); ;}
     break;
 
-  case 108:
-#line 581 &quot;ael.y&quot;
+  case 105:
+#line 609 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_WORD, &amp;(yylsp[-2]), &amp;(yylsp[-2]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[0].str);
@@ -2725,8 +2678,8 @@
 		(yyval.pval)-&gt;next-&gt;next-&gt;u1.str = strdup(&quot;1&quot;); ;}
     break;
 
-  case 109:
-#line 588 &quot;ael.y&quot;
+  case 106:
+#line 616 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_WORD, &amp;(yylsp[-4]), &amp;(yylsp[-4]));
 		(yyval.pval)-&gt;u1.str = strdup(&quot;default&quot;);
@@ -2736,8 +2689,8 @@
 		(yyval.pval)-&gt;next-&gt;next-&gt;u1.str = (yyvsp[-2].str); ;}
     break;
 
-  case 110:
-#line 595 &quot;ael.y&quot;
+  case 107:
+#line 623 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_WORD, &amp;(yylsp[-2]), &amp;(yylsp[-2]));
 		(yyval.pval)-&gt;u1.str = strdup(&quot;default&quot;);
@@ -2747,13 +2700,13 @@
 		(yyval.pval)-&gt;next-&gt;next-&gt;u1.str = strdup(&quot;1&quot;); ;}
     break;
 
-  case 111:
-#line 604 &quot;ael.y&quot;
+  case 108:
+#line 632 &quot;ael.y&quot;
     {reset_argcount(parseio-&gt;scanner);;}
     break;
 
-  case 112:
-#line 604 &quot;ael.y&quot;
+  case 109:
+#line 632 &quot;ael.y&quot;
     {
 		/* XXX original code had @2 but i think we need @5 */
 		(yyval.pval) = npval2(PV_MACRO_CALL, &amp;(yylsp[-4]), &amp;(yylsp[0]));
@@ -2761,20 +2714,20 @@
 		(yyval.pval)-&gt;u2.arglist = (yyvsp[-1].pval);;}
     break;
 
-  case 113:
-#line 609 &quot;ael.y&quot;
+  case 110:
+#line 637 &quot;ael.y&quot;
     {
 		(yyval.pval)= npval2(PV_MACRO_CALL, &amp;(yylsp[-2]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[-2].str); ;}
     break;
 
-  case 114:
-#line 614 &quot;ael.y&quot;
+  case 111:
+#line 642 &quot;ael.y&quot;
     {reset_argcount(parseio-&gt;scanner);;}
     break;
 
-  case 115:
-#line 614 &quot;ael.y&quot;
+  case 112:
+#line 642 &quot;ael.y&quot;
     {
 		if (strcasecmp((yyvsp[-2].str),&quot;goto&quot;) == 0) {
 			(yyval.pval)= npval2(PV_GOTO, &amp;(yylsp[-2]), &amp;(yylsp[0]));
@@ -2785,8 +2738,8 @@
 		(yyval.pval)-&gt;u1.str = (yyvsp[-2].str); ;}
     break;
 
-  case 116:
-#line 624 &quot;ael.y&quot;
+  case 113:
+#line 652 &quot;ael.y&quot;
     {(yyval.pval) = (yyvsp[-2].pval);
  		if( (yyval.pval)-&gt;type == PV_GOTO )
 			(yyval.pval)-&gt;u1.list = (yyvsp[-1].pval);
@@ -2795,27 +2748,37 @@
  		(yyval.pval)-&gt;endline = (yylsp[0]).last_line; (yyval.pval)-&gt;endcol = (yylsp[0]).last_column;;}
     break;
 
-  case 117:
-#line 630 &quot;ael.y&quot;
+  case 114:
+#line 658 &quot;ael.y&quot;
     {(yyval.pval)=(yyvsp[-1].pval);(yyval.pval)-&gt;endline = (yylsp[0]).last_line; (yyval.pval)-&gt;endcol = (yylsp[0]).last_column;;}
     break;
 
-  case 118:
-#line 633 &quot;ael.y&quot;
+  case 115:
+#line 661 &quot;ael.y&quot;
+    { (yyval.str) = (yyvsp[0].str) ;}
+    break;
+
+  case 116:
+#line 662 &quot;ael.y&quot;
+    { (yyval.str) = strdup(&quot;&quot;); ;}
+    break;
+
+  case 117:
+#line 665 &quot;ael.y&quot;
     { 
 		(yyval.pval)= npval2(PV_WORD, &amp;(yylsp[0]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[0].str);;}
     break;
 
-  case 119:
-#line 636 &quot;ael.y&quot;
+  case 118:
+#line 668 &quot;ael.y&quot;
     {
 		(yyval.pval)= npval(PV_WORD,0/*@1.first_line*/,0/*@1.last_line*/,0/* @1.first_column*/, 0/*@1.last_column*/);
 		(yyval.pval)-&gt;u1.str = strdup(&quot;&quot;); ;}
     break;
 
-  case 120:
-#line 639 &quot;ael.y&quot;
+  case 119:
+#line 671 &quot;ael.y&quot;
     {
 		pval *z = npval2(PV_WORD, &amp;(yylsp[0]), &amp;(yylsp[0]));
 		(yyval.pval) = (yyvsp[-2].pval);
@@ -2823,132 +2786,123 @@
 		z-&gt;u1.str = (yyvsp[0].str);;}
     break;
 
-  case 121:
-#line 644 &quot;ael.y&quot;
-    {
-		pval *z = npval2(PV_WORD, &amp;(yylsp[0]), &amp;(yylsp[0]));
-		(yyval.pval) = (yyvsp[-1].pval);
-		linku1((yyvsp[-1].pval),z);
-		z-&gt;u1.str = strdup(&quot;&quot;);;}
-    break;
-
-  case 122:
-#line 651 &quot;ael.y&quot;
+  case 120:
+#line 685 &quot;ael.y&quot;
     {(yyval.pval)=(yyvsp[0].pval);;}
     break;
 
-  case 123:
-#line 652 &quot;ael.y&quot;
+  case 121:
+#line 686 &quot;ael.y&quot;
     { if ( (yyvsp[-1].pval) &amp;&amp; (yyvsp[0].pval) ) {(yyval.pval)=(yyvsp[-1].pval); linku1((yyval.pval),(yyvsp[0].pval));}
 						 else if ( (yyvsp[-1].pval) ) {(yyval.pval)=(yyvsp[-1].pval);}
 						 else if ( (yyvsp[0].pval) ) {(yyval.pval)=(yyvsp[0].pval);} ;}
     break;
 
-  case 124:
-#line 657 &quot;ael.y&quot;
+  case 122:
+#line 691 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_CASE, &amp;(yylsp[-3]), &amp;(yylsp[-1])); /* XXX 3 or 4 ? */
 		(yyval.pval)-&gt;u1.str = (yyvsp[-2].str);
 		(yyval.pval)-&gt;u2.statements = (yyvsp[0].pval);;}
     break;
 
-  case 125:
-#line 661 &quot;ael.y&quot;
+  case 123:
+#line 695 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_DEFAULT, &amp;(yylsp[-2]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.str = NULL;
 		(yyval.pval)-&gt;u2.statements = (yyvsp[0].pval);;}
     break;
 
-  case 126:
-#line 665 &quot;ael.y&quot;
+  case 124:
+#line 699 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_PATTERN, &amp;(yylsp[-3]), &amp;(yylsp[0])); /* <A HREF="https://lists.berlios.de/mailman/listinfo/solid-pbx-svn">XXX at 3</A> or @4 ? */
 		(yyval.pval)-&gt;u1.str = (yyvsp[-2].str);
 		(yyval.pval)-&gt;u2.statements = (yyvsp[0].pval);;}
     break;
 
-  case 127:
-#line 669 &quot;ael.y&quot;
+  case 125:
+#line 703 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_CASE, &amp;(yylsp[-2]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[-1].str);;}
     break;
 
-  case 128:
-#line 672 &quot;ael.y&quot;
+  case 126:
+#line 706 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_DEFAULT, &amp;(yylsp[-1]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.str = NULL;;}
     break;
 
-  case 129:
-#line 675 &quot;ael.y&quot;
+  case 127:
+#line 709 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_PATTERN, &amp;(yylsp[-2]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[-1].str);;}
     break;
 
-  case 130:
-#line 680 &quot;ael.y&quot;
+  case 128:
+#line 714 &quot;ael.y&quot;
     {(yyval.pval) = (yyvsp[0].pval);;}
     break;
 
-  case 131:
-#line 681 &quot;ael.y&quot;
+  case 129:
+#line 715 &quot;ael.y&quot;
     { if ( (yyvsp[-1].pval) &amp;&amp; (yyvsp[0].pval) ) {(yyval.pval)=(yyvsp[-1].pval); linku1((yyval.pval),(yyvsp[0].pval));}
 						 else if ( (yyvsp[-1].pval) ) {(yyval.pval)=(yyvsp[-1].pval);}
 						 else if ( (yyvsp[0].pval) ) {(yyval.pval)=(yyvsp[0].pval);} ;}
     break;
 
-  case 132:
-#line 686 &quot;ael.y&quot;
+  case 130:
+#line 720 &quot;ael.y&quot;
     {(yyval.pval)=(yyvsp[0].pval);;}
     break;
 
-  case 133:
-#line 687 &quot;ael.y&quot;
+  case 131:
+#line 721 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_CATCH, &amp;(yylsp[-4]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[-3].str);
 		(yyval.pval)-&gt;u2.statements = (yyvsp[-1].pval);;}
     break;
 
-  case 134:
-#line 693 &quot;ael.y&quot;
+  case 132:
+#line 727 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_SWITCHES, &amp;(yylsp[-3]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.list = (yyvsp[-1].pval); ;}
     break;
 
-  case 135:
-#line 696 &quot;ael.y&quot;
+  case 133:
+#line 730 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_SWITCHES, &amp;(yylsp[-2]), &amp;(yylsp[0])); ;}
     break;
 
-  case 136:
-#line 700 &quot;ael.y&quot;
+  case 134:
+#line 734 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_ESWITCHES, &amp;(yylsp[-3]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.list = (yyvsp[-1].pval); ;}
     break;
 
-  case 137:
-#line 703 &quot;ael.y&quot;
+  case 135:
+#line 737 &quot;ael.y&quot;
     { /* empty switch list OK */
 		(yyval.pval) = npval2(PV_ESWITCHES, &amp;(yylsp[-2]), &amp;(yylsp[0])); ;}
     break;
 
-  case 138:
-#line 707 &quot;ael.y&quot;
+  case 136:
+#line 741 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_WORD, &amp;(yylsp[-1]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[-1].str);;}
     break;
 
-  case 139:
-#line 710 &quot;ael.y&quot;
+  case 137:
+#line 744 &quot;ael.y&quot;
     {
 		pval *z = npval2(PV_WORD, &amp;(yylsp[-1]), &amp;(yylsp[0]));
 		z-&gt;u1.str = (yyvsp[-1].str);
@@ -2956,20 +2910,20 @@
 		linku1((yyval.pval),z); ;}
     break;
 
-  case 140:
-#line 715 &quot;ael.y&quot;
+  case 138:
+#line 749 &quot;ael.y&quot;
     {(yyval.pval)=(yyvsp[-1].pval);;}
     break;
 
-  case 141:
-#line 718 &quot;ael.y&quot;
+  case 139:
+#line 752 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_WORD, &amp;(yylsp[-1]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[-1].str);;}
     break;
 
-  case 142:
-#line 722 &quot;ael.y&quot;
+  case 140:
+#line 756 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_WORD, &amp;(yylsp[-13]), &amp;(yylsp[-12]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[-13].str);
@@ -2988,8 +2942,8 @@
 	;}
     break;
 
-  case 143:
-#line 738 &quot;ael.y&quot;
+  case 141:
+#line 772 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_WORD, &amp;(yylsp[-9]), &amp;(yylsp[-8]));
 		(yyval.pval)-&gt;u1.str = (yyvsp[-9].str);
@@ -3005,17 +2959,17 @@
 	;}
     break;
 
-  case 144:
-#line 751 &quot;ael.y&quot;
+  case 142:
+#line 785 &quot;ael.y&quot;
     {
-		pval *z = npval2(PV_WORD, &amp;(yylsp[-1]), &amp;(yylsp[0])); /* XXX don't we need @<A HREF="https://lists.berlios.de/mailman/listinfo/solid-pbx-svn">1- at 4</A> ?*/
+		pval *z = npval2(PV_WORD, &amp;(yylsp[-1]), &amp;(yylsp[0])); /* XXX don't we need @<A HREF="https://lists.berlios.de/mailman/listinfo/solid-pbx-svn">1- at 3</A> ?*/
 		(yyval.pval)=(yyvsp[-2].pval);
 		z-&gt;u1.str = (yyvsp[-1].str);
 		linku1((yyval.pval),z); ;}
     break;
 
-  case 145:
-#line 757 &quot;ael.y&quot;
+  case 143:
+#line 791 &quot;ael.y&quot;
     {
 		pval *z = npval2(PV_WORD, &amp;(yylsp[-13]), &amp;(yylsp[-12]));
 		(yyval.pval)=(yyvsp[-14].pval); z-&gt;u1.str = (yyvsp[-13].str);
@@ -3035,14 +2989,15 @@
 	;}
     break;
 
-  case 146:
-#line 774 &quot;ael.y&quot;
+  case 144:
+#line 808 &quot;ael.y&quot;
     {
 		pval *z = npval2(PV_WORD, &amp;(yylsp[-9]), &amp;(yylsp[-8]));
 		(yyval.pval)=(yyvsp[-10].pval);
-		z-&gt;u1.str = (yyvsp[-9].str); linku1((yyval.pval),z);
-		z-&gt;u2.arglist = npval2(PV_WORD, &amp;(yylsp[-7]), &amp;(yylsp[-7]));
+		linku1((yyval.pval),z);
 		(yyval.pval)-&gt;u2.arglist-&gt;u1.str = (yyvsp[-7].str);
+		z-&gt;u1.str = (yyvsp[-9].str);
+		z-&gt;u2.arglist = npval2(PV_WORD, &amp;(yylsp[-7]), &amp;(yylsp[-7]));	/* XXX is this correct ? */
 		z-&gt;u2.arglist-&gt;next = npval2(PV_WORD, &amp;(yylsp[-5]), &amp;(yylsp[-5]));
 		z-&gt;u2.arglist-&gt;next-&gt;u1.str = (yyvsp[-5].str);
 		z-&gt;u2.arglist-&gt;next-&gt;next = npval2(PV_WORD, &amp;(yylsp[-3]), &amp;(yylsp[-3]));
@@ -3053,30 +3008,30 @@
 	;}
     break;
 
-  case 147:
-#line 788 &quot;ael.y&quot;
+  case 145:
+#line 823 &quot;ael.y&quot;
     {(yyval.pval)=(yyvsp[-1].pval);;}
     break;
 
-  case 148:
-#line 791 &quot;ael.y&quot;
+  case 146:
+#line 826 &quot;ael.y&quot;
     { (yyval.str) = (yyvsp[0].str);;}
     break;
 
-  case 149:
-#line 792 &quot;ael.y&quot;
+  case 147:
+#line 827 &quot;ael.y&quot;
     {(yyval.str)=strdup(&quot;default&quot;);;}
     break;
 
-  case 150:
-#line 795 &quot;ael.y&quot;
+  case 148:
+#line 830 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_INCLUDES, &amp;(yylsp[-3]), &amp;(yylsp[0]));
 		(yyval.pval)-&gt;u1.list = (yyvsp[-1].pval);;}
     break;
 
-  case 151:
-#line 798 &quot;ael.y&quot;
+  case 149:
+#line 833 &quot;ael.y&quot;
     {
 		(yyval.pval) = npval2(PV_INCLUDES, &amp;(yylsp[-2]), &amp;(yylsp[0]));;}
     break;
@@ -3086,7 +3041,7 @@
     }
 
 /* Line 1126 of yacc.c.  */
-#line 3090 &quot;ael.tab.c&quot;
+#line 3045 &quot;ael.tab.c&quot;
 
   yyvsp -= yylen;
   yyssp -= yylen;
@@ -3361,7 +3316,7 @@
 }
 
 
-#line 803 &quot;ael.y&quot;
+#line 838 &quot;ael.y&quot;
 
 
 static char *token_equivs1[] =

Modified: trunk/pbx/ael/ael.y
===================================================================
--- trunk/pbx/ael/ael.y	2006-04-29 14:18:03 UTC (rev 12)
+++ trunk/pbx/ael/ael.y	2006-04-30 14:53:08 UTC (rev 13)
@@ -73,6 +73,8 @@
 %token KW_FOR KW_WHILE KW_CASE KW_PATTERN KW_DEFAULT KW_CATCH KW_SWITCHES KW_ESWITCHES
 %token KW_INCLUDES
 
+%right BAR COMMA
+
 %token &lt;str&gt; word
 
 %type &lt;pval&gt;includes
@@ -109,7 +111,12 @@
 %type &lt;pval&gt;object
 %type &lt;pval&gt;objects
 %type &lt;pval&gt;file
+/* XXX lr changes */
+%type &lt;pval&gt;opt_else
 
+%type &lt;str&gt;opt_word
+%type &lt;str&gt;word_or_default
+
 %type &lt;str&gt;goto_word
 %type &lt;str&gt;word_list
 %type &lt;str&gt;word3_list
@@ -148,8 +155,9 @@
 		if_head random_head iftime_head statements extension
 		ignorepat element elements arglist global_statement
 		global_statements globals macro context object objects
+		opt_else
 
-%destructor { free($$);}  word word_list goto_word word3_list includedname
+%destructor { free($$);}  word word_list goto_word word3_list includedname opt_word word_or_default
 
 
 %%
@@ -178,38 +186,44 @@
 	| SEMI  {$$=0;/* allow older docs to be read */}
 	;
 
-context : KW_CONTEXT word LC elements RC {
+word_or_default : word { $$ = $1; }
+	| KW_DEFAULT { $$ = strdup(&quot;default&quot;); }
+	;
+
+context : KW_CONTEXT word_or_default LC elements RC {
 		$$ = npval2(PV_CONTEXT, &amp;@1, &amp;@5);
 		$$-&gt;u1.str = $2;
 		$$-&gt;u2.statements = $4; }
-	| KW_CONTEXT word LC RC /* empty context OK */ {
+	| KW_CONTEXT word_or_default LC RC /* empty context OK */ {
 		$$ = npval2(PV_CONTEXT, &amp;@1, &amp;@4);
 		$$-&gt;u1.str = $2; }
-	| KW_CONTEXT KW_DEFAULT LC elements RC {
-		$$ = npval2(PV_CONTEXT, &amp;@1, &amp;@5);
-		$$-&gt;u1.str = strdup(&quot;default&quot;);
-		$$-&gt;u2.statements = $4; }
-	| KW_CONTEXT KW_DEFAULT LC RC /* empty context OK */ {
-		$$ = npval2(PV_CONTEXT, &amp;@1, &amp;@4);
-		$$-&gt;u1.str = strdup(&quot;default&quot;); }
-	| KW_ABSTRACT KW_CONTEXT word LC elements RC {
+	| KW_ABSTRACT KW_CONTEXT word_or_default LC elements RC {
 		$$ = npval2(PV_CONTEXT, &amp;@1, &amp;@6);
 		$$-&gt;u1.str = $3;
 		$$-&gt;u2.statements = $5;
 		$$-&gt;u3.abstract = 1; }
-	| KW_ABSTRACT KW_CONTEXT word LC RC /* empty context OK */ {
+	| KW_ABSTRACT KW_CONTEXT word_or_default LC RC /* empty context OK */ {
 		$$ = npval2(PV_CONTEXT, &amp;@1, &amp;@5);
 		$$-&gt;u1.str = $3;
 		$$-&gt;u3.abstract = 1; }
+/*
+	| KW_CONTEXT KW_DEFAULT LC elements RC {
+		$$ = npval2(PV_CONTEXT, &amp;@1, &amp;@5);
+		$$-&gt;u1.str = strdup(&quot;default&quot;);
+		$$-&gt;u2.statements = $4; }
+	| KW_CONTEXT KW_DEFAULT LC RC {
+		$$ = npval2(PV_CONTEXT, &amp;@1, &amp;@4);
+		$$-&gt;u1.str = strdup(&quot;default&quot;); }
 	| KW_ABSTRACT KW_CONTEXT KW_DEFAULT LC elements RC  {
 		$$ = npval2(PV_CONTEXT, &amp;@1, &amp;@6);
 		$$-&gt;u1.str = strdup(&quot;default&quot;);
 		$$-&gt;u2.statements = $5;
 		$$-&gt;u3.abstract = 1; }
-	| KW_ABSTRACT KW_CONTEXT KW_DEFAULT LC RC /* empty context OK */ {
+	| KW_ABSTRACT KW_CONTEXT KW_DEFAULT LC RC {
 		$$ = npval2(PV_CONTEXT, &amp;@1, &amp;@5);
 		$$-&gt;u1.str = strdup(&quot;default&quot;);
 		$$-&gt;u3.abstract = 1; }
+*/
 	;
 
 macro : KW_MACRO word LP arglist RP LC macro_statements RC {
@@ -251,8 +265,7 @@
 	| arglist COMMA word {
 		pval *z = npval2(PV_WORD, &amp;@1, &amp;@3);
 		z-&gt;u1.str = $3;
-		$$=$1;
-		linku1($$,z); }
+		$$ = linku1($1,z); }
 	| arglist error {$$=$1;}
 	;
 
@@ -483,42 +496,57 @@
 	| KW_BREAK SEMI { $$ = npval2(PV_BREAK, &amp;@1, &amp;@2); }
 	| KW_RETURN SEMI { $$ = npval2(PV_RETURN, &amp;@1, &amp;@2); }
 	| KW_CONTINUE SEMI { $$ = npval2(PV_CONTINUE, &amp;@1, &amp;@2); }
-	| random_head statement {
+	| random_head statement opt_else {
 		$$=$1;
 		$$-&gt;u2.statements = $2;
 		$$-&gt;endline = @2.last_line;
+		$$-&gt;u3.else_statements = $3;
 		$$-&gt;endcol = @2.last_column;}
+/*
 	| random_head statement KW_ELSE statement {
 		$$=$1;
 		$$-&gt;u2.statements = $2;
 		$$-&gt;endline = @2.last_line;
 		$$-&gt;endcol = @2.last_column;
 		$$-&gt;u3.else_statements = $4;}
-	| if_head statement {
+*/
+	| if_head statement opt_else {
 		$$=$1;
 		$$-&gt;u2.statements = $2;
 		$$-&gt;endline = @2.last_line;
+		$$-&gt;u3.else_statements = $3;
 		$$-&gt;endcol = @2.last_column;}
+/*
 	| if_head statement KW_ELSE statement {
 		$$=$1;
 		$$-&gt;u2.statements = $2;
 		$$-&gt;endline = @2.last_line;
 		$$-&gt;endcol = @2.last_column;
-		$$-&gt;u3.else_statements = $4;}
-	| iftime_head statement {
+	$$-&gt;u3.else_statements = $4;}
+*/
+	| iftime_head statement opt_else {
 		$$=$1;
 		$$-&gt;u2.statements = $2;
 		$$-&gt;endline = @2.last_line;
+		$$-&gt;u3.else_statements = $3;
 		$$-&gt;endcol = @2.last_column;}
+/*
 	| iftime_head statement KW_ELSE statement {
 		$$=$1;
 		$$-&gt;u2.statements = $2;
 		$$-&gt;endline = @2.last_line;
 		$$-&gt;endcol = @2.last_column;
 		$$-&gt;u3.else_statements = $4;}
+*/
 	| SEMI { $$=0; }
 	;
 
+opt_else : KW_ELSE statement { $$ = $2; }
+	| { $$ = NULL ; }
+
+/* XXX unused */
+bar_or_comma: BAR | COMMA ;
+
 target : goto_word { $$ = npval2(PV_WORD, &amp;@1, &amp;@1);
 		$$-&gt;u1.str = $1;}
 	| goto_word BAR goto_word {
@@ -630,22 +658,28 @@
 	| application_call_head RP {$$=$1;$$-&gt;endline = @2.last_line; $$-&gt;endcol = @2.last_column;}
 	;
 
+opt_word : word { $$ = $1 }
+	| { $$ = strdup(&quot;&quot;); }
+	;
+
 eval_arglist :  word_list { 
 		$$= npval2(PV_WORD, &amp;@1, &amp;@1);
 		$$-&gt;u1.str = $1;}
 	| /*nothing! */   {
 		$$= npval(PV_WORD,0/*@1.first_line*/,0/*@1.last_line*/,0/* @1.first_column*/, 0/*@1.last_column*/);
 		$$-&gt;u1.str = strdup(&quot;&quot;); }
-	| eval_arglist COMMA  word {
+	| eval_arglist COMMA  opt_word {
 		pval *z = npval2(PV_WORD, &amp;@3, &amp;@3);
 		$$ = $1;
 		linku1($1,z);
 		z-&gt;u1.str = $3;}
+/*
 	| eval_arglist COMMA {
 		pval *z = npval2(PV_WORD, &amp;@2, &amp;@2);
 		$$ = $1;
 		linku1($1,z);
 		z-&gt;u1.str = strdup(&quot;&quot;);}
+*/
 	;
 
 case_statements: case_statement {$$=$1;}
@@ -749,7 +783,7 @@
 		prev_word=0;
 	}
 	| includeslist includedname SEMI {
-		pval *z = npval2(PV_WORD, &amp;@2, &amp;@3); /* XXX don't we need @<A HREF="https://lists.berlios.de/mailman/listinfo/solid-pbx-svn">1- at 4</A> ?*/
+		pval *z = npval2(PV_WORD, &amp;@2, &amp;@3); /* XXX don't we need @<A HREF="https://lists.berlios.de/mailman/listinfo/solid-pbx-svn">1- at 3</A> ?*/
 		$$=$1;
 		z-&gt;u1.str = $2;
 		linku1($$,z); }
@@ -774,9 +808,10 @@
 	| includeslist includedname BAR word BAR word3_list BAR word3_list BAR word3_list SEMI {
 		pval *z = npval2(PV_WORD, &amp;@2, &amp;@3);
 		$$=$1;
-		z-&gt;u1.str = $2; linku1($$,z);
-		z-&gt;u2.arglist = npval2(PV_WORD, &amp;@4, &amp;@4);
+		linku1($$,z);
 		$$-&gt;u2.arglist-&gt;u1.str = $4;
+		z-&gt;u1.str = $2;
+		z-&gt;u2.arglist = npval2(PV_WORD, &amp;@4, &amp;@4);	/* XXX is this correct ? */
 		z-&gt;u2.arglist-&gt;next = npval2(PV_WORD, &amp;@6, &amp;@6);
 		z-&gt;u2.arglist-&gt;next-&gt;u1.str = $6;
 		z-&gt;u2.arglist-&gt;next-&gt;next = npval2(PV_WORD, &amp;@8, &amp;@8);

Modified: trunk/pbx/ael/ael_lex.c
===================================================================
--- trunk/pbx/ael/ael_lex.c	2006-04-29 14:18:03 UTC (rev 12)
+++ trunk/pbx/ael/ael_lex.c	2006-04-30 14:53:08 UTC (rev 13)
@@ -2781,7 +2781,19 @@
 }
 
 
-/* used by the bison code */
+/*
+ * The following three functions, reset_*, are used in the bison
+ * code to switch context. As a consequence, we need to
+ * declare them global and add a prototype so that the
+ * compiler does not complain.
+ *
+ * NOTE: yyg is declared because it is used in the BEGIN macros,
+ * though that should be hidden as the macro changes
+ * depending on the flex options that we use - in particular,
+ * %reentrant changes the way the macro is declared;
+ * without %reentrant, BEGIN uses yystart instead of yyg
+ */
+
 void reset_parencount(yyscan_t yyscanner );
 void reset_parencount(yyscan_t yyscanner )
 {
@@ -2793,7 +2805,6 @@
 	BEGIN(paren);
 }
 
-/* used by the bison code */
 void reset_semicount(yyscan_t yyscanner );
 void reset_semicount(yyscan_t yyscanner )
 {
@@ -2802,7 +2813,6 @@
 	BEGIN(semic);
 }
 
-/* used by the bison code */
 void reset_argcount(yyscan_t yyscanner );
 void reset_argcount(yyscan_t yyscanner )
 {

Modified: trunk/pbx/pbx_dundi.c
===================================================================
--- trunk/pbx/pbx_dundi.c	2006-04-29 14:18:03 UTC (rev 12)
+++ trunk/pbx/pbx_dundi.c	2006-04-30 14:53:08 UTC (rev 13)
@@ -79,23 +79,20 @@
 
 #define MAX_PACKET_SIZE 8192
 
-extern char ast_config_AST_KEY_DIR[];
-
-
 #define DUNDI_MODEL_INBOUND		(1 &lt;&lt; 0)
 #define DUNDI_MODEL_OUTBOUND	(1 &lt;&lt; 1)
 #define DUNDI_MODEL_SYMMETRIC	(DUNDI_MODEL_INBOUND | DUNDI_MODEL_OUTBOUND)
 
-/* Keep times of last 10 lookups */
+/*! Keep times of last 10 lookups */
 #define DUNDI_TIMING_HISTORY	10
 
-#define FLAG_ISREG		(1 &lt;&lt; 0)		/* Transaction is register request */
-#define FLAG_DEAD		(1 &lt;&lt; 1)		/* Transaction is dead */
-#define FLAG_FINAL		(1 &lt;&lt; 2)		/* Transaction has final message sent */
-#define FLAG_ISQUAL		(1 &lt;&lt; 3)		/* Transaction is a qualification */
-#define FLAG_ENCRYPT	(1 &lt;&lt; 4)		/* Transaction is encrypted wiht ECX/DCX */
-#define FLAG_SENDFULLKEY	(1 &lt;&lt; 5)		/* Send full key on transaction */
-#define FLAG_STOREHIST	(1 &lt;&lt; 6)		/* Record historic performance */
+#define FLAG_ISREG       (1 &lt;&lt; 0)   /*!&lt; Transaction is register request */
+#define FLAG_DEAD        (1 &lt;&lt; 1)   /*!&lt; Transaction is dead */
+#define FLAG_FINAL       (1 &lt;&lt; 2)   /*!&lt; Transaction has final message sent */
+#define FLAG_ISQUAL      (1 &lt;&lt; 3)   /*!&lt; Transaction is a qualification */
+#define FLAG_ENCRYPT     (1 &lt;&lt; 4)   /*!&lt; Transaction is encrypted wiht ECX/DCX */
+#define FLAG_SENDFULLKEY (1 &lt;&lt; 5)   /*!&lt; Send full key on transaction */
+#define FLAG_STOREHIST   (1 &lt;&lt; 6)   /*!&lt; Record historic performance */
 
 #define DUNDI_FLAG_INTERNAL_NOPARTIAL (1 &lt;&lt; 17)
 
@@ -166,31 +163,31 @@
 struct dundi_request;
 
 struct dundi_transaction {
-	struct sockaddr_in addr;	/* Other end of transaction */
-	struct timeval start;		/* When this transaction was created */
+	struct sockaddr_in addr;               /*!&lt; Other end of transaction */
+	struct timeval start;                  /*!&lt; When this transaction was created */
 	dundi_eid eids[DUNDI_MAX_STACK + 1];
-	int eidcount;				/* Number of eids in eids */
-	dundi_eid us_eid;			/* Our EID, to them */
-	dundi_eid them_eid;			/* Their EID, to us */
-	aes_encrypt_ctx	ecx;		/* AES 128 Encryption context */
-	aes_decrypt_ctx	dcx;		/* AES 128 Decryption context */
-	unsigned int flags;				/* Has final packet been sent */
-	int ttl;					/* Remaining TTL for queries on this one */
-	int thread;					/* We have a calling thread */
-	int retranstimer;			/* How long to wait before retransmissions */
-	int autokillid;				/* ID to kill connection if answer doesn't come back fast enough */
-	int autokilltimeout;		/* Recommended timeout for autokill */
-	unsigned short strans;		/* Our transaction identifier */
-	unsigned short dtrans;		/* Their transaction identifer */
-	unsigned char iseqno;		/* Next expected received seqno */
-	unsigned char oiseqno;		/* Last received incoming seqno */
-	unsigned char oseqno;		/* Next transmitted seqno */
-	unsigned char aseqno;		/* Last acknowledge seqno */
-	struct dundi_packet *packets;	/* Packets to be retransmitted */
-	struct dundi_packet *lasttrans;	/* Last transmitted / ACK'd packet */
-	struct dundi_transaction *next;	/* Next with respect to the parent */
-	struct dundi_request *parent;	/* Parent request (if there is one) */
-	struct dundi_transaction *allnext; /* Next with respect to all DUNDi transactions */
+	int eidcount;                          /*!&lt; Number of eids in eids */
+	dundi_eid us_eid;                      /*!&lt; Our EID, to them */
+	dundi_eid them_eid;                    /*!&lt; Their EID, to us */
+	aes_encrypt_ctx	ecx;                   /*!&lt; AES 128 Encryption context */
+	aes_decrypt_ctx	dcx;                   /*!&lt; AES 128 Decryption context */
+	unsigned int flags;                    /*!&lt; Has final packet been sent */
+	int ttl;                               /*!&lt; Remaining TTL for queries on this one */
+	int thread;                            /*!&lt; We have a calling thread */
+	int retranstimer;                      /*!&lt; How long to wait before retransmissions */
+	int autokillid;                        /*!&lt; ID to kill connection if answer doesn't come back fast enough */
+	int autokilltimeout;                   /*!&lt; Recommended timeout for autokill */
+	unsigned short strans;                 /*!&lt; Our transaction identifier */
+	unsigned short dtrans;                 /*!&lt; Their transaction identifer */
+	unsigned char iseqno;                  /*!&lt; Next expected received seqno */
+	unsigned char oiseqno;                 /*!&lt; Last received incoming seqno */
+	unsigned char oseqno;                  /*!&lt; Next transmitted seqno */
+	unsigned char aseqno;                  /*!&lt; Last acknowledge seqno */
+	struct dundi_packet *packets;          /*!&lt; Packets to be retransmitted */
+	struct dundi_packet *lasttrans;        /*!&lt; Last transmitted / ACK'd packet */
+	struct dundi_transaction *next;        /*!&lt; Next with respect to the parent */
+	struct dundi_request *parent;          /*!&lt; Parent request (if there is one) */
+	struct dundi_transaction *allnext;     /*!&lt; Next with respect to all DUNDi transactions */
 } *alltrans;
 
 struct dundi_request {
@@ -206,12 +203,12 @@
 	int expiration;
 	int cbypass;
 	int pfds[2];
-	unsigned long crc32;							/* CRC-32 of all but root EID's in avoid list */
-	struct dundi_transaction *trans;	/* Transactions */
-	struct dundi_request *next;
-} *requests;
+	unsigned long crc32;                   /*!&lt; CRC-32 of all but root EID's in avoid list */
+	struct dundi_transaction *trans;       /*!&lt; Transactions */
+	AST_LIST_ENTRY(dundi_request) list;
+};
 
-static struct dundi_mapping {
+struct dundi_mapping {
 	char dcontext[AST_MAX_EXTENSION];
 	char lcontext[AST_MAX_EXTENSION];
 	int weight;
@@ -219,12 +216,12 @@
 	int tech;
 	int dead;
 	char dest[AST_MAX_EXTENSION];
-	struct dundi_mapping *next;
-} *mappings = NULL;
+	AST_LIST_ENTRY(dundi_mapping) list;
+};
 
-static struct dundi_peer {
+struct dundi_peer {
 	dundi_eid eid;
-	struct sockaddr_in addr;	/* Address of DUNDi peer */
+	struct sockaddr_in addr;               /*!&lt; Address of DUNDi peer */
 	struct permission *permit;
 	struct permission *include;
 	struct permission *precachesend;
@@ -237,34 +234,37 @@
 	int qualifyid;
 	int sentfullkey;
 	int order;
-	unsigned char txenckey[256]; /* Transmitted encrypted key + sig */
-	unsigned char rxenckey[256]; /* Cache received encrypted key + sig */
-	unsigned long us_keycrc32;	/* CRC-32 of our key */
-	aes_encrypt_ctx	us_ecx;		/* Cached AES 128 Encryption context */
-	aes_decrypt_ctx	us_dcx;		/* Cached AES 128 Decryption context */
-	unsigned long them_keycrc32;/* CRC-32 of our key */
-	aes_encrypt_ctx	them_ecx;	/* Cached AES 128 Encryption context */
-	aes_decrypt_ctx	them_dcx;	/* Cached AES 128 Decryption context */
-	time_t keyexpire;			/* When to expire/recreate key */
+	unsigned char txenckey[256];           /*!&lt; Transmitted encrypted key + sig */
+	unsigned char rxenckey[256];           /*!&lt; Cache received encrypted key + sig */
+	unsigned long us_keycrc32;             /*!&lt; CRC-32 of our key */
+	aes_encrypt_ctx	us_ecx;                /*!&lt; Cached AES 128 Encryption context */
+	aes_decrypt_ctx	us_dcx;	               /*!&lt; Cached AES 128 Decryption context */
+	unsigned long them_keycrc32;           /*!&lt; CRC-32 of our key */
+	aes_encrypt_ctx	them_ecx;              /*!&lt; Cached AES 128 Encryption context */
+	aes_decrypt_ctx	them_dcx;              /*!&lt; Cached AES 128 Decryption context */
+	time_t keyexpire;                      /*!&lt; When to expire/recreate key */
 	int registerexpire;
 	int lookuptimes[DUNDI_TIMING_HISTORY];
 	char *lookups[DUNDI_TIMING_HISTORY];
 	int avgms;
-	struct dundi_transaction *regtrans;	/* Registration transaction */
-	struct dundi_transaction *qualtrans;	/* Qualify transaction */
+	struct dundi_transaction *regtrans;    /*!&lt; Registration transaction */
+	struct dundi_transaction *qualtrans;   /*!&lt; Qualify transaction */
 	struct dundi_transaction *keypending;
-	int model;					/* Pull model */
-	int pcmodel;				/* Push/precache model */
-	int dynamic;				/* Are we dynamic? */
-	int lastms;					/* Last measured latency */
-	int maxms;					/* Max permissible latency */
-	struct timeval qualtx;		/* Time of transmit */
-	struct dundi_peer *next;
-} *peers;
+	int model;                             /*!&lt; Pull model */
+	int pcmodel;                           /*!&lt; Push/precache model */
+	int dynamic;                           /*!&lt; Are we dynamic? */
+	int lastms;                            /*!&lt; Last measured latency */
+	int maxms;                             /*!&lt; Max permissible latency */
+	struct timeval qualtx;                 /*!&lt; Time of transmit */
+	AST_LIST_ENTRY(dundi_peer) list;
+};
 
+AST_LIST_HEAD_STATIC(peers, dundi_peer);
+AST_LIST_HEAD_NOLOCK_STATIC(mappings, dundi_mapping);
+AST_LIST_HEAD_NOLOCK_STATIC(requests, dundi_request);
+
 static struct dundi_precache_queue *pcq;
 
-AST_MUTEX_DEFINE_STATIC(peerlock);
 AST_MUTEX_DEFINE_STATIC(pclock);
 
 static int dundi_xmit(struct dundi_packet *pack);
@@ -477,16 +477,17 @@
 
 static struct dundi_peer *find_peer(dundi_eid *eid)
 {
-	struct dundi_peer *cur;
+	struct dundi_peer *cur = NULL;
+
 	if (!eid)
 		eid = &amp;empty_eid;
-	cur = peers;
-	while(cur) {
+	
+	AST_LIST_TRAVERSE(&amp;peers, cur, list) {
 		if (!dundi_eid_cmp(&amp;cur-&gt;eid,eid))
-			return cur;
-		cur = cur-&gt;next;
+			break;
 	}
-	return NULL;
+
+	return cur;
 }
 
 static void build_iv(unsigned char *iv)
@@ -627,7 +628,7 @@
 				dundi_ie_append_cause(&amp;ied, DUNDI_IE_CAUSE, DUNDI_CAUSE_DUPLICATE, &quot;Duplicate Request Pending&quot;);
 		}
 	}
-	ast_mutex_lock(&amp;peerlock);
+	AST_LIST_LOCK(&amp;peers);
 	/* Truncate if &quot;don't ask&quot; isn't present */
 	if (!ast_test_flag_nonstd(&amp;hmd, DUNDI_HINT_DONT_ASK))
 		hmd.exten[0] = '\0';
@@ -647,7 +648,7 @@
 		dundi_send(st-&gt;trans, DUNDI_COMMAND_DPRESPONSE, 0, 1, &amp;ied);
 		st-&gt;trans-&gt;thread = 0;
 	}
-	ast_mutex_unlock(&amp;peerlock);
+	AST_LIST_UNLOCK(&amp;peers);
 	free(st);
 	return NULL;	
 }
@@ -666,7 +667,7 @@
 	/* Now produce precache */
 	dundi_precache_internal(st-&gt;called_context, st-&gt;called_number, st-&gt;ttl, st-&gt;eids);
 
-	ast_mutex_lock(&amp;peerlock);
+	AST_LIST_LOCK(&amp;peers);
 	/* Truncate if &quot;don't ask&quot; isn't present */
 	if (!ast_test_flag_nonstd(&amp;hmd, DUNDI_HINT_DONT_ASK))
 		hmd.exten[0] = '\0';
@@ -678,7 +679,7 @@
 		dundi_send(st-&gt;trans, DUNDI_COMMAND_PRECACHERP, 0, 1, &amp;ied);
 		st-&gt;trans-&gt;thread = 0;
 	}
-	ast_mutex_unlock(&amp;peerlock);
+	AST_LIST_UNLOCK(&amp;peers);
 	free(st);
 	return NULL;	
 }
@@ -713,7 +714,7 @@
 		/* If we do not have a canonical result, keep looking */
 		res = dundi_query_eid_internal(&amp;dei, st-&gt;called_context, &amp;st-&gt;reqeid, &amp;hmd, st-&gt;ttl, 1, st-&gt;eids);
 	}
-	ast_mutex_lock(&amp;peerlock);
+	AST_LIST_LOCK(&amp;peers);
 	if (ast_test_flag(st-&gt;trans, FLAG_DEAD)) {
 		ast_log(LOG_DEBUG, &quot;Our transaction went away!\n&quot;);
 		st-&gt;trans-&gt;thread = 0;
@@ -734,7 +735,7 @@
 		dundi_send(st-&gt;trans, DUNDI_COMMAND_EIDRESPONSE, 0, 1, &amp;ied);
 		st-&gt;trans-&gt;thread = 0;
 	}
-	ast_mutex_unlock(&amp;peerlock);
+	AST_LIST_UNLOCK(&amp;peers);
 	free(st);
 	return NULL;	
 }
@@ -951,11 +952,9 @@
 	totallen = sizeof(struct dundi_query_state);
 	/* Count matching map entries */
 	mapcount = 0;
-	cur = mappings;
-	while(cur) {
+	AST_LIST_TRAVERSE(&amp;mappings, cur, list) {
 		if (!strcasecmp(cur-&gt;dcontext, ccontext))
 			mapcount++;
-		cur = cur-&gt;next;
 	}
 	
 	/* If no maps, return -1 immediately */
@@ -994,16 +993,14 @@
 		/* Append mappings */
 		x = 0;
 		st-&gt;maps = (struct dundi_mapping *)s;
-		cur = mappings;
-		while(cur) {
+		AST_LIST_TRAVERSE(&amp;mappings, cur, list) {
 			if (!strcasecmp(cur-&gt;dcontext, ccontext)) {
 				if (x &lt; mapcount) {
 					st-&gt;maps[x] = *cur;
-					st-&gt;maps[x].next = NULL;
+					st-&gt;maps[x].list.next = NULL;
 					x++;
 				}
 			}
-			cur = cur-&gt;next;
 		}
 		st-&gt;nummaps = mapcount;
 		ast_log(LOG_DEBUG, &quot;Forwarding precache for '%s@%s'!\n&quot;, ies-&gt;called_number, ies-&gt;called_context);
@@ -1037,19 +1034,16 @@
 	struct dundi_ie_data ied;
 	char *s;
 	struct dundi_mapping *cur;
-	int mapcount;
+	int mapcount = 0;
 	int skipfirst = 0;
 	
 	pthread_t lookupthread;
 	pthread_attr_t attr;
 	totallen = sizeof(struct dundi_query_state);
 	/* Count matching map entries */
-	mapcount = 0;
-	cur = mappings;
-	while(cur) {
+	AST_LIST_TRAVERSE(&amp;mappings, cur, list) {
 		if (!strcasecmp(cur-&gt;dcontext, ccontext))
 			mapcount++;
-		cur = cur-&gt;next;
 	}
 	/* If no maps, return -1 immediately */
 	if (!mapcount)
@@ -1086,16 +1080,14 @@
 		/* Append mappings */
 		x = 0;
 		st-&gt;maps = (struct dundi_mapping *)s;
-		cur = mappings;
-		while(cur) {
+		AST_LIST_TRAVERSE(&amp;mappings, cur, list) {
 			if (!strcasecmp(cur-&gt;dcontext, ccontext)) {
 				if (x &lt; mapcount) {
 					st-&gt;maps[x] = *cur;
-					st-&gt;maps[x].next = NULL;
+					st-&gt;maps[x].list.next = NULL;
 					x++;
 				}
 			}
-			cur = cur-&gt;next;
 		}
 		st-&gt;nummaps = mapcount;
 		ast_log(LOG_DEBUG, &quot;Answering query for '%s@%s'!\n&quot;, ies-&gt;called_number, ies-&gt;called_context);
@@ -1269,11 +1261,11 @@
 		trans-&gt;autokilltimeout = global_autokilltimeout;
 }
 
+/*! \note Called with the peers list already locked */
 static int do_register_expire(void *data)
 {
 	struct dundi_peer *peer = data;
 	char eid_str[20];
-	/* Called with peerlock already held */
 	ast_log(LOG_DEBUG, &quot;Register expired for '%s'\n&quot;, dundi_eid_to_str(eid_str, sizeof(eid_str), &amp;peer-&gt;eid));
 	peer-&gt;registerexpire = -1;
 	peer-&gt;lastms = 0;
@@ -1989,9 +1981,9 @@
 	h = (struct dundi_hdr *)buf;
 	if (dundidebug)
 		dundi_showframe(h, 1, &amp;sin, res - sizeof(struct dundi_hdr));
-	ast_mutex_lock(&amp;peerlock);
+	AST_LIST_LOCK(&amp;peers);
 	handle_frame(h, &amp;sin, res - sizeof(struct dundi_hdr));
-	ast_mutex_unlock(&amp;peerlock);
+	AST_LIST_UNLOCK(&amp;peers);
 	return 1;
 }
 
@@ -2092,9 +2084,9 @@
 			res = 1000;
 		res = ast_io_wait(io, res);
 		if (res &gt;= 0) {
-			ast_mutex_lock(&amp;peerlock);
+			AST_LIST_LOCK(&amp;peers);
 			ast_sched_runq(sched);
-			ast_mutex_unlock(&amp;peerlock);
+			AST_LIST_UNLOCK(&amp;peers);
 		}
 		check_password();
 	}
@@ -2162,7 +2154,7 @@
 
 static int dundi_flush(int fd, int argc, char *argv[])
 {
-	int stats=0;
+	int stats = 0;
 	if ((argc &lt; 2) || (argc &gt; 3))
 		return RESULT_SHOWUSAGE;
 	if (argc &gt; 2) {
@@ -2175,19 +2167,17 @@
 		/* Flush statistics */
 		struct dundi_peer *p;
 		int x;
-		ast_mutex_lock(&amp;peerlock);
-		p = peers;
-		while(p) {
-			for (x=0;x&lt;DUNDI_TIMING_HISTORY;x++) {
+		AST_LIST_LOCK(&amp;peers);
+		AST_LIST_TRAVERSE(&amp;peers, p, list) {
+			for (x = 0;x &lt; DUNDI_TIMING_HISTORY; x++) {
 				if (p-&gt;lookups[x])
 					free(p-&gt;lookups[x]);
 				p-&gt;lookups[x] = NULL;
 				p-&gt;lookuptimes[x] = 0;
 			}
 			p-&gt;avgms = 0;
-			p = p-&gt;next;
 		}
-		ast_mutex_unlock(&amp;peerlock);
+		AST_LIST_UNLOCK(&amp;peers);
 	} else {
 		ast_db_deltree(&quot;dundi/cache&quot;, NULL);
 		ast_cli(fd, &quot;DUNDi Cache Flushed\n&quot;);
@@ -2236,14 +2226,14 @@
 
 	if (pos != rpos)
 		return NULL;
-	ast_mutex_lock(&amp;peerlock);
+	AST_LIST_LOCK(&amp;peers);
 	len = strlen(word);
-	for (p = peers; !ret &amp;&amp; p; p = p-&gt;next) {
+	AST_LIST_TRAVERSE(&amp;peers, p, list) {
 		const char *s = dundi_eid_to_str(eid_str, sizeof(eid_str), &amp;p-&gt;eid);
 		if (!strncasecmp(word, s, len) &amp;&amp; ++which &gt; state)
 			ret = ast_strdup(s);
 	}
-	ast_mutex_unlock(&amp;peerlock);
+	AST_LIST_UNLOCK(&amp;peers);
 	return ret;
 }
 
@@ -2384,12 +2374,10 @@
 	
 	if (argc != 4)
 		return RESULT_SHOWUSAGE;
-	ast_mutex_lock(&amp;peerlock);
-	peer = peers;
-	while(peer) {
+	AST_LIST_LOCK(&amp;peers);
+	AST_LIST_TRAVERSE(&amp;peers, peer, list) {
 		if (!strcasecmp(dundi_eid_to_str(eid_str, sizeof(eid_str), &amp;peer-&gt;eid), argv[3]))
 			break;
-		peer = peer-&gt;next;
 	}
 	if (peer) {
 		switch(peer-&gt;order) {
@@ -2445,7 +2433,7 @@
 			ast_cli(fd, &quot;Average query time: %d ms\n&quot;, peer-&gt;avgms);
 	} else
 		ast_cli(fd, &quot;No such peer '%s'\n&quot;, argv[3]);
-	ast_mutex_unlock(&amp;peerlock);
+	AST_LIST_UNLOCK(&amp;peers);
 	return RESULT_SUCCESS;
 }
 
@@ -2471,9 +2459,9 @@
 		} else
 			return RESULT_SHOWUSAGE;
  	}
-	ast_mutex_lock(&amp;peerlock);
+	AST_LIST_LOCK(&amp;peers);
 	ast_cli(fd, FORMAT2, &quot;EID&quot;, &quot;Host&quot;, &quot;Model&quot;, &quot;AvgTime&quot;, &quot;Status&quot;);
-	for (peer = peers;peer;peer = peer-&gt;next) {
+	AST_LIST_TRAVERSE(&amp;peers, peer, list) {
 		char status[20];
 		int print_line = -1;
 		char srch[2000];
@@ -2528,7 +2516,7 @@
 		}
 	}
 	ast_cli(fd, &quot;%d dundi peers [%d online, %d offline, %d unmonitored]\n&quot;, total_peers, online_peers, offline_peers, unmonitored_peers);
-	ast_mutex_unlock(&amp;peerlock);
+	AST_LIST_UNLOCK(&amp;peers);
 	return RESULT_SUCCESS;
 #undef FORMAT
 #undef FORMAT2
@@ -2542,13 +2530,13 @@
 	char iabuf[INET_ADDRSTRLEN];
 	if (argc != 3)
 		return RESULT_SHOWUSAGE;
-	ast_mutex_lock(&amp;peerlock);
+	AST_LIST_LOCK(&amp;peers);
 	ast_cli(fd, FORMAT2, &quot;Remote&quot;, &quot;Src&quot;, &quot;Dst&quot;, &quot;Tx&quot;, &quot;Rx&quot;, &quot;Ack&quot;);
 	for (trans = alltrans;trans;trans = trans-&gt;allnext) {
 			ast_cli(fd, FORMAT, ast_inet_ntoa(iabuf, sizeof(iabuf), trans-&gt;addr.sin_addr), 
 					ntohs(trans-&gt;addr.sin_port), trans-&gt;strans, trans-&gt;dtrans, trans-&gt;oseqno, trans-&gt;iseqno, trans-&gt;aseqno);
 	}
-	ast_mutex_unlock(&amp;peerlock);
+	AST_LIST_UNLOCK(&amp;peers);
 	return RESULT_SUCCESS;
 #undef FORMAT
 #undef FORMAT2
@@ -2559,9 +2547,9 @@
 	char eid_str[20];
 	if (argc != 3)
 		return RESULT_SHOWUSAGE;
-	ast_mutex_lock(&amp;peerlock);
+	AST_LIST_LOCK(&amp;peers);
 	dundi_eid_to_str(eid_str, sizeof(eid_str), &amp;global_eid);
-	ast_mutex_unlock(&amp;peerlock);
+	AST_LIST_UNLOCK(&amp;peers);
 	ast_cli(fd, &quot;Global EID for this system is '%s'\n&quot;, eid_str);
 	return RESULT_SUCCESS;
 }
@@ -2574,13 +2562,13 @@
 	char eidstr[20];
 	if (argc != 3)
 		return RESULT_SHOWUSAGE;
-	ast_mutex_lock(&amp;peerlock);
+	AST_LIST_LOCK(&amp;peers);
 	ast_cli(fd, FORMAT2, &quot;Number&quot;, &quot;Context&quot;, &quot;Root&quot;, &quot;Max&quot;, &quot;Rsp&quot;);
-	for (req = requests;req;req = req-&gt;next) {
-			ast_cli(fd, FORMAT, req-&gt;number, req-&gt;dcontext,
-						dundi_eid_zero(&amp;req-&gt;root_eid) ? &quot;&lt;unspecified&gt;&quot; : dundi_eid_to_str(eidstr, sizeof(eidstr), &amp;req-&gt;root_eid), req-&gt;maxcount, req-&gt;respcount);
+	AST_LIST_TRAVERSE(&amp;requests, req, list) {
+		ast_cli(fd, FORMAT, req-&gt;number, req-&gt;dcontext,
+			dundi_eid_zero(&amp;req-&gt;root_eid) ? &quot;&lt;unspecified&gt;&quot; : dundi_eid_to_str(eidstr, sizeof(eidstr), &amp;req-&gt;root_eid), req-&gt;maxcount, req-&gt;respcount);
 	}
-	ast_mutex_unlock(&amp;peerlock);
+	AST_LIST_UNLOCK(&amp;peers);
 	return RESULT_SUCCESS;
 #undef FORMAT
 #undef FORMAT2
@@ -2596,14 +2584,14 @@
 	char fs[256];
 	if (argc != 3)
 		return RESULT_SHOWUSAGE;
-	ast_mutex_lock(&amp;peerlock);
+	AST_LIST_LOCK(&amp;peers);
 	ast_cli(fd, FORMAT2, &quot;DUNDi Cntxt&quot;, &quot;Weight&quot;, &quot;Local Cntxt&quot;, &quot;Options&quot;, &quot;Tech&quot;, &quot;Destination&quot;);
-	for (map = mappings;map;map = map-&gt;next) {
-			ast_cli(fd, FORMAT, map-&gt;dcontext, map-&gt;weight, 
-			                    ast_strlen_zero(map-&gt;lcontext) ? &quot;&lt;none&gt;&quot; : map-&gt;lcontext, 
-								dundi_flags2str(fs, sizeof(fs), map-&gt;options), tech2str(map-&gt;tech), map-&gt;dest);
+	AST_LIST_TRAVERSE(&amp;mappings, map, list) {
+		ast_cli(fd, FORMAT, map-&gt;dcontext, map-&gt;weight, 
+			ast_strlen_zero(map-&gt;lcontext) ? &quot;&lt;none&gt;&quot; : map-&gt;lcontext, 
+			dundi_flags2str(fs, sizeof(fs), map-&gt;options), tech2str(map-&gt;tech), map-&gt;dest);
 	}
-	ast_mutex_unlock(&amp;peerlock);
+	AST_LIST_UNLOCK(&amp;peers);
 	return RESULT_SUCCESS;
 #undef FORMAT
 #undef FORMAT2
@@ -2839,8 +2827,7 @@
 	int cnt;
 	char eid_str[20];
 	if (ast_test_flag(trans, FLAG_ISREG | FLAG_ISQUAL | FLAG_STOREHIST)) {
-		peer = peers;
-		while (peer) {
+		AST_LIST_TRAVERSE(&amp;peers, peer, list) {
 			if (peer-&gt;regtrans == trans)
 				peer-&gt;regtrans = NULL;
 			if (peer-&gt;keypending == trans)
@@ -2891,7 +2878,6 @@
 					}
 				}
 			}
-			peer = peer-&gt;next;
 		}
 	}
 	if (trans-&gt;parent) {
@@ -2949,7 +2935,7 @@
 	struct dundi_packet *pack;
 	char iabuf[INET_ADDRSTRLEN];
 	int res;
-	ast_mutex_lock(&amp;peerlock);
+	AST_LIST_LOCK(&amp;peers);
 	pack = data;
 	if (pack-&gt;retrans &lt; 1) {
 		pack-&gt;retransid = -1;
@@ -2965,7 +2951,7 @@
 		dundi_xmit(pack);
 		res = 1;
 	}
-	ast_mutex_unlock(&amp;peerlock);
+	AST_LIST_UNLOCK(&amp;peers);
 	return res;
 }
 
@@ -3060,9 +3046,8 @@
 		dundi_ie_append_eid(ied, DUNDI_IE_EID_DIRECT, eid);
 		return;
 	}
-	ast_mutex_lock(&amp;peerlock);
-	p = peers;
-	while(p) {
+	AST_LIST_LOCK(&amp;peers);
+	AST_LIST_TRAVERSE(&amp;peers, p, list) {
 		if (!dundi_eid_cmp(&amp;p-&gt;eid, eid)) {
 			if (has_permission(p-&gt;include, context))
 				dundi_ie_append_eid(ied, DUNDI_IE_EID_DIRECT, eid);
@@ -3070,11 +3055,10 @@
 				dundi_ie_append_eid(ied, DUNDI_IE_EID, eid);
 			break;
 		}
-		p = p-&gt;next;
 	}
 	if (!p)
 		dundi_ie_append_eid(ied, DUNDI_IE_EID, eid);
-	ast_mutex_unlock(&amp;peerlock);
+	AST_LIST_UNLOCK(&amp;peers);
 }
 
 static int dundi_discover(struct dundi_transaction *trans)
@@ -3192,13 +3176,13 @@
 static int discover_transactions(struct dundi_request *dr)
 {
 	struct dundi_transaction *trans;
-	ast_mutex_lock(&amp;peerlock);
+	AST_LIST_LOCK(&amp;peers);
 	trans = dr-&gt;trans;
 	while(trans) {
 		dundi_discover(trans);
 		trans = trans-&gt;next;
 	}
-	ast_mutex_unlock(&amp;peerlock);
+	AST_LIST_UNLOCK(&amp;peers);
 	return 0;
 }
 
@@ -3206,7 +3190,7 @@
 {
 	struct dundi_transaction *trans, *transn;
 	/* Mark all as &quot;in thread&quot; so they don't disappear */
-	ast_mutex_lock(&amp;peerlock);
+	AST_LIST_LOCK(&amp;peers);
 	trans = dr-&gt;trans;
 	while(trans) {
 		if (trans-&gt;thread)
@@ -3214,7 +3198,7 @@
 		trans-&gt;thread = 1;
 		trans = trans-&gt;next;
 	}
-	ast_mutex_unlock(&amp;peerlock);
+	AST_LIST_UNLOCK(&amp;peers);
 
 	trans = dr-&gt;trans;
 	while(trans) {
@@ -3224,7 +3208,7 @@
 	}
 
 	/* Cleanup any that got destroyed in the mean time */
-	ast_mutex_lock(&amp;peerlock);
+	AST_LIST_LOCK(&amp;peers);
 	trans = dr-&gt;trans;
 	while(trans) {
 		transn = trans-&gt;next;
@@ -3235,20 +3219,20 @@
 		}
 		trans = transn;
 	}
-	ast_mutex_unlock(&amp;peerlock);
+	AST_LIST_UNLOCK(&amp;peers);
 	return 0;
 }
 
 static int query_transactions(struct dundi_request *dr)
 {
 	struct dundi_transaction *trans;
-	ast_mutex_lock(&amp;peerlock);
+	AST_LIST_LOCK(&amp;peers);
 	trans = dr-&gt;trans;
 	while(trans) {
 		dundi_query(trans);
 		trans = trans-&gt;next;
 	}
-	ast_mutex_unlock(&amp;peerlock);
+	AST_LIST_UNLOCK(&amp;peers);
 	return 0;
 }
 
@@ -3261,7 +3245,7 @@
 	dundi_eid tmp;
 	int x;
 	int needpush;
-	ast_mutex_lock(&amp;peerlock);
+	AST_LIST_LOCK(&amp;peers);
 	trans = dr-&gt;trans;
 	while(trans) {
 		/* Pop off the true root */
@@ -3273,8 +3257,7 @@
 			needpush = 0;
 		}
 
-		peer = peers;
-		while(peer) {
+		AST_LIST_TRAVERSE(&amp;peers, peer, list) {
 			if (has_permission(peer-&gt;include, dr-&gt;dcontext) &amp;&amp; 
 			    dundi_eid_cmp(&amp;peer-&gt;eid, &amp;trans-&gt;them_eid) &amp;&amp;
 				(peer-&gt;order &lt;= order)) {
@@ -3299,14 +3282,13 @@
 					}
 				}
 			}
-			peer = peer-&gt;next;
 		}
 		/* If necessary, push the true root back on the end */
 		if (needpush)
 			trans-&gt;eids[trans-&gt;eidcount++] = tmp;
 		trans = trans-&gt;next;
 	}
-	ast_mutex_unlock(&amp;peerlock);
+	AST_LIST_UNLOCK(&amp;peers);
 	return 0;
 }
 
@@ -3342,7 +3324,7 @@
 {
 	struct dundi_transaction *trans, *next;
 
-	ast_mutex_lock(&amp;peerlock);
+	AST_LIST_LOCK(&amp;peers);
 	trans = dr-&gt;trans;
 	
 	while(trans) {
@@ -3354,15 +3336,15 @@
 		dundi_send(trans, DUNDI_COMMAND_CANCEL, 0, 1, NULL);
 		trans = next;
 	}
-	ast_mutex_unlock(&amp;peerlock);
+	AST_LIST_UNLOCK(&amp;peers);
 }
 
 static void abort_request(struct dundi_request *dr)
 {
-	ast_mutex_lock(&amp;peerlock);
+	AST_LIST_LOCK(&amp;peers);
 	while(dr-&gt;trans) 
 		destroy_trans(dr-&gt;trans, 0);
-	ast_mutex_unlock(&amp;peerlock);
+	AST_LIST_UNLOCK(&amp;peers);
 }
 
 static void build_transactions(struct dundi_request *dr, int ttl, int order, int *foundcache, int *skipped, int blockempty, int nocache, int modeselect, dundi_eid *skip, dundi_eid *avoid[], int directs[])
@@ -3373,9 +3355,8 @@
 	int pass;
 	int allowconnect;
 	char eid_str[20];
-	ast_mutex_lock(&amp;peerlock);
-	p = peers;
-	while(p) {
+	AST_LIST_LOCK(&amp;peers);
+	AST_LIST_TRAVERSE(&amp;peers, p, list) {
 		if (modeselect == 1) {
 			/* Send the precache to push upstreams only! */
 			pass = has_permission(p-&gt;permit, dr-&gt;dcontext) &amp;&amp; (p-&gt;pcmodel &amp; DUNDI_MODEL_OUTBOUND);
@@ -3419,9 +3400,8 @@
 			} else if (!*skipped || (p-&gt;order &lt; *skipped))
 				*skipped = p-&gt;order;
 		}
-		p = p-&gt;next;
 	}
-	ast_mutex_unlock(&amp;peerlock);
+	AST_LIST_UNLOCK(&amp;peers);
 }
 
 static int register_request(struct dundi_request *dr, struct dundi_request **pending)
@@ -3429,70 +3409,51 @@
 	struct dundi_request *cur;
 	int res=0;
 	char eid_str[20];
-	ast_mutex_lock(&amp;peerlock);
-	cur = requests;
-	while(cur) {
+	AST_LIST_LOCK(&amp;peers);
+	AST_LIST_TRAVERSE(&amp;requests, cur, list) {
 		if (option_debug)
 			ast_log(LOG_DEBUG, &quot;Checking '%s@%s' vs '%s@%s'\n&quot;, cur-&gt;dcontext, cur-&gt;number,
 				dr-&gt;dcontext, dr-&gt;number);
 		if (!strcasecmp(cur-&gt;dcontext, dr-&gt;dcontext) &amp;&amp;
 		    !strcasecmp(cur-&gt;number, dr-&gt;number) &amp;&amp;
-			(!dundi_eid_cmp(&amp;cur-&gt;root_eid, &amp;dr-&gt;root_eid) || (cur-&gt;crc32 == dr-&gt;crc32))) {
-				ast_log(LOG_DEBUG, &quot;Found existing query for '%s@%s' for '%s' crc '%08lx'\n&quot;, 
-					cur-&gt;dcontext, cur-&gt;number, dundi_eid_to_str(eid_str, sizeof(eid_str), &amp;cur-&gt;root_eid), cur-&gt;crc32);
-				*pending = cur;
+		    (!dundi_eid_cmp(&amp;cur-&gt;root_eid, &amp;dr-&gt;root_eid) || (cur-&gt;crc32 == dr-&gt;crc32))) {
+			ast_log(LOG_DEBUG, &quot;Found existing query for '%s@%s' for '%s' crc '%08lx'\n&quot;, 
+				cur-&gt;dcontext, cur-&gt;number, dundi_eid_to_str(eid_str, sizeof(eid_str), &amp;cur-&gt;root_eid), cur-&gt;crc32);
+			*pending = cur;
 			res = 1;
 			break;
 		}
-		cur = cur-&gt;next;
 	}
 	if (!res) {
 		ast_log(LOG_DEBUG, &quot;Registering request for '%s@%s' on behalf of '%s' crc '%08lx'\n&quot;, 
 				dr-&gt;number, dr-&gt;dcontext, dundi_eid_to_str(eid_str, sizeof(eid_str), &amp;dr-&gt;root_eid), dr-&gt;crc32);
 		/* Go ahead and link us in since nobody else is searching for this */
-		dr-&gt;next = requests;
-		requests = dr;
+		AST_LIST_INSERT_HEAD(&amp;requests, dr, list);
 		*pending = NULL;
 	}
-	ast_mutex_unlock(&amp;peerlock);
+	AST_LIST_UNLOCK(&amp;peers);
 	return res;
 }
 
 static void unregister_request(struct dundi_request *dr)
 {
-	struct dundi_request *cur, *prev;
-	ast_mutex_lock(&amp;peerlock);
-	prev = NULL;
-	cur = requests;
-	while(cur) {
-		if (cur == dr) {
-			if (prev)
-				prev-&gt;next = cur-&gt;next;
-			else
-				requests = cur-&gt;next;
-			break;
-		}
-		prev = cur;
-		cur = cur-&gt;next;
-	}
-	ast_mutex_unlock(&amp;peerlock);
+	AST_LIST_LOCK(&amp;peers);
+	AST_LIST_REMOVE(&amp;requests, dr, list);
+	AST_LIST_UNLOCK(&amp;peers);
 }
 
 static int check_request(struct dundi_request *dr)
 {
 	struct dundi_request *cur;
-	int res = 0;
-	ast_mutex_lock(&amp;peerlock);
-	cur = requests;
-	while(cur) {
-		if (cur == dr) {
-			res = 1;
+
+	AST_LIST_LOCK(&amp;peers);
+	AST_LIST_TRAVERSE(&amp;requests, cur, list) {
+		if (cur == dr)
 			break;
-		}
-		cur = cur-&gt;next;
 	}
-	ast_mutex_unlock(&amp;peerlock);
-	return res;
+	AST_LIST_UNLOCK(&amp;peers);
+	
+	return cur ? 1 : 0;
 }
 
 static unsigned long avoid_crc32(dundi_eid *avoid[])
@@ -3672,17 +3633,17 @@
 	struct dundi_mapping *cur;
 	struct ast_context *con;
 	struct ast_exten *e;
-	cur = mappings;
-	while(cur) {
+
+	AST_LIST_TRAVERSE(&amp;mappings, cur, list) {
 		ast_log(LOG_NOTICE, &quot;Should precache context '%s'\n&quot;, cur-&gt;dcontext);
 		ast_lock_contexts();
 		con = ast_walk_contexts(NULL);
-		while(con) {
+		while (con) {
 			if (!strcasecmp(cur-&gt;lcontext, ast_get_context_name(con))) {
 				/* Found the match, now queue them all up */
 				ast_lock_context(con);
 				e = ast_walk_context_extensions(con, NULL);
-				while(e) {
+				while (e) {
 					reschedule_precache(ast_get_extension_name(e), cur-&gt;dcontext, 0);
 					e = ast_walk_context_extensions(con, e);
 				}
@@ -3691,7 +3652,6 @@
 			con = ast_walk_contexts(con);
 		}
 		ast_unlock_contexts();
-		cur = cur-&gt;next;
 	}
 }
 
@@ -3701,35 +3661,30 @@
 	struct dundi_hint_metadata hmd;
 	struct dundi_result dr2[MAX_RESULTS];
 	struct timeval start;
-	struct dundi_mapping *maps=NULL, *cur;
-	int nummaps;
+	struct dundi_mapping *maps = NULL, *cur;
+	int nummaps = 0;
 	int foundanswers;
 	int foundcache, skipped, ttlms, ms;
 	if (!context)
 		context = &quot;e164&quot;;
 	ast_log(LOG_DEBUG, &quot;Precache internal (%s@%s)!\n&quot;, number, context);
 
-	ast_mutex_lock(&amp;peerlock);
-	nummaps = 0;
-	cur = mappings;
-	while(cur) {
+	AST_LIST_LOCK(&amp;peers);
+	AST_LIST_TRAVERSE(&amp;mappings, cur, list) {
 		if (!strcasecmp(cur-&gt;dcontext, context))
 			nummaps++;
-		cur = cur-&gt;next;
 	}
 	if (nummaps) {
-		maps = alloca(nummaps * sizeof(struct dundi_mapping));
+		maps = alloca(nummaps * sizeof(*maps));
 		nummaps = 0;
 		if (maps) {
-			cur = mappings;
-			while(cur) {
+			AST_LIST_TRAVERSE(&amp;mappings, cur, list) {
 				if (!strcasecmp(cur-&gt;dcontext, context))
 					maps[nummaps++] = *cur;
-				cur = cur-&gt;next;
 			}
 		}
 	}
-	ast_mutex_unlock(&amp;peerlock);
+	AST_LIST_UNLOCK(&amp;peers);
 	if (!nummaps || !maps)
 		return -1;
 	ttlms = DUNDI_FLUFF_TIME + ttl * DUNDI_TTL_TIME;
@@ -3900,25 +3855,22 @@
 static void mark_peers(void)
 {
 	struct dundi_peer *peer;
-	ast_mutex_lock(&amp;peerlock);
-	peer = peers;
-	while(peer) {
+	AST_LIST_LOCK(&amp;peers);
+	AST_LIST_TRAVERSE(&amp;peers, peer, list) {
 		peer-&gt;dead = 1;
-		peer = peer-&gt;next;
 	}
-	ast_mutex_unlock(&amp;peerlock);
+	AST_LIST_UNLOCK(&amp;peers);
 }
 
 static void mark_mappings(void)
 {
 	struct dundi_mapping *map;
-	ast_mutex_lock(&amp;peerlock);
-	map = mappings;
-	while(map) {
+	
+	AST_LIST_LOCK(&amp;peers);
+	AST_LIST_TRAVERSE(&amp;mappings, map, list) {
 		map-&gt;dead = 1;
-		map = map-&gt;next;
 	}
-	ast_mutex_unlock(&amp;peerlock);
+	AST_LIST_UNLOCK(&amp;peers);
 }
 
 static void destroy_permissions(struct permission *p)
@@ -3953,44 +3905,32 @@
 
 static void prune_peers(void)
 {
-	struct dundi_peer *peer, *prev, *next;
-	ast_mutex_lock(&amp;peerlock);
-	peer = peers;
-	prev = NULL;
-	while(peer) {
-		next = peer-&gt;next;
+	struct dundi_peer *peer;
+
+	AST_LIST_LOCK(&amp;peers);
+	AST_LIST_TRAVERSE_SAFE_BEGIN(&amp;peers, peer, list) {
 		if (peer-&gt;dead) {
-			if (prev)
-				prev-&gt;next = peer-&gt;next;
-			else
-				peers = peer-&gt;next;
+			AST_LIST_REMOVE_CURRENT(&amp;peers, list);
 			destroy_peer(peer);
-		} else
-			prev = peer;
-		peer = next;
+		}
 	}
-	ast_mutex_unlock(&amp;peerlock);
+	AST_LIST_TRAVERSE_SAFE_END
+	AST_LIST_UNLOCK(&amp;peers);
 }
 
 static void prune_mappings(void)
 {
-	struct dundi_mapping *map, *prev, *next;
-	ast_mutex_lock(&amp;peerlock);
-	map = mappings;
-	prev = NULL;
-	while(map) {
-		next = map-&gt;next;
+	struct dundi_mapping *map;
+
+	AST_LIST_LOCK(&amp;peers);
+	AST_LIST_TRAVERSE_SAFE_BEGIN(&amp;mappings, map, list) {
 		if (map-&gt;dead) {
-			if (prev)
-				prev-&gt;next = map-&gt;next;
-			else
-				mappings = map-&gt;next;
+			AST_LIST_REMOVE_CURRENT(&amp;mappings, list);
 			destroy_map(map);
-		} else
-			prev = map;
-		map = next;
+		}
 	}
-	ast_mutex_unlock(&amp;peerlock);
+	AST_LIST_TRAVERSE_SAFE_END
+	AST_LIST_UNLOCK(&amp;peers);
 }
 
 static struct permission *append_permission(struct permission *p, char *s, int allow)
@@ -4023,83 +3963,77 @@
 	struct dundi_mapping *map;
 	int x;
 	int y;
-	t = ast_strdupa(value);
-	if (t) {
-		map = mappings;
-		while(map) {
-			/* Find a double match */
-			if (!strcasecmp(map-&gt;dcontext, name) &amp;&amp; 
-				(!strncasecmp(map-&gt;lcontext, value, strlen(map-&gt;lcontext)) &amp;&amp; 
-				  (!value[strlen(map-&gt;lcontext)] || 
-				   (value[strlen(map-&gt;lcontext)] == ','))))
-				break;
-			map = map-&gt;next;
+
+	if (!(t = ast_strdupa(value)))
+		return;
+		
+	AST_LIST_TRAVERSE(&amp;mappings, map, list) {
+		/* Find a double match */
+		if (!strcasecmp(map-&gt;dcontext, name) &amp;&amp; 
+			(!strncasecmp(map-&gt;lcontext, value, strlen(map-&gt;lcontext)) &amp;&amp; 
+			  (!value[strlen(map-&gt;lcontext)] || 
+			   (value[strlen(map-&gt;lcontext)] == ','))))
+			break;
+	}
+	if (!map) {
+		if (!(map = ast_calloc(1, sizeof(*map))))
+			return;
+		AST_LIST_INSERT_HEAD(&amp;mappings, map, list);
+		map-&gt;dead = 1;
+	}
+	map-&gt;options = 0;
+	memset(fields, 0, sizeof(fields));
+	x = 0;
+	while (t &amp;&amp; x &lt; MAX_OPTS) {
+		fields[x++] = t;
+		t = strchr(t, ',');
+		if (t) {
+			*t = '\0';
+			t++;
 		}
-		if (!map) {
-			map = malloc(sizeof(struct dundi_mapping));
-			if (map) {
-				memset(map, 0, sizeof(struct dundi_mapping));
-				map-&gt;next = mappings;
-				mappings = map;
-				map-&gt;dead = 1;
+	} /* Russell was here, arrrr! */
+	if ((x == 1) &amp;&amp; ast_strlen_zero(fields[0])) {
+		/* Placeholder mapping */
+		ast_copy_string(map-&gt;dcontext, name, sizeof(map-&gt;dcontext));
+		map-&gt;dead = 0;
+	} else if (x &gt;= 4) {
+		ast_copy_string(map-&gt;dcontext, name, sizeof(map-&gt;dcontext));
+		ast_copy_string(map-&gt;lcontext, fields[0], sizeof(map-&gt;lcontext));
+		if ((sscanf(fields[1], &quot;%d&quot;, &amp;map-&gt;weight) == 1) &amp;&amp; (map-&gt;weight &gt;= 0) &amp;&amp; (map-&gt;weight &lt; 60000)) {
+			ast_copy_string(map-&gt;dest, fields[3], sizeof(map-&gt;dest));
+			if ((map-&gt;tech = str2tech(fields[2]))) {
+				map-&gt;dead = 0;
 			}
+		} else {
+			ast_log(LOG_WARNING, &quot;Invalid weight '%s' specified, deleting entry '%s/%s'\n&quot;, fields[1], map-&gt;dcontext, map-&gt;lcontext);
 		}
-		if (map) {
-			map-&gt;options = 0;
-			memset(fields, 0, sizeof(fields));
-			x = 0;
-			while(t &amp;&amp; x &lt; MAX_OPTS) {
-				fields[x++] = t;
-				t = strchr(t, ',');
-				if (t) {
-					*t = '\0';
-					t++;
-				}
-			} /* Russell was here, arrrr! */
-			if ((x == 1) &amp;&amp; ast_strlen_zero(fields[0])) {
-				/* Placeholder mapping */
-				ast_copy_string(map-&gt;dcontext, name, sizeof(map-&gt;dcontext));
-				map-&gt;dead = 0;
-			} else if (x &gt;= 4) {
-				ast_copy_string(map-&gt;dcontext, name, sizeof(map-&gt;dcontext));
-				ast_copy_string(map-&gt;lcontext, fields[0], sizeof(map-&gt;lcontext));
-				if ((sscanf(fields[1], &quot;%d&quot;, &amp;map-&gt;weight) == 1) &amp;&amp; (map-&gt;weight &gt;= 0) &amp;&amp; (map-&gt;weight &lt; 60000)) {
-					ast_copy_string(map-&gt;dest, fields[3], sizeof(map-&gt;dest));
-					if ((map-&gt;tech = str2tech(fields[2]))) {
-						map-&gt;dead = 0;
-					}
-				} else {
-					ast_log(LOG_WARNING, &quot;Invalid weight '%s' specified, deleting entry '%s/%s'\n&quot;, fields[1], map-&gt;dcontext, map-&gt;lcontext);
-				}
-				for (y=4;y&lt;x;y++) {
-					if (!strcasecmp(fields[y], &quot;nounsolicited&quot;))
-						map-&gt;options |= DUNDI_FLAG_NOUNSOLICITED;
-					else if (!strcasecmp(fields[y], &quot;nocomunsolicit&quot;))
-						map-&gt;options |= DUNDI_FLAG_NOCOMUNSOLICIT;
-					else if (!strcasecmp(fields[y], &quot;residential&quot;))
-						map-&gt;options |= DUNDI_FLAG_RESIDENTIAL;
-					else if (!strcasecmp(fields[y], &quot;commercial&quot;))
-						map-&gt;options |= DUNDI_FLAG_COMMERCIAL;
-					else if (!strcasecmp(fields[y], &quot;mobile&quot;))
-						map-&gt;options |= DUNDI_FLAG_MOBILE;
-					else if (!strcasecmp(fields[y], &quot;nopartial&quot;))
-						map-&gt;options |= DUNDI_FLAG_INTERNAL_NOPARTIAL;
-					else
-						ast_log(LOG_WARNING, &quot;Don't know anything about option '%s'\n&quot;, fields[y]);
-				}
-			} else 
-				ast_log(LOG_WARNING, &quot;Expected at least %d arguments in map, but got only %d\n&quot;, 4, x);
+		for (y = 4;y &lt; x; y++) {
+			if (!strcasecmp(fields[y], &quot;nounsolicited&quot;))
+				map-&gt;options |= DUNDI_FLAG_NOUNSOLICITED;
+			else if (!strcasecmp(fields[y], &quot;nocomunsolicit&quot;))
+				map-&gt;options |= DUNDI_FLAG_NOCOMUNSOLICIT;
+			else if (!strcasecmp(fields[y], &quot;residential&quot;))
+				map-&gt;options |= DUNDI_FLAG_RESIDENTIAL;
+			else if (!strcasecmp(fields[y], &quot;commercial&quot;))
+				map-&gt;options |= DUNDI_FLAG_COMMERCIAL;
+			else if (!strcasecmp(fields[y], &quot;mobile&quot;))
+				map-&gt;options |= DUNDI_FLAG_MOBILE;
+			else if (!strcasecmp(fields[y], &quot;nopartial&quot;))
+				map-&gt;options |= DUNDI_FLAG_INTERNAL_NOPARTIAL;
+			else
+				ast_log(LOG_WARNING, &quot;Don't know anything about option '%s'\n&quot;, fields[y]);
 		}
-	}
+	} else 
+		ast_log(LOG_WARNING, &quot;Expected at least %d arguments in map, but got only %d\n&quot;, 4, x);
 }
 
+/* \note Called with the peers list already locked */
 static int do_register(void *data)
 {
 	struct dundi_ie_data ied;
 	struct dundi_peer *peer = data;
 	char eid_str[20];
 	char eid_str2[20];
-	/* Called with peerlock already held */
 	ast_log(LOG_DEBUG, &quot;Register us as '%s' to '%s'\n&quot;, dundi_eid_to_str(eid_str, sizeof(eid_str), &amp;peer-&gt;us_eid), dundi_eid_to_str(eid_str2, sizeof(eid_str2), &amp;peer-&gt;eid));
 	peer-&gt;registerid = ast_sched_add(sched, default_expiration * 1000, do_register, data);
 	/* Destroy old transaction if there is one */
@@ -4187,151 +4121,145 @@
 	int needregister=0;
 	char eid_str[20];
 
-	ast_mutex_lock(&amp;peerlock);
-	peer = peers;
-	while(peer) {
+	AST_LIST_LOCK(&amp;peers);
+	AST_LIST_TRAVERSE(&amp;peers, peer, list) {
 		if (!dundi_eid_cmp(&amp;peer-&gt;eid, eid)) {	
 			break;
 		}
-		peer = peer-&gt;next;
 	}
 	if (!peer) {
 		/* Add us into the list */
-		peer = malloc(sizeof(struct dundi_peer));
-		if (peer) {
-			memset(peer, 0, sizeof(struct dundi_peer));
-			peer-&gt;registerid = -1;
-			peer-&gt;registerexpire = -1;
-			peer-&gt;qualifyid = -1;
-			peer-&gt;addr.sin_family = AF_INET;
-			peer-&gt;addr.sin_port = htons(DUNDI_PORT);
-			populate_addr(peer, eid);
-			peer-&gt;next = peers;
-			peers = peer;
+		if (!(peer = ast_calloc(1, sizeof(*peer)))) {
+			AST_LIST_UNLOCK(&amp;peers);
+			return;
 		}
-	}
-	if (peer) {
-		peer-&gt;dead = 0;
-		peer-&gt;eid = *eid;
-		peer-&gt;us_eid = global_eid;
-		destroy_permissions(peer-&gt;permit);
-		destroy_permissions(peer-&gt;include);
-		peer-&gt;permit = NULL;
-		peer-&gt;include = NULL;
-		if (peer-&gt;registerid &gt; -1)
-			ast_sched_del(sched, peer-&gt;registerid);
 		peer-&gt;registerid = -1;
-		while(v) {
-			if (!strcasecmp(v-&gt;name, &quot;inkey&quot;)) {
-				ast_copy_string(peer-&gt;inkey, v-&gt;value, sizeof(peer-&gt;inkey));
-			} else if (!strcasecmp(v-&gt;name, &quot;outkey&quot;)) {
-				ast_copy_string(peer-&gt;outkey, v-&gt;value, sizeof(peer-&gt;outkey));
-			} else if (!strcasecmp(v-&gt;name, &quot;host&quot;)) {
-				if (!strcasecmp(v-&gt;value, &quot;dynamic&quot;)) {
-					peer-&gt;dynamic = 1;
+		peer-&gt;registerexpire = -1;
+		peer-&gt;qualifyid = -1;
+		peer-&gt;addr.sin_family = AF_INET;
+		peer-&gt;addr.sin_port = htons(DUNDI_PORT);
+		populate_addr(peer, eid);
+		AST_LIST_INSERT_HEAD(&amp;peers, peer, list);
+	}
+	peer-&gt;dead = 0;
+	peer-&gt;eid = *eid;
+	peer-&gt;us_eid = global_eid;
+	destroy_permissions(peer-&gt;permit);
+	destroy_permissions(peer-&gt;include);
+	peer-&gt;permit = NULL;
+	peer-&gt;include = NULL;
+	if (peer-&gt;registerid &gt; -1)
+		ast_sched_del(sched, peer-&gt;registerid);
+	peer-&gt;registerid = -1;
+	for (; v; v = v-&gt;next) {
+		if (!strcasecmp(v-&gt;name, &quot;inkey&quot;)) {
+			ast_copy_string(peer-&gt;inkey, v-&gt;value, sizeof(peer-&gt;inkey));
+		} else if (!strcasecmp(v-&gt;name, &quot;outkey&quot;)) {
+			ast_copy_string(peer-&gt;outkey, v-&gt;value, sizeof(peer-&gt;outkey));
+		} else if (!strcasecmp(v-&gt;name, &quot;host&quot;)) {
+			if (!strcasecmp(v-&gt;value, &quot;dynamic&quot;)) {
+				peer-&gt;dynamic = 1;
+			} else {
+				hp = ast_gethostbyname(v-&gt;value, &amp;he);
+				if (hp) {
+					memcpy(&amp;peer-&gt;addr.sin_addr, hp-&gt;h_addr, sizeof(peer-&gt;addr.sin_addr));
+					peer-&gt;dynamic = 0;
 				} else {
-					hp = ast_gethostbyname(v-&gt;value, &amp;he);
-					if (hp) {
-						memcpy(&amp;peer-&gt;addr.sin_addr, hp-&gt;h_addr, sizeof(peer-&gt;addr.sin_addr));
-						peer-&gt;dynamic = 0;
-					} else {
-						ast_log(LOG_WARNING, &quot;Unable to find host '%s' at line %d\n&quot;, v-&gt;value, v-&gt;lineno);
-						peer-&gt;dead = 1;
-					}
+					ast_log(LOG_WARNING, &quot;Unable to find host '%s' at line %d\n&quot;, v-&gt;value, v-&gt;lineno);
+					peer-&gt;dead = 1;
 				}
-			} else if (!strcasecmp(v-&gt;name, &quot;ustothem&quot;)) {
-				if (!dundi_str_to_eid(&amp;testeid, v-&gt;value))
-					peer-&gt;us_eid = testeid;
-				else
-					ast_log(LOG_WARNING, &quot;'%s' is not a valid DUNDi Entity Identifier at line %d\n&quot;, v-&gt;value, v-&gt;lineno);
-			} else if (!strcasecmp(v-&gt;name, &quot;include&quot;)) {
-				peer-&gt;include = append_permission(peer-&gt;include, v-&gt;value, 1);
-			} else if (!strcasecmp(v-&gt;name, &quot;permit&quot;)) {
-				peer-&gt;permit = append_permission(peer-&gt;permit, v-&gt;value, 1);
-			} else if (!strcasecmp(v-&gt;name, &quot;noinclude&quot;)) {
-				peer-&gt;include = append_permission(peer-&gt;include, v-&gt;value, 0);
-			} else if (!strcasecmp(v-&gt;name, &quot;deny&quot;)) {
-				peer-&gt;permit = append_permission(peer-&gt;permit, v-&gt;value, 0);
-			} else if (!strcasecmp(v-&gt;name, &quot;register&quot;)) {
-				needregister = ast_true(v-&gt;value);
-			} else if (!strcasecmp(v-&gt;name, &quot;order&quot;)) {
-				if (!strcasecmp(v-&gt;value, &quot;primary&quot;))
-					peer-&gt;order = 0;
-				else if (!strcasecmp(v-&gt;value, &quot;secondary&quot;))
-					peer-&gt;order = 1;
-				else if (!strcasecmp(v-&gt;value, &quot;tertiary&quot;))
-					peer-&gt;order = 2;
-				else if (!strcasecmp(v-&gt;value, &quot;quartiary&quot;))
-					peer-&gt;order = 3;
-				else {
-					ast_log(LOG_WARNING, &quot;'%s' is not a valid order, should be primary, secondary, tertiary or quartiary at line %d\n&quot;, v-&gt;value, v-&gt;lineno);
-				}
-			} else if (!strcasecmp(v-&gt;name, &quot;qualify&quot;)) {
-				if (!strcasecmp(v-&gt;value, &quot;no&quot;)) {
-					peer-&gt;maxms = 0;
-				} else if (!strcasecmp(v-&gt;value, &quot;yes&quot;)) {
-					peer-&gt;maxms = DEFAULT_MAXMS;
-				} else if (sscanf(v-&gt;value, &quot;%d&quot;, &amp;peer-&gt;maxms) != 1) {
-					ast_log(LOG_WARNING, &quot;Qualification of peer '%s' should be 'yes', 'no', or a number of milliseconds at line %d of dundi.conf\n&quot;, 
-						dundi_eid_to_str(eid_str, sizeof(eid_str), &amp;peer-&gt;eid), v-&gt;lineno);
-					peer-&gt;maxms = 0;
-				}
-			} else if (!strcasecmp(v-&gt;name, &quot;model&quot;)) {
-				if (!strcasecmp(v-&gt;value, &quot;inbound&quot;))
-					peer-&gt;model = DUNDI_MODEL_INBOUND;
-				else if (!strcasecmp(v-&gt;value, &quot;outbound&quot;)) 
-					peer-&gt;model = DUNDI_MODEL_OUTBOUND;
-				else if (!strcasecmp(v-&gt;value, &quot;symmetric&quot;))
-					peer-&gt;model = DUNDI_MODEL_SYMMETRIC;
-				else if (!strcasecmp(v-&gt;value, &quot;none&quot;))
-					peer-&gt;model = 0;
-				else {
-					ast_log(LOG_WARNING, &quot;Unknown model '%s', should be 'none', 'outbound', 'inbound', or 'symmetric' at line %d\n&quot;, 
-						v-&gt;value, v-&gt;lineno);
-				}
-			} else if (!strcasecmp(v-&gt;name, &quot;precache&quot;)) {
-				if (!strcasecmp(v-&gt;value, &quot;inbound&quot;))
-					peer-&gt;pcmodel = DUNDI_MODEL_INBOUND;
-				else if (!strcasecmp(v-&gt;value, &quot;outbound&quot;)) 
-					peer-&gt;pcmodel = DUNDI_MODEL_OUTBOUND;
-				else if (!strcasecmp(v-&gt;value, &quot;symmetric&quot;))
-					peer-&gt;pcmodel = DUNDI_MODEL_SYMMETRIC;
-				else if (!strcasecmp(v-&gt;value, &quot;none&quot;))
-					peer-&gt;pcmodel = 0;
-				else {
-					ast_log(LOG_WARNING, &quot;Unknown pcmodel '%s', should be 'none', 'outbound', 'inbound', or 'symmetric' at line %d\n&quot;, 
-						v-&gt;value, v-&gt;lineno);
-				}
 			}
-			v = v-&gt;next;
-		}
-		(*globalpcmode) |= peer-&gt;pcmodel;
-		if (!peer-&gt;model &amp;&amp; !peer-&gt;pcmodel) {
-			ast_log(LOG_WARNING, &quot;Peer '%s' lacks a model or pcmodel, discarding!\n&quot;, 
-				dundi_eid_to_str(eid_str, sizeof(eid_str), &amp;peer-&gt;eid));
-			peer-&gt;dead = 1;
-		} else if ((peer-&gt;model &amp; DUNDI_MODEL_INBOUND) &amp;&amp; (peer-&gt;pcmodel &amp; DUNDI_MODEL_OUTBOUND)) {
-			ast_log(LOG_WARNING, &quot;Peer '%s' may not be both inbound/symmetric model and outbound/symmetric precache model, discarding!\n&quot;, 
-				dundi_eid_to_str(eid_str, sizeof(eid_str), &amp;peer-&gt;eid));
-			peer-&gt;dead = 1;
-		} else if ((peer-&gt;model &amp; DUNDI_MODEL_OUTBOUND) &amp;&amp; (peer-&gt;pcmodel &amp; DUNDI_MODEL_INBOUND)) {
-			ast_log(LOG_WARNING, &quot;Peer '%s' may not be both outbound/symmetric model and inbound/symmetric precache model, discarding!\n&quot;, 
-				dundi_eid_to_str(eid_str, sizeof(eid_str), &amp;peer-&gt;eid));
-			peer-&gt;dead = 1;
-		} else if (peer-&gt;include &amp;&amp; !(peer-&gt;model &amp; DUNDI_MODEL_OUTBOUND) &amp;&amp; !(peer-&gt;pcmodel &amp; DUNDI_MODEL_INBOUND)) {
-			ast_log(LOG_WARNING, &quot;Peer '%s' is supposed to be included in outbound searches but isn't an outbound peer or inbound precache!\n&quot;, 
-				dundi_eid_to_str(eid_str, sizeof(eid_str), &amp;peer-&gt;eid));
-		} else if (peer-&gt;permit &amp;&amp; !(peer-&gt;model &amp; DUNDI_MODEL_INBOUND) &amp;&amp; !(peer-&gt;pcmodel &amp; DUNDI_MODEL_OUTBOUND)) {
-			ast_log(LOG_WARNING, &quot;Peer '%s' is supposed to have permission for some inbound searches but isn't an inbound peer or outbound precache!\n&quot;, 
-				dundi_eid_to_str(eid_str, sizeof(eid_str), &amp;peer-&gt;eid));
-		} else { 
-			if (needregister) {
-				peer-&gt;registerid = ast_sched_add(sched, 2000, do_register, peer);
+		} else if (!strcasecmp(v-&gt;name, &quot;ustothem&quot;)) {
+			if (!dundi_str_to_eid(&amp;testeid, v-&gt;value))
+				peer-&gt;us_eid = testeid;
+			else
+				ast_log(LOG_WARNING, &quot;'%s' is not a valid DUNDi Entity Identifier at line %d\n&quot;, v-&gt;value, v-&gt;lineno);
+		} else if (!strcasecmp(v-&gt;name, &quot;include&quot;)) {
+			peer-&gt;include = append_permission(peer-&gt;include, v-&gt;value, 1);
+		} else if (!strcasecmp(v-&gt;name, &quot;permit&quot;)) {
+			peer-&gt;permit = append_permission(peer-&gt;permit, v-&gt;value, 1);
+		} else if (!strcasecmp(v-&gt;name, &quot;noinclude&quot;)) {
+			peer-&gt;include = append_permission(peer-&gt;include, v-&gt;value, 0);
+		} else if (!strcasecmp(v-&gt;name, &quot;deny&quot;)) {
+			peer-&gt;permit = append_permission(peer-&gt;permit, v-&gt;value, 0);
+		} else if (!strcasecmp(v-&gt;name, &quot;register&quot;)) {
+			needregister = ast_true(v-&gt;value);
+		} else if (!strcasecmp(v-&gt;name, &quot;order&quot;)) {
+			if (!strcasecmp(v-&gt;value, &quot;primary&quot;))
+				peer-&gt;order = 0;
+			else if (!strcasecmp(v-&gt;value, &quot;secondary&quot;))
+				peer-&gt;order = 1;
+			else if (!strcasecmp(v-&gt;value, &quot;tertiary&quot;))
+				peer-&gt;order = 2;
+			else if (!strcasecmp(v-&gt;value, &quot;quartiary&quot;))
+				peer-&gt;order = 3;
+			else {
+				ast_log(LOG_WARNING, &quot;'%s' is not a valid order, should be primary, secondary, tertiary or quartiary at line %d\n&quot;, v-&gt;value, v-&gt;lineno);
 			}
-			qualify_peer(peer, 1);
+		} else if (!strcasecmp(v-&gt;name, &quot;qualify&quot;)) {
+			if (!strcasecmp(v-&gt;value, &quot;no&quot;)) {
+				peer-&gt;maxms = 0;
+			} else if (!strcasecmp(v-&gt;value, &quot;yes&quot;)) {
+				peer-&gt;maxms = DEFAULT_MAXMS;
+			} else if (sscanf(v-&gt;value, &quot;%d&quot;, &amp;peer-&gt;maxms) != 1) {
+				ast_log(LOG_WARNING, &quot;Qualification of peer '%s' should be 'yes', 'no', or a number of milliseconds at line %d of dundi.conf\n&quot;, 
+					dundi_eid_to_str(eid_str, sizeof(eid_str), &amp;peer-&gt;eid), v-&gt;lineno);
+				peer-&gt;maxms = 0;
+			}
+		} else if (!strcasecmp(v-&gt;name, &quot;model&quot;)) {
+			if (!strcasecmp(v-&gt;value, &quot;inbound&quot;))
+				peer-&gt;model = DUNDI_MODEL_INBOUND;
+			else if (!strcasecmp(v-&gt;value, &quot;outbound&quot;)) 
+				peer-&gt;model = DUNDI_MODEL_OUTBOUND;
+			else if (!strcasecmp(v-&gt;value, &quot;symmetric&quot;))
+				peer-&gt;model = DUNDI_MODEL_SYMMETRIC;
+			else if (!strcasecmp(v-&gt;value, &quot;none&quot;))
+				peer-&gt;model = 0;
+			else {
+				ast_log(LOG_WARNING, &quot;Unknown model '%s', should be 'none', 'outbound', 'inbound', or 'symmetric' at line %d\n&quot;, 
+					v-&gt;value, v-&gt;lineno);
+			}
+		} else if (!strcasecmp(v-&gt;name, &quot;precache&quot;)) {
+			if (!strcasecmp(v-&gt;value, &quot;inbound&quot;))
+				peer-&gt;pcmodel = DUNDI_MODEL_INBOUND;
+			else if (!strcasecmp(v-&gt;value, &quot;outbound&quot;)) 
+				peer-&gt;pcmodel = DUNDI_MODEL_OUTBOUND;
+			else if (!strcasecmp(v-&gt;value, &quot;symmetric&quot;))
+				peer-&gt;pcmodel = DUNDI_MODEL_SYMMETRIC;
+			else if (!strcasecmp(v-&gt;value, &quot;none&quot;))
+				peer-&gt;pcmodel = 0;
+			else {
+				ast_log(LOG_WARNING, &quot;Unknown pcmodel '%s', should be 'none', 'outbound', 'inbound', or 'symmetric' at line %d\n&quot;, 
+					v-&gt;value, v-&gt;lineno);
+			}
 		}
 	}
-	ast_mutex_unlock(&amp;peerlock);
+	(*globalpcmode) |= peer-&gt;pcmodel;
+	if (!peer-&gt;model &amp;&amp; !peer-&gt;pcmodel) {
+		ast_log(LOG_WARNING, &quot;Peer '%s' lacks a model or pcmodel, discarding!\n&quot;, 
+			dundi_eid_to_str(eid_str, sizeof(eid_str), &amp;peer-&gt;eid));
+		peer-&gt;dead = 1;
+	} else if ((peer-&gt;model &amp; DUNDI_MODEL_INBOUND) &amp;&amp; (peer-&gt;pcmodel &amp; DUNDI_MODEL_OUTBOUND)) {
+		ast_log(LOG_WARNING, &quot;Peer '%s' may not be both inbound/symmetric model and outbound/symmetric precache model, discarding!\n&quot;, 
+			dundi_eid_to_str(eid_str, sizeof(eid_str), &amp;peer-&gt;eid));
+		peer-&gt;dead = 1;
+	} else if ((peer-&gt;model &amp; DUNDI_MODEL_OUTBOUND) &amp;&amp; (peer-&gt;pcmodel &amp; DUNDI_MODEL_INBOUND)) {
+		ast_log(LOG_WARNING, &quot;Peer '%s' may not be both outbound/symmetric model and inbound/symmetric precache model, discarding!\n&quot;, 
+			dundi_eid_to_str(eid_str, sizeof(eid_str), &amp;peer-&gt;eid));
+		peer-&gt;dead = 1;
+	} else if (peer-&gt;include &amp;&amp; !(peer-&gt;model &amp; DUNDI_MODEL_OUTBOUND) &amp;&amp; !(peer-&gt;pcmodel &amp; DUNDI_MODEL_INBOUND)) {
+		ast_log(LOG_WARNING, &quot;Peer '%s' is supposed to be included in outbound searches but isn't an outbound peer or inbound precache!\n&quot;, 
+			dundi_eid_to_str(eid_str, sizeof(eid_str), &amp;peer-&gt;eid));
+	} else if (peer-&gt;permit &amp;&amp; !(peer-&gt;model &amp; DUNDI_MODEL_INBOUND) &amp;&amp; !(peer-&gt;pcmodel &amp; DUNDI_MODEL_OUTBOUND)) {
+		ast_log(LOG_WARNING, &quot;Peer '%s' is supposed to have permission for some inbound searches but isn't an inbound peer or outbound precache!\n&quot;, 
+			dundi_eid_to_str(eid_str, sizeof(eid_str), &amp;peer-&gt;eid));
+	} else { 
+		if (needregister) {
+			peer-&gt;registerid = ast_sched_add(sched, 2000, do_register, peer);
+		}
+		qualify_peer(peer, 1);
+	}
+	AST_LIST_UNLOCK(&amp;peers);
 }
 
 static int dundi_helper(struct ast_channel *chan, const char *context, const char *exten, int priority, const char *data, int flag)
@@ -4484,7 +4412,7 @@
 			ast_log(LOG_WARNING, &quot;Unable to look up host '%s'\n&quot;, hn);
 	} else
 		ast_log(LOG_WARNING, &quot;Unable to get host name!\n&quot;);
-	ast_mutex_lock(&amp;peerlock);
+	AST_LIST_LOCK(&amp;peers);
 	reset_global_eid();
 	global_storehistory = 0;
 	ast_copy_string(secretpath, &quot;dundi&quot;, sizeof(secretpath));
@@ -4576,7 +4504,7 @@
 		}
 		v = v-&gt;next;
 	}
-	ast_mutex_unlock(&amp;peerlock);
+	AST_LIST_UNLOCK(&amp;peers);
 	mark_mappings();
 	v = ast_variable_browse(cfg, &quot;mappings&quot;);
 	while(v) {

Modified: trunk/pbx.c
===================================================================
--- trunk/pbx.c	2006-04-29 14:18:03 UTC (rev 12)
+++ trunk/pbx.c	2006-04-30 14:53:08 UTC (rev 13)
@@ -4147,7 +4147,7 @@
 {
 	int res = 0;
 
-	ast_mutex_lock(&amp;chan-&gt;lock);
+	ast_channel_lock(chan);
 
 	if (chan-&gt;pbx) {
 		/* This channel is currently in the PBX */
@@ -4174,9 +4174,9 @@
 			ast_channel_masquerade(tmpchan, chan);
 		
 			/* Grab the locks and get going */
-			ast_mutex_lock(&amp;tmpchan-&gt;lock);
+			ast_channel_lock(tmpchan);
 			ast_do_masquerade(tmpchan);
-			ast_mutex_unlock(&amp;tmpchan-&gt;lock);
+			ast_channel_unlock(tmpchan);
 			/* Start the PBX going on our stolen channel */
 			if (ast_pbx_start(tmpchan)) {
 				ast_log(LOG_WARNING, &quot;Unable to start PBX on %s\n&quot;, tmpchan-&gt;name);
@@ -4185,7 +4185,7 @@
 			}
 		}
 	}
-	ast_mutex_unlock(&amp;chan-&gt;lock);
+	ast_channel_unlock(chan);
 	return res;
 }
 
@@ -4197,7 +4197,7 @@
 	chan = ast_get_channel_by_name_locked(channame);
 	if (chan) {
 		res = ast_async_goto(chan, context, exten, priority);
-		ast_mutex_unlock(&amp;chan-&gt;lock);
+		ast_channel_unlock(chan);
 	}
 	return res;
 }
@@ -4576,7 +4576,7 @@
 		if (channel) {
 			*channel = chan;
 			if (chan)
-				ast_mutex_lock(&amp;chan-&gt;lock);
+				ast_channel_lock(chan);
 		}
 		if (chan) {
 			if (chan-&gt;cdr) { /* check if the channel already has a cdr record, if not give it one */
@@ -4600,7 +4600,7 @@
 
 				if (sync &gt; 1) {
 					if (channel)
-						ast_mutex_unlock(&amp;chan-&gt;lock);
+						ast_channel_unlock(chan);
 					if (ast_pbx_run(chan)) {
 						ast_log(LOG_ERROR, &quot;Unable to run PBX on %s\n&quot;, chan-&gt;name);
 						if (channel)
@@ -4613,7 +4613,7 @@
 						ast_log(LOG_ERROR, &quot;Unable to start PBX on %s\n&quot;, chan-&gt;name);
 						if (channel) {
 							*channel = NULL;
-							ast_mutex_unlock(&amp;chan-&gt;lock);
+							ast_channel_unlock(chan);
 						}
 						ast_hangup(chan);
 						res = -1;
@@ -4632,7 +4632,7 @@
 			
 				if (channel) {
 					*channel = NULL;
-					ast_mutex_unlock(&amp;chan-&gt;lock);
+					ast_channel_unlock(chan);
 				}
 				ast_hangup(chan);
 			}
@@ -4673,7 +4673,7 @@
 		if (channel) {
 			*channel = chan;
 			if (chan)
-				ast_mutex_lock(&amp;chan-&gt;lock);
+				ast_channel_lock(chan);
 		}
 		if (!chan) {
 			free(as);
@@ -4694,7 +4694,7 @@
 			free(as);
 			if (channel) {
 				*channel = NULL;
-				ast_mutex_unlock(&amp;chan-&gt;lock);
+				ast_channel_unlock(chan);
 			}
 			ast_hangup(chan);
 			res = -1;
@@ -4783,18 +4783,18 @@
 					tmp-&gt;chan = chan;
 					if (sync &gt; 1) {
 						if (locked_channel)
-							ast_mutex_unlock(&amp;chan-&gt;lock);
+							ast_channel_unlock(chan);
 						ast_pbx_run_app(tmp);
 					} else {
 						pthread_attr_init(&amp;attr);
 						pthread_attr_setdetachstate(&amp;attr, PTHREAD_CREATE_DETACHED);
 						if (locked_channel) 
-							ast_mutex_lock(&amp;chan-&gt;lock);
+							ast_channel_lock(chan);
 						if (ast_pthread_create(&amp;tmp-&gt;t, &amp;attr, ast_pbx_run_app, tmp)) {
 							ast_log(LOG_WARNING, &quot;Unable to spawn execute thread on %s: %s\n&quot;, chan-&gt;name, strerror(errno));
 							free(tmp);
 							if (locked_channel) 
-								ast_mutex_unlock(&amp;chan-&gt;lock);
+								ast_channel_unlock(chan);
 							ast_hangup(chan);
 							res = -1;
 						} else {
@@ -4851,12 +4851,12 @@
 		pthread_attr_init(&amp;attr);
 		pthread_attr_setdetachstate(&amp;attr, PTHREAD_CREATE_DETACHED);
 		if (locked_channel) 
-			ast_mutex_lock(&amp;chan-&gt;lock);
+			ast_channel_lock(chan);
 		if (ast_pthread_create(&amp;as-&gt;p, &amp;attr, async_wait, as)) {
 			ast_log(LOG_WARNING, &quot;Failed to start async wait\n&quot;);
 			free(as);
 			if (locked_channel) 
-				ast_mutex_unlock(&amp;chan-&gt;lock);
+				ast_channel_unlock(chan);
 			ast_hangup(chan);
 			res = -1;
 			goto outgoing_app_cleanup;
@@ -5505,7 +5505,7 @@
 				sprintf(s, &quot;${%s}&quot;, value);
 				pbx_substitute_variables_helper(chan2, s, tmp, sizeof(tmp) - 1);
 			}
-			ast_mutex_unlock(&amp;chan2-&gt;lock);
+			ast_channel_unlock(chan2);
 		}
 		pbx_builtin_setvar_helper(chan, name, tmp);
 	}

Modified: trunk/res/res_agi.c
===================================================================
--- trunk/res/res_agi.c	2006-04-29 14:18:03 UTC (rev 12)
+++ trunk/res/res_agi.c	2006-04-30 14:53:08 UTC (rev 13)
@@ -1025,7 +1025,7 @@
 			/* we have a matching channel */
 			ast_softhangup(c,AST_SOFTHANGUP_EXPLICIT);
 			fdprintf(agi-&gt;fd, &quot;200 result=1\n&quot;);
-			ast_mutex_unlock(&amp;c-&gt;lock);
+			ast_channel_unlock(c);
 			return RESULT_SUCCESS;
 		}
 		/* if we get this far no channel name matched the argument given */
@@ -1093,7 +1093,7 @@
 		c = ast_get_channel_by_name_locked(argv[2]);
 		if (c) {
 			fdprintf(agi-&gt;fd, &quot;200 result=%d\n&quot;, c-&gt;_state);
-			ast_mutex_unlock(&amp;c-&gt;lock);
+			ast_channel_unlock(c);
 			return RESULT_SUCCESS;
 		}
 		/* if we get this far no channel name matched the argument given */
@@ -1155,7 +1155,7 @@
 		fdprintf(agi-&gt;fd, &quot;200 result=0\n&quot;);
 	}
 	if (chan2 &amp;&amp; (chan2 != chan))
-		ast_mutex_unlock(&amp;chan2-&gt;lock);
+		ast_channel_unlock(chan2);
 	return RESULT_SUCCESS;
 }
 

Modified: trunk/res/res_features.c
===================================================================
--- trunk/res/res_features.c	2006-04-29 14:18:03 UTC (rev 12)
+++ trunk/res/res_features.c	2006-04-30 14:53:08 UTC (rev 13)
@@ -1859,7 +1859,7 @@
 	if (!ch2) {
 		snprintf(buf, sizeof(buf), &quot;Channel does not exist: %s&quot;, channel2);
 		astman_send_error(s, m, buf);
-		ast_mutex_unlock(&amp;ch1-&gt;lock);
+		ast_channel_unlock(ch1);
 		return 0;
 	}
 
@@ -1875,8 +1875,8 @@
 		astman_send_error(s, m, &quot;Park failure&quot;);
 	}
 
-	ast_mutex_unlock(&amp;ch1-&gt;lock);
-	ast_mutex_unlock(&amp;ch2-&gt;lock);
+	ast_channel_unlock(ch1);
+	ast_channel_unlock(ch2);
 
 	return 0;
 }
@@ -1895,7 +1895,7 @@
 			 (cur-&gt;_state == AST_STATE_RING))) {
 			 	break;
 		}
-		ast_mutex_unlock(&amp;cur-&gt;lock);
+		ast_channel_unlock(cur);
 	}
 	if (cur) {
 		if (option_debug)
@@ -1909,7 +1909,7 @@
 		res = ast_channel_masquerade(cur, chan);
 		if (res)
 			ast_log(LOG_WARNING, &quot;Unable to masquerade '%s' into '%s'\n&quot;, chan-&gt;name, cur-&gt;name);		/* Done */
-		ast_mutex_unlock(&amp;cur-&gt;lock);
+		ast_channel_unlock(cur);
 	} else	{
 		if (option_debug)
 			ast_log(LOG_DEBUG, &quot;No call pickup possible...\n&quot;);

Modified: trunk/res/res_monitor.c
===================================================================
--- trunk/res/res_monitor.c	2006-04-29 14:18:03 UTC (rev 12)
+++ trunk/res/res_monitor.c	2006-04-30 14:53:08 UTC (rev 13)
@@ -211,7 +211,7 @@
 			ast_log(LOG_WARNING, &quot;Could not create file %s\n&quot;,
 						monitor-&gt;read_filename);
 			free(monitor);
-			ast_mutex_unlock(&amp;chan-&gt;lock);
+			ast_channel_unlock(chan);
 			return -1;
 		}
 		if (ast_fileexists(monitor-&gt;write_filename, NULL, NULL) &gt; 0) {
@@ -224,7 +224,7 @@
 						monitor-&gt;write_filename);
 			ast_closestream(monitor-&gt;read_stream);
 			free(monitor);
-			ast_mutex_unlock(&amp;chan-&gt;lock);
+			ast_channel_unlock(chan);
 			return -1;
 		}
 		chan-&gt;monitor = monitor;
@@ -492,7 +492,7 @@
 		/* No filename base specified, default to channel name as per CLI */		
 		if (!(fname = ast_strdup(c-&gt;name))) {
 			astman_send_error(s, m, &quot;Could not start monitoring channel&quot;);
-			ast_mutex_unlock(&amp;c-&gt;lock);
+			ast_channel_unlock(c);
 			return 0;
 		}
 		/* Channels have the format technology/channel_name - have to replace that /  */
@@ -503,7 +503,7 @@
 	if (ast_monitor_start(c, format, fname, 1)) {
 		if (ast_monitor_change_fname(c, fname, 1)) {
 			astman_send_error(s, m, &quot;Could not start monitoring channel&quot;);
-			ast_mutex_unlock(&amp;c-&gt;lock);
+			ast_channel_unlock(c);
 			return 0;
 		}
 	}
@@ -512,7 +512,7 @@
 		ast_monitor_setjoinfiles(c, 1);
 	}
 
-	ast_mutex_unlock(&amp;c-&gt;lock);
+	ast_channel_unlock(c);
 	astman_send_ack(s, m, &quot;Started monitoring channel&quot;);
 	return 0;
 }
@@ -537,7 +537,7 @@
 		return 0;
 	}
 	res = ast_monitor_stop(c, 1);
-	ast_mutex_unlock(&amp;c-&gt;lock);
+	ast_channel_unlock(c);
 	if (res) {
 		astman_send_error(s, m, &quot;Could not stop monitoring channel&quot;);
 		return 0;
@@ -574,10 +574,10 @@
 	}
 	if (ast_monitor_change_fname(c, fname, 1)) {
 		astman_send_error(s, m, &quot;Could not change monitored filename of channel&quot;);
-		ast_mutex_unlock(&amp;c-&gt;lock);
+		ast_channel_unlock(c);
 		return 0;
 	}
-	ast_mutex_unlock(&amp;c-&gt;lock);
+	ast_channel_unlock(c);
 	astman_send_ack(s, m, &quot;Changed monitor filename&quot;);
 	return 0;
 }
@@ -617,7 +617,7 @@
 	else
 		ast_monitor_unpause(c);
 	
-	ast_mutex_unlock(&amp;c-&gt;lock);
+	ast_channel_unlock(c);
 	astman_send_ack(s, m, &quot;Paused monitoring of the channel&quot;);
 	return 0;	
 }

Modified: trunk/res/snmp/agent.c
===================================================================
--- trunk/res/snmp/agent.c	2006-04-29 14:18:03 UTC (rev 12)
+++ trunk/res/snmp/agent.c	2006-04-30 14:53:08 UTC (rev 13)
@@ -216,7 +216,7 @@
     for (chan = ast_channel_walk_locked(NULL);
 		 chan &amp;&amp; i;
 		 chan = ast_channel_walk_locked(chan), i--)
-		ast_mutex_unlock(&amp;chan-&gt;lock);
+		ast_channel_unlock(chan);
     if (chan == NULL)
 		return NULL;
 	*var_len = sizeof(long_ret);
@@ -513,7 +513,7 @@
 		ret = NULL;
 		break;
     }
-    ast_mutex_unlock(&amp;chan-&gt;lock);
+    ast_channel_unlock(chan);
     return ret;
 }
 
@@ -583,7 +583,7 @@
 	case ASTCHANTYPECHANNELS:
 		long_ret = 0;
 		for (chan = ast_channel_walk_locked(NULL); chan; chan = ast_channel_walk_locked(chan)) {
-			ast_mutex_unlock(&amp;chan-&gt;lock);
+			ast_channel_unlock(chan);
 			if (chan-&gt;tech == tech)
 				long_ret++;
 		}

Modified: trunk/udptl.c
===================================================================
--- trunk/udptl.c	2006-04-29 14:18:03 UTC (rev 12)
+++ trunk/udptl.c	2006-04-30 14:53:08 UTC (rev 13)
@@ -996,24 +996,24 @@
 	void *pvt1;
 	int to;
 	
-	ast_mutex_lock(&amp;c0-&gt;lock);
-	while (ast_mutex_trylock(&amp;c1-&gt;lock)) {
-		ast_mutex_unlock(&amp;c0-&gt;lock);
+	ast_channel_lock(c0);
+	while (ast_channel_trylock(c1)) {
+		ast_channel_unlock(c0);
 		usleep(1);
-		ast_mutex_lock(&amp;c0-&gt;lock);
+		ast_channel_lock(c0);
 	}
 	pr0 = get_proto(c0);
 	pr1 = get_proto(c1);
 	if (!pr0) {
 		ast_log(LOG_WARNING, &quot;Can't find native functions for channel '%s'\n&quot;, c0-&gt;name);
-		ast_mutex_unlock(&amp;c0-&gt;lock);
-		ast_mutex_unlock(&amp;c1-&gt;lock);
+		ast_channel_unlock(c0);
+		ast_channel_unlock(c1);
 		return -1;
 	}
 	if (!pr1) {
 		ast_log(LOG_WARNING, &quot;Can't find native functions for channel '%s'\n&quot;, c1-&gt;name);
-		ast_mutex_unlock(&amp;c0-&gt;lock);
-		ast_mutex_unlock(&amp;c1-&gt;lock);
+		ast_channel_unlock(c0);
+		ast_channel_unlock(c1);
 		return -1;
 	}
 	pvt0 = c0-&gt;tech_pvt;
@@ -1022,8 +1022,8 @@
 	p1 = pr1-&gt;get_udptl_info(c1);
 	if (!p0 || !p1) {
 		/* Somebody doesn't want to play... */
-		ast_mutex_unlock(&amp;c0-&gt;lock);
-		ast_mutex_unlock(&amp;c1-&gt;lock);
+		ast_channel_unlock(c0);
+		ast_channel_unlock(c1);
 		return -2;
 	}
 	if (pr0-&gt;set_udptl_peer(c0, p1)) {
@@ -1038,8 +1038,8 @@
 		/* Store UDPTL peer */
 		ast_udptl_get_peer(p0, &amp;ac0);
 	}
-	ast_mutex_unlock(&amp;c0-&gt;lock);
-	ast_mutex_unlock(&amp;c1-&gt;lock);
+	ast_channel_unlock(c0);
+	ast_channel_unlock(c1);
 	cs[0] = c0;
 	cs[1] = c1;
 	cs[2] = NULL;

Modified: trunk/utils/Makefile
===================================================================
--- trunk/utils/Makefile	2006-04-29 14:18:03 UTC (rev 12)
+++ trunk/utils/Makefile	2006-04-30 14:53:08 UTC (rev 13)
@@ -57,16 +57,18 @@
 stereorize: stereorize.o frame.o
 	$(CC) $(CFLAGS) -o stereorize stereorize.o frame.o -lm
 
+.PHONY: ../ast_expr2.c ../ast_expr2f.c ../pbx/ael/aelflex.o ../pbx/ael/aelbison.o ../pbx/pbx_ael.o
+
 ast_expr2.o: ../ast_expr2.c
-	gcc -g -c -o $@ $&lt;
+	gcc  $(CFLAGS) -include ../include/autoconfig.h -c -o $@ $&lt;
 
 ast_expr2f.o: ../ast_expr2f.c
-	gcc -g -c -DSTANDALONE -o $@ $&lt;
+	gcc  $(CFLAGS) -include ../include/autoconfig.h -c -DSTANDALONE -o $@ $&lt;
 
 check_expr: check_expr.c ast_expr2.o ast_expr2f.o
 	$(CC) $(CFLAGS) -o $@ $^
 
-aelparse : ../pbx/ael/aelflex.o ../pbx/ael/aelbison.o ../pbx/pbx_ael.o ael_main.o ../ast_expr2f.o ../ast_expr2.o
+aelparse : ../pbx/ael/aelflex.o ../pbx/ael/aelbison.o ../pbx/pbx_ael.o ael_main.o ast_expr2f.o ast_expr2.o
 	$(CC) $(CFLAGS) -g -o aelparse ../pbx/ael/aelflex.o ../pbx/ael/aelbison.o ael_main.o ../pbx/pbx_ael.o ../ast_expr2f.o ../ast_expr2.o
 
 ael_main.o : ael_main.c ../include/asterisk/ael_structs.h


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000009.html">[solid-pbx-svn] r12 - in trunk: . res
</A></li>
	<LI>Next message: <A HREF="000010.html">[solid-pbx-svn] r14 - trunk/mxml
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11">[ date ]</a>
              <a href="thread.html#11">[ thread ]</a>
              <a href="subject.html#11">[ subject ]</a>
              <a href="author.html#11">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/solid-pbx-svn">More information about the solid-pbx-svn
mailing list</a><br>
</body></html>
